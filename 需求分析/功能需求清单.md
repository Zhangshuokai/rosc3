# 功能需求清单表

## 文档说明

本文档列出基于Micro-ROS的ESP32-C3嵌入式应用系统的所有功能需求，包括需求编号、优先级、验收标准和测试方法。

**优先级定义**：
- **P0**：核心功能，必须实现
- **P1**：重要功能，强烈建议实现
- **P2**：增强功能，可选实现
- **P3**：未来扩展，暂不实现

**需求状态**：
- ✅ 已规划
- 🚧 开发中
- ✔️ 已完成
- ❌ 已取消

---

## 1. 传感器数据采集功能

### 1.1 传感器支持

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-SENSOR-001 | 支持温湿度传感器（DHT22/SHT3x/BME280） | P0 | 成功读取温度（±0.1°C）和湿度（±2%RH）数据 | 对比专业温湿度计 | ✅ |
| REQ-SENSOR-002 | 支持IMU惯性测量单元（MPU6050/ICM20948） | P1 | 成功读取3轴加速度和3轴陀螺仪数据 | 与标准IMU对比 | ✅ |
| REQ-SENSOR-003 | 支持环境光传感器（BH1750/VEML7700） | P2 | 读取光照强度（0-65535 lx） | 光度计校准 | ✅ |
| REQ-SENSOR-004 | 支持气压传感器（BMP280/MS5611） | P2 | 读取大气压（300-1100 hPa）和温度 | 气压计对比 | ✅ |
| REQ-SENSOR-005 | 支持距离传感器（VL53L0X/HC-SR04） | P2 | 测距范围0-2000mm，精度±1mm | 标准距离测试 | ✅ |
| REQ-SENSOR-006 | 支持ADC模拟传感器（电压/电流） | P1 | ADC分辨率12位，采样率≥1kHz | 信号发生器测试 | ✅ |
| REQ-SENSOR-007 | 支持传感器热插拔检测 | P1 | 检测传感器连接/断开事件 | 插拔传感器测试 | ✅ |
| REQ-SENSOR-008 | 支持多传感器同时运行（≥3个） | P1 | 同时采集3个以上传感器数据 | 多传感器并发测试 | ✅ |

### 1.2 采样频率控制

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-SAMPLE-001 | 支持可配置采样频率（0.1Hz-1000Hz） | P0 | 通过Menuconfig设置，精度±5% | 频率计测量 | ✅ |
| REQ-SAMPLE-002 | 支持运行时动态调整采样频率 | P1 | 通过ROS服务调整，响应时间<1秒 | ROS服务调用测试 | ✅ |
| REQ-SAMPLE-003 | 不同传感器支持独立采样频率 | P1 | 每个传感器独立设置频率 | 多传感器同时测试 | ✅ |
| REQ-SAMPLE-004 | 支持事件触发采样 | P2 | 传感器值超过阈值时触发采样 | 阈值测试 | ✅ |
| REQ-SAMPLE-005 | 支持按需采样（ROS服务请求） | P2 | 接收服务请求后立即采样 | 服务调用验证 | ✅ |

### 1.3 数据精度与校准

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-CALIB-001 | 温度数据精度±0.1°C | P0 | 与标准温度计对比误差<0.1°C | 恒温箱测试 | ✅ |
| REQ-CALIB-002 | 湿度数据精度±2% RH | P0 | 与标准湿度计对比误差<2% | 恒湿箱测试 | ✅ |
| REQ-CALIB-003 | IMU加速度精度±0.01 m/s² | P1 | 静态精度测试 | 振动台测试 | ✅ |
| REQ-CALIB-004 | IMU角速度精度±0.1 °/s | P1 | 静态漂移<0.1°/s | 转台测试 | ✅ |
| REQ-CALIB-005 | 支持传感器零点校准 | P1 | 通过ROS服务执行校准 | 校准流程测试 | ✅ |
| REQ-CALIB-006 | 支持传感器比例因子校准 | P2 | 支持多点校准算法 | 标准信号源测试 | ✅ |
| REQ-CALIB-007 | 校准参数持久化存储 | P1 | 断电后校准参数不丢失 | 断电重启测试 | ✅ |

### 1.4 异常处理

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-ERR-001 | 检测传感器通信失败 | P0 | I2C超时>100ms触发错误 | 断开I2C连接测试 | ✅ |
| REQ-ERR-002 | 检测数据超出有效范围 | P0 | 自动丢弃异常数据并记录 | 输入超限信号 | ✅ |
| REQ-ERR-003 | 检测数据突变 | P1 | 相邻采样差值>阈值时预警 | 阶跃信号测试 | ✅ |
| REQ-ERR-004 | CRC校验错误检测 | P1 | 检测并丢弃校验失败的数据 | 模拟通信错误 | ✅ |
| REQ-ERR-005 | 传感器自动重试机制 | P1 | 失败后自动重试3次 | 间歇性故障模拟 | ✅ |
| REQ-ERR-006 | 传感器离线检测与标记 | P1 | 连续失败后标记为离线状态 | 长时间断开测试 | ✅ |
| REQ-ERR-007 | 发布传感器诊断信息 | P1 | 通过diagnostic_msgs话题发布 | ROS话题订阅验证 | ✅ |

---

## 2. ROS通信功能

### 2.1 话题发布

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-PUB-001 | 发布IMU数据话题 | P0 | sensor_msgs/Imu格式，频率50Hz | ROS话题监听 | ✅ |
| REQ-PUB-002 | 发布温度数据话题 | P0 | sensor_msgs/Temperature格式 | ROS话题监听 | ✅ |
| REQ-PUB-003 | 发布湿度数据话题 | P0 | sensor_msgs/RelativeHumidity格式 | ROS话题监听 | ✅ |
| REQ-PUB-004 | 发布光照强度话题 | P2 | sensor_msgs/Illuminance格式 | ROS话题监听 | ✅ |
| REQ-PUB-005 | 发布气压数据话题 | P2 | sensor_msgs/FluidPressure格式 | ROS话题监听 | ✅ |
| REQ-PUB-006 | 发布距离数据话题 | P2 | sensor_msgs/Range格式 | ROS话题监听 | ✅ |
| REQ-PUB-007 | 发布系统诊断话题 | P1 | diagnostic_msgs/DiagnosticStatus | ROS话题监听 | ✅ |
| REQ-PUB-008 | 发布电池状态话题 | P2 | sensor_msgs/BatteryState格式 | ROS话题监听 | ✅ |
| REQ-PUB-009 | 话题名称支持命名空间 | P1 | 通过Menuconfig配置命名空间 | 配置测试 | ✅ |
| REQ-PUB-010 | 消息包含时间戳 | P0 | 使用ROS时间或系统时间 | 时间戳验证 | ✅ |
| REQ-PUB-011 | 消息包含序列号 | P0 | 自动递增序列号 | 消息解析验证 | ✅ |

### 2.2 QoS配置

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-QOS-001 | 支持RELIABLE QoS模式 | P0 | 关键数据使用RELIABLE | 丢包测试 | ✅ |
| REQ-QOS-002 | 支持BEST_EFFORT QoS模式 | P0 | 高频数据使用BEST_EFFORT | 性能测试 | ✅ |
| REQ-QOS-003 | 支持配置History深度 | P1 | KEEP_LAST(1-100) | 配置验证 | ✅ |
| REQ-QOS-004 | 不同话题独立QoS配置 | P1 | 每个话题独立设置 | 多话题测试 | ✅ |

### 2.3 服务（Service）

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-SRV-001 | 设置采样频率服务 | P0 | 响应时间<2秒，返回实际频率 | 服务调用测试 | ✅ |
| REQ-SRV-002 | 传感器校准服务 | P1 | 响应时间<10秒，返回校准参数 | 校准流程测试 | ✅ |
| REQ-SRV-003 | 系统重启服务 | P1 | 5秒内完成重启 | 重启测试 | ✅ |
| REQ-SRV-004 | 获取配置服务 | P1 | 返回JSON格式配置 | 配置读取测试 | ✅ |
| REQ-SRV-005 | 更新WiFi配置服务 | P2 | 更新后自动重连 | WiFi配置测试 | ✅ |
| REQ-SRV-006 | 服务调用超时处理 | P0 | 超时后返回错误码 | 超时场景测试 | ✅ |

### 2.4 话题订阅

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-SUB-001 | 订阅LED控制话题 | P2 | 接收ColorRGBA消息控制LED | 发布测试消息 | ✅ |
| REQ-SUB-002 | 订阅睡眠模式话题 | P2 | 接收Bool消息进入/退出睡眠 | 睡眠控制测试 | ✅ |
| REQ-SUB-003 | 订阅紧急停止话题 | P1 | 接收Empty消息立即停止 | 紧急停止测试 | ✅ |
| REQ-SUB-004 | 订阅消息响应延迟<100ms | P1 | 从接收到执行<100ms | 延迟测试 | ✅ |

---

## 3. 网络通信功能

### 3.1 WiFi连接

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-WIFI-001 | 支持WPA2-PSK加密 | P0 | 成功连接WPA2网络 | 实际网络测试 | ✅ |
| REQ-WIFI-002 | 支持WPA3-PSK加密 | P1 | 成功连接WPA3网络 | WPA3路由器测试 | ✅ |
| REQ-WIFI-003 | 支持OPEN模式（仅测试） | P2 | 成功连接开放网络 | 开放网络测试 | ✅ |
| REQ-WIFI-004 | 支持SSID和密码配置 | P0 | 通过Menuconfig配置 | 配置验证 | ✅ |
| REQ-WIFI-005 | WiFi连接超时时间可配置 | P1 | 5-120秒可配置 | 超时测试 | ✅ |
| REQ-WIFI-006 | WiFi连接失败重试机制 | P0 | 最多重试5次 | 错误密码测试 | ✅ |
| REQ-WIFI-007 | 获取IP地址（DHCP） | P0 | 成功获取动态IP | 网络抓包验证 | ✅ |
| REQ-WIFI-008 | 支持静态IP配置 | P2 | 支持手动配置IP | 静态IP测试 | ✅ |
| REQ-WIFI-009 | 显示连接状态（LED指示） | P2 | LED指示连接/断开状态 | 视觉验证 | ✅ |

### 3.2 网络断线重连

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-RECONN-001 | 短暂断网自动重连 | P0 | 1秒内检测断网，立即重连 | 断开路由器电源 | ✅ |
| REQ-RECONN-002 | 长时间断网指数退避重连 | P0 | 1s, 2s, 4s, 8s间隔重连 | 长时间断网测试 | ✅ |
| REQ-RECONN-003 | 路由器重启后自动重连 | P0 | SSID扫描到后立即连接 | 路由器重启测试 | ✅ |
| REQ-RECONN-004 | 重连时数据缓存 | P1 | 最多缓存1000条消息 | 断网期间发送测试 | ✅ |
| REQ-RECONN-005 | 重连成功后发送缓存数据 | P1 | 按时间顺序发送缓存 | 缓存数据验证 | ✅ |

### 3.3 Micro-ROS Agent连接

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-AGENT-001 | 配置Agent IP地址 | P0 | 通过Menuconfig配置 | 配置验证 | ✅ |
| REQ-AGENT-002 | 配置Agent端口号 | P0 | 默认8888，可配置 | 端口测试 | ✅ |
| REQ-AGENT-003 | Agent断开自动重连 | P0 | 心跳超时3秒后重连 | Agent重启测试 | ✅ |
| REQ-AGENT-004 | Agent重连间隔可配置 | P1 | 1-30秒可配置 | 配置测试 | ✅ |
| REQ-AGENT-005 | 时间同步（NTP或ROS时间） | P1 | 时间误差<100ms | 时间对比测试 | ✅ |

---

## 4. 配置管理功能

### 4.1 Menuconfig配置

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-CFG-001 | WiFi SSID配置项 | P0 | 1-32字符，不可为空 | 配置验证 | ✅ |
| REQ-CFG-002 | WiFi密码配置项 | P0 | 8-64字符（WPA2）或空 | 配置验证 | ✅ |
| REQ-CFG-003 | WiFi加密方式选择 | P0 | WPA2/WPA3/OPEN | 配置验证 | ✅ |
| REQ-CFG-004 | Agent IP地址配置 | P0 | IP地址格式校验 | 格式验证 | ✅ |
| REQ-CFG-005 | Agent端口号配置 | P0 | 1024-65535范围 | 范围验证 | ✅ |
| REQ-CFG-006 | ROS节点名称配置 | P0 | 字母/数字/下划线 | 命名验证 | ✅ |
| REQ-CFG-007 | ROS命名空间配置 | P1 | 支持多级命名空间 | 命名空间测试 | ✅ |
| REQ-CFG-008 | ROS Domain ID配置 | P1 | 0-232范围 | 范围验证 | ✅ |
| REQ-CFG-009 | 串口波特率配置 | P1 | 9600/115200/921600 | 串口通信测试 | ✅ |
| REQ-CFG-010 | 传感器采样频率配置 | P0 | 每个传感器独立配置 | 频率测试 | ✅ |

### 4.2 运行时配置

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-RTCFG-001 | 通过ROS服务更新配置 | P1 | 配置立即生效 | 服务调用测试 | ✅ |
| REQ-RTCFG-002 | 配置持久化到NVS | P1 | 断电不丢失 | 断电测试 | ✅ |
| REQ-RTCFG-003 | 配置读取优先级（NVS>sdkconfig） | P1 | NVS配置覆盖编译配置 | 优先级测试 | ✅ |
| REQ-RTCFG-004 | 恢复出厂设置功能 | P2 | 清除NVS，恢复sdkconfig | 恢复测试 | ✅ |
| REQ-RTCFG-005 | 配置导出为JSON | P2 | 导出完整配置JSON | 导出验证 | ✅ |
| REQ-RTCFG-006 | 配置导入JSON | P2 | 从JSON恢复配置 | 导入测试 | ✅ |

### 4.3 配置验证

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-VALID-001 | 编译时配置检查 | P0 | 无效配置导致编译失败 | 错误配置测试 | ✅ |
| REQ-VALID-002 | 运行时配置验证 | P0 | 无效配置拒绝并记录 | 无效值测试 | ✅ |
| REQ-VALID-003 | IP地址格式校验 | P0 | 正则表达式验证 | 格式测试 | ✅ |
| REQ-VALID-004 | 端口范围校验 | P0 | 1024-65535 | 范围测试 | ✅ |
| REQ-VALID-005 | 密码强度检查 | P1 | 至少8字符，字母+数字 | 强度测试 | ✅ |

---

## 5. 系统管理功能

### 5.1 日志记录

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-LOG-001 | 支持多级日志（ERROR/WARN/INFO/DEBUG） | P0 | 通过Menuconfig配置日志级别 | 日志输出验证 | ✅ |
| REQ-LOG-002 | 日志输出到串口 | P0 | 115200波特率输出 | 串口监听 | ✅ |
| REQ-LOG-003 | 日志输出到ROS话题 | P2 | 通过rosout话题发布 | ROS话题订阅 | ✅ |
| REQ-LOG-004 | 日志包含时间戳 | P1 | 毫秒级时间戳 | 日志格式验证 | ✅ |
| REQ-LOG-005 | 日志包含模块名称 | P1 | 显示日志来源模块 | 日志格式验证 | ✅ |
| REQ-LOG-006 | 关键错误日志持久化 | P2 | 保存到Flash | Flash读取验证 | ✅ |

### 5.2 系统监控

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-MON-001 | 监控CPU使用率 | P1 | 通过诊断话题发布 | 负载测试 | ✅ |
| REQ-MON-002 | 监控内存使用量 | P1 | 通过诊断话题发布 | 内存监控 | ✅ |
| REQ-MON-003 | 监控WiFi信号强度 | P2 | RSSI值发布 | 信号测试 | ✅ |
| REQ-MON-004 | 监控任务运行状态 | P2 | FreeRTOS任务状态 | 任务监控 | ✅ |
| REQ-MON-005 | 监控温度（芯片温度） | P2 | 内部温度传感器 | 温度读取 | ✅ |

### 5.3 错误处理

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-ERH-001 | 任务看门狗（TWDT） | P0 | 5秒未喂狗自动重启 | 死锁测试 | ✅ |
| REQ-ERH-002 | 系统异常自动重启 | P0 | Panic后重启 | 异常触发测试 | ✅ |
| REQ-ERH-003 | 重启前保存错误日志 | P1 | 错误信息写入Flash | 崩溃日志验证 | ✅ |
| REQ-ERH-004 | 启动时检测上次崩溃 | P1 | 读取崩溃日志并上报 | 崩溃恢复测试 | ✅ |
| REQ-ERH-005 | 内存泄漏检测 | P2 | 运行时检测泄漏 | 长时间运行测试 | ✅ |

---

## 6. 安全性功能

### 6.1 数据加密

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-SEC-001 | WiFi密码加密存储 | P0 | AES-128加密 | 读取NVS验证 | ✅ |
| REQ-SEC-002 | Flash加密支持 | P1 | 启用Flash Encryption | Flash读取测试 | ✅ |
| REQ-SEC-003 | 安全启动（Secure Boot） | P2 | 签名验证 | 篡改固件测试 | ✅ |

### 6.2 访问控制

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-ACC-001 | 禁止串口直接读取密码 | P0 | 密码显示为*** | 串口命令测试 | ✅ |
| REQ-ACC-002 | ROS服务访问控制 | P2 | 敏感服务需认证 | 未授权调用测试 | ✅ |

---

## 7. 性能需求

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-PERF-001 | 传感器采样延迟<10ms | P0 | 示波器测量<10ms | 延迟测试 | ✅ |
| REQ-PERF-002 | ROS消息发布延迟<50ms | P0 | 时间戳对比<50ms | 延迟测试 | ✅ |
| REQ-PERF-003 | 服务响应时间<500ms | P0 | ROS服务计时<500ms | 响应测试 | ✅ |
| REQ-PERF-004 | 系统启动时间<5秒 | P1 | 串口日志统计<5秒 | 启动测试 | ✅ |
| REQ-PERF-005 | WiFi重连时间<10秒 | P1 | 自动化测试<10秒 | 重连测试 | ✅ |
| REQ-PERF-006 | CPU占用率<70% | P1 | 平均负载<70% | 负载监控 | ✅ |
| REQ-PERF-007 | RAM使用<200KB | P1 | 峰值<200KB | 内存监控 | ✅ |
| REQ-PERF-008 | Flash占用<1.5MB | P1 | 固件大小<1.5MB | 编译检查 | ✅ |

---

## 8. 可靠性需求

| 需求ID | 需求描述 | 优先级 | 验收标准 | 测试方法 | 状态 |
|--------|---------|--------|---------|---------|------|
| REQ-REL-001 | 连续运行≥168小时（7天） | P0 | 无崩溃、无内存泄漏 | 老化测试 | ✅ |
| REQ-REL-002 | WiFi自动重连成功率>95% | P0 | 100次测试>95次成功 | 重连测试 | ✅ |
| REQ-REL-003 | ROS Agent重连成功率>95% | P0 | 100次测试>95次成功 | 重连测试 | ✅ |
| REQ-REL-004 | 数据完整性校验 | P1 | CRC/校验和验证 | 数据验证测试 | ✅ |
| REQ-REL-005 | 系统可用性≥99.5% | P1 | 月度统计 | 长期监控 | ✅ |

---

## 需求统计

| 优先级 | 需求总数 | 已规划 | 开发中 | 已完成 | 已取消 |
|--------|---------|--------|--------|--------|--------|
| **P0** | 58 | 58 | 0 | 0 | 0 |
| **P1** | 52 | 52 | 0 | 0 | 0 |
| **P2** | 32 | 32 | 0 | 0 | 0 |
| **P3** | 0 | 0 | 0 | 0 | 0 |
| **合计** | **142** | **142** | **0** | **0** | **0** |

---

## 需求变更记录

| 变更日期 | 需求ID | 变更类型 | 变更描述 | 变更人 |
|---------|--------|---------|---------|--------|
| 2025-10-23 | - | 新增 | 初始版本，定义全部142项功能需求 | - |

---

**文档结束**