# 建筑喷涂施工机器人分布式控制系统需求规格说明书

## 文档信息

| 项目 | 内容 |
|------|------|
| **项目名称** | 建筑喷涂施工机器人分布式控制系统 |
| **文档版本** | v2.0.0 |
| **编制日期** | 2025-10-23 |
| **文档状态** | 初稿 |
| **硬件平台** | Adafruit QT Py ESP32-C3（多节点分布式架构） |
| **开发环境** | VS Code + PlatformIO + ESP-IDF |
| **应用领域** | 建筑施工自动化 |

## 修订记录

| 版本 | 日期 | 修订人 | 修订内容 | 审核人 |
|------|------|--------|----------|--------|
| v2.0.0 | 2025-10-23 | - | 重构为施工机器人分布式节点架构 | - |
| v1.0.0 | 2025-10-23 | - | 初始版本 | - |

---

## 目录

- [1. 项目概述](#1-项目概述)
  - [1.1 项目背景](#11-项目背景)
  - [1.2 机器人系统组成](#12-机器人系统组成)
  - [1.3 分布式节点架构](#13-分布式节点架构)
  - [1.4 核心价值](#14-核心价值)
  - [1.5 核心干系人](#15-核心干系人)
- [2. 硬件节点定义](#2-硬件节点定义)
  - [2.1 底盘控制节点](#21-底盘控制节点)
  - [2.2 升降机构节点](#22-升降机构节点)
  - [2.3 环境监测节点](#23-环境监测节点)
  - [2.4 喷涂监控节点](#24-喷涂监控节点)
  - [2.5 距离测量节点](#25-距离测量节点)
  - [2.6 IMU姿态节点](#26-imu姿态节点)
  - [2.7 电源管理节点](#27-电源管理节点)
- [3. 通用功能需求](#3-通用功能需求)
  - [3.1 ROS通信接口](#31-ros通信接口)
  - [3.2 配置管理](#32-配置管理)
  - [3.3 异常处理](#33-异常处理)
- [4. 非功能需求](#4-非功能需求)
  - [4.1 性能需求](#41-性能需求)
  - [4.2 可靠性需求](#42-可靠性需求)
  - [4.3 兼容性需求](#43-兼容性需求)
  - [4.4 安全性需求](#44-安全性需求)
- [5. 开发与交付约束](#5-开发与交付约束)
  - [5.1 开发环境要求](#51-开发环境要求)
  - [5.2 技术栈要求](#52-技术栈要求)
  - [5.3 交付物清单](#53-交付物清单)

---

## 1. 项目概述

### 1.1 项目背景

建筑施工行业面临人工成本高、作业效率低、质量不稳定等痛点。特别是石膏腻子、乳胶漆等墙面喷涂作业，传统人工施工存在以下问题：

**行业痛点**：
- 🔴 **人工成本高昂**：熟练工人短缺，人工成本逐年上升
- 🔴 **作业环境恶劣**：粉尘大、气味重、高空作业风险高
- 🔴 **质量不稳定**：依赖工人经验，厚度均匀性难以保证
- 🔴 **效率低下**：需要反复移动脚手架，施工周期长

**技术趋势**：
随着工业4.0和建筑信息化（BIM）的发展，施工机器人成为建筑行业数字化转型的重要方向。基于ROS 2的分布式控制系统为施工机器人提供了标准化、模块化的软件架构支撑。

**本项目定位**：
基于自研差速移动底盘、伺服升降机构、外采法奥意威六轴协作机械臂，结合Micro-ROS技术，构建一套**分布式、模块化、高可靠**的建筑喷涂施工机器人控制系统。

---

### 1.2 机器人系统组成

#### 1.2.1 硬件系统架构

```
施工机器人系统
├── 移动平台（自研）
│   ├── 差速移动底盘
│   │   ├── 双驱动轮电机
│   │   ├── 编码器
│   │   └── 万向轮
│   └── 垂直升降机构
│       ├── 伺服电机
│       ├── 导轨滑块
│       └── 位置传感器
│
├── 作业单元（外采）
│   └── 法奥意威六轴协作机械臂
│       ├── 关节电机×6
│       ├── 末端执行器（喷枪）
│       └── 力矩传感器
│
└── 感知系统（分布式）
    ├── 环境监测传感器
    │   ├── 温湿度传感器
    │   └── 气压传感器
    ├── 作业监控传感器
    │   ├── 喷涂压力传感器
    │   ├── 流量传感器
    │   └── 料位传感器
    ├── 导航传感器
    │   ├── 墙面距离传感器×4
    │   ├── IMU姿态传感器
    │   └── 激光雷达（可选）
    └── 电源管理
        ├── 电池电压监测
        ├── 电流监测
        └── 充电状态检测
```

#### 1.2.2 系统工作流程

```
1. 任务规划（上位机）
   ↓
2. 路径导航（底盘控制）
   ↓
3. 高度调整（升降机构）
   ↓
4. 墙面定位（距离传感器）
   ↓
5. 喷涂作业（机械臂+喷枪）
   ↓
6. 质量监控（喷涂传感器）
   ↓
7. 环境适配（环境传感器）
   ↓
8. 电源管理（电池监测）
```

---

### 1.3 分布式节点架构

#### 1.3.1 设计原则：单一职责

**核心思想**：每个ESP32-C3节点专注于单一类型的传感器或执行器管理，实现：
- ✅ **职责清晰**：一个节点只负责一类设备
- ✅ **故障隔离**：单节点故障不影响其他节点
- ✅ **易于维护**：模块化设计便于替换和升级
- ✅ **负载均衡**：多节点分担计算和通信压力

#### 1.3.2 节点分类

| 节点编号 | 节点名称 | 管理对象 | 优先级 | 数量 |
|---------|---------|---------|--------|------|
| **NODE-01** | 底盘控制节点 | 差速轮电机、编码器 | P0 | 1 |
| **NODE-02** | 升降机构节点 | 伺服电机、位置传感器 | P0 | 1 |
| **NODE-03** | 环境监测节点 | 温湿度、气压传感器 | P1 | 1 |
| **NODE-04** | 喷涂监控节点 | 压力、流量、料位传感器 | P0 | 1 |
| **NODE-05** | 距离测量节点 | 墙面距离传感器×4 | P0 | 1 |
| **NODE-06** | IMU姿态节点 | IMU传感器 | P1 | 1 |
| **NODE-07** | 电源管理节点 | 电池电压/电流监测 | P0 | 1 |

**扩展节点**（可选）：
- **NODE-08**：激光雷达节点（用于SLAM导航）
- **NODE-09**：视觉识别节点（墙面缺陷检测）
- **NODE-10**：安全防护节点（急停、围栏检测）

#### 1.3.3 节点通信拓扑

```
                    ROS 2 Agent
                    (上位机工控机)
                          |
                   WiFi Network
                          |
        ┌─────────────────┼─────────────────┐
        │                 │                 │
    NODE-01           NODE-02           NODE-03
  底盘控制          升降机构          环境监测
        │                 │                 │
    NODE-04           NODE-05           NODE-06
  喷涂监控          距离测量          IMU姿态
        │                 │                 │
    NODE-07           NODE-08           NODE-09
  电源管理          激光雷达          视觉识别
                                         (可选)
```

**通信特点**：
- 所有节点通过WiFi连接到同一ROS 2网络
- 采用发布-订阅模式实现数据共享
- 关键指令使用服务（Service）保证可靠性
- 支持Domain ID隔离多机器人系统

---

### 1.4 核心价值

#### 技术价值
- ✅ **分布式架构**：多节点并行工作，故障隔离，易于扩展
- ✅ **单一职责**：每个节点专注一项任务，降低复杂度
- ✅ **ROS生态集成**：利用ROS 2丰富的工具链和算法库
- ✅ **低成本高可靠**：基于ESP32-C3，成本低廉且性能稳定
- ✅ **标准化接口**：ROS消息格式标准化，便于集成第三方设备

#### 应用价值
- 📊 **提升效率**：自动化喷涂作业，效率提升3-5倍
- 🌐 **降低成本**：减少人工依赖，降低长期运营成本
- 🔧 **质量保证**：精确控制喷涂厚度和均匀性
- 📈 **数据驱动**：实时监控作业数据，优化施工工艺
- 🛡️ **安全环保**：减少人员暴露于有害环境
### 2.0 Adafruit QT Py ESP32-C3硬件接口资源

#### 2.0.1 完整接口清单

**Adafruit QT Py ESP32-C3**是一款超小型ESP32-C3开发板，引脚资源如下：

| GPIO编号 | 功能 | 特性 | 备注 |
|---------|------|------|------|
| **GPIO0** | ADC1_CH0 | 12位ADC | 可用作模拟输入或PWM |
| **GPIO1** | ADC1_CH1 | 12位ADC | 可用作模拟输入或PWM |
| **GPIO2** | ADC1_CH2 | 12位ADC | 可用作模拟输入或PWM |
| **GPIO3** | ADC1_CH3 | 12位ADC | 可用作模拟输入或PWM |
| **GPIO4** | ADC1_CH4 | 12位ADC | 可用作模拟输入或PWM |
| **GPIO5** | ADC2_CH0 / SPI_MISO | 12位ADC / SPI | **已用于OLED_SCL** |
| **GPIO6** | SPI_MOSI | SPI | **已用于OLED_SDA** |
| **GPIO7** | SPI_SS | SPI片选 | 可用作通用GPIO |
| **GPIO8** | I2C_SDA | I2C数据线 | **主I2C总线** |
| **GPIO9** | I2C_SCL | I2C时钟线 | **主I2C总线** |
| **GPIO10** | GPIO | 通用GPIO | 可用作输入/输出 |
| **GPIO20** | UART_RX | UART接收 | USB-CDC调试串口 |
| **GPIO21** | UART_TX | UART发送 | USB-CDC调试串口 |

**电源接口**：
- **GND**：地线
- **5V**：USB 5V输入（Type-C供电）
- **3.3V**：板载稳压器输出（最大600mA）

**板载硬件**：
- **Type-C接口**：USB通信和供电
- **Reset按钮**：复位MCU
- **Boot按钮**：进入固件下载模式（GPIO9）
- **OLED屏幕**：128x64分辨率，I2C接口（占用GPIO5、GPIO6）
- **NeoPixel LED**：可编程RGB LED

#### 2.0.2 接口资源分配约束

**关键约束**：
1. **OLED屏幕占用**：GPIO5、GPIO6已被板载128x64 OLED占用（I2C或SPI模式）
2. **I2C总线**：GPIO8(SDA)、GPIO9(SCL)为主I2C总线，可连接多个I2C设备
3. **ADC通道**：GPIO0-4可用作12位ADC，GPIO5已被OLED占用
4. **有限GPIO**：仅GPIO7、GPIO10可用作通用数字GPIO
5. **UART固定**：GPIO20、GPIO21用于调试串口，不建议占用

**资源分配策略**：
- **优先使用I2C设备**：节省GPIO，多设备共享总线
- **ADC用于模拟传感器**：压力、流量、电压、电流等
- **PWM复用ADC引脚**：GPIO0-4可输出PWM控制电机/伺服
- **OLED共享**：所有节点都可使用板载OLED显示状态信息

#### 2.0.3 典型应用配置示例

**配置方案A：传感器节点（I2C为主）**
```
GPIO8-9  : I2C总线（BME280、AS5600、VL53L0X等）
GPIO0-4  : 预留ADC（未来扩展）
GPIO5-6  : OLED显示
GPIO20-21: 调试串口
```

**配置方案B：执行器节点（PWM+GPIO）**
```
GPIO0-1  : PWM输出（电机驱动）
GPIO8-9  : I2C总线（电机驱动器配置、编码器读取）
GPIO7,10 : 数字输入（限位开关、传感器）
GPIO5-6  : OLED显示
GPIO20-21: 调试串口
```

**配置方案C：混合节点（ADC+I2C）**
```
GPIO0-4  : ADC输入（压力、电压、电流传感器）
GPIO8-9  : I2C总线（辅助传感器）
GPIO10   : 数字输入/输出
GPIO5-6  : OLED显示
GPIO20-21: 调试串口
```

---


#### 商业价值
- 💰 **市场需求**：建筑行业人工短缺，自动化需求旺盛
- 🚀 **技术壁垒**：分布式控制+机器人技术形成竞争优势
- 🔄 **可复制性**：模块化设计便于快速复制部署
- 📈 **可扩展性**：支持喷涂、抹灰、砌墙等多种施工场景

---

### 1.5 核心干系人

| 角色 | 职责 | 权限 |
|------|------|------|
| **项目负责人** | 项目整体规划、进度管控、资源协调 | 项目最终决策权 |
| **硬件工程师** | 节点硬件设计、电路调试、传感器选型 | 硬件方案决策 |
| **嵌入式开发工程师** | ESP32-C3固件开发、Micro-ROS集成、驱动开发 | 代码提交、技术方案 |
| **ROS系统工程师** | ROS 2环境搭建、话题/服务定义、上位机开发 | ROS接口定义、系统架构 |
| **机器人工程师** | 运动控制算法、路径规划、作业流程设计 | 控制策略决策 |
| **测试工程师** | 功能测试、性能测试、现场验证 | 测试用例审核、缺陷提交 |
| **施工工艺专家** | 喷涂工艺指导、质量标准制定 | 工艺参数审核 |
| **最终用户** | 系统部署、使用反馈、需求提出 | 功能需求提出、验收评审 |

---

## 2. 硬件节点定义

### 2.1 底盘控制节点（NODE-01）

#### 2.1.1 节点职责

**管理对象**：差速移动底盘
- 左侧驱动轮电机
- 右侧驱动轮电机  
- 左侧编码器
- 右侧编码器

**主要功能**：
1. 接收速度指令（线速度、角速度）
2. 执行电机PWM控制
3. 读取编码器反馈
4. 发布里程计数据
5. 实现PID速度闭环控制

#### 2.1.2 硬件接口

**QT Py ESP32-C3可用GPIO**：
- GPIO0-5: ADC接口（GPIO5-6已用于OLED）
- GPIO7: SPI_SS（可用作通用GPIO）
- GPIO8-9: I2C接口（主传感器总线）
- GPIO10: 通用GPIO
- GPIO20-21: UART（调试串口）

| 接口类型 | 引脚分配 | 连接设备 | 说明 |
|---------|---------|---------|------|
| PWM输出 | GPIO0 | 左侧电机驱动器PWM | 速度控制 |
| PWM输出 | GPIO1 | 右侧电机驱动器PWM | 速度控制 |
| I2C（主） | GPIO8 (SDA), GPIO9 (SCL) | 电机驱动器I2C配置 | 读取编码器 |
| GPIO输入 | GPIO10 | 限位开关/紧急停止 | 安全保护 |
| UART | GPIO20 (RX), GPIO21 (TX) | 调试串口 | 日志输出 |
| 显示 | GPIO5 (SCL), GPIO6 (SDA) | 128x64 OLED | 状态显示（共用） |

**注意**：
- 编码器数据通过I2C电机驱动器读取（如DRV8833+编码器接口模块）
- GPIO5-6被OLED屏幕占用，但也可能是I2C总线的一部分
- 128x64 OLED用于显示节点状态、IP地址、运行信息

#### 2.1.3 ROS接口

**订阅话题**：
- `/chassis/cmd_vel` (`geometry_msgs/msg/Twist`)
  - 线速度（m/s）：-1.0 ~ 1.0
  - 角速度（rad/s）：-2.0 ~ 2.0

**发布话题**：
- `/chassis/odom` (`nav_msgs/msg/Odometry`) @ 50 Hz
  - 位置（x, y, θ）
  - 速度（vx, vθ）
- `/chassis/diagnostics` (`diagnostic_msgs/msg/DiagnosticStatus`) @ 1 Hz
  - 电机状态、编码器状态
  - CPU/内存占用

**服务**：
- `/chassis/set_pid` - 设置PID参数
- `/chassis/reset_odom` - 重置里程计
- `/chassis/enable` - 启用/禁用底盘

#### 2.1.4 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| **速度控制精度** | ±5% | 实际速度与目标速度偏差 |
| **响应时间** | <100ms | 速度指令到电机响应 |
| **里程计精度** | ±2% | 1米直线运动误差<2cm |
| **发布频率** | 50 Hz | 里程计数据稳定性 |

---

### 2.2 升降机构节点（NODE-02）

#### 2.2.1 节点职责

**管理对象**：垂直升降机构
- 伺服电机（升降驱动）
- 位置传感器（绝对式或增量式编码器）
- 限位开关（上限位、下限位）

**主要功能**：
1. 接收高度目标指令
2. 执行伺服电机位置控制
3. 读取位置传感器反馈
4. 发布当前高度数据
5. 限位保护和缓冲控制

#### 2.2.2 硬件接口

| 接口类型 | 引脚分配 | 连接设备 | 说明 |
|---------|---------|---------|------|
| PWM输出 | GPIO0 | 伺服电机 | 位置/速度控制 |
| I2C（主） | GPIO8 (SDA), GPIO9 (SCL) | 绝对式编码器AS5600 | 位置反馈 |
| GPIO输入 | GPIO7 | 上限位开关 | 安全保护（上拉） |
| GPIO输入 | GPIO10 | 下限位开关 | 安全保护（上拉） |
| ADC（备用） | GPIO1 | 线性位置传感器 | 备用方案 |
| UART | GPIO20 (RX), GPIO21 (TX) | 调试串口 | 日志输出 |
| 显示 | GPIO5 (SCL), GPIO6 (SDA) | 128x64 OLED | 状态显示（共用） |

**注意**：
- 优先使用I2C编码器（如AS5600磁编码器）
- 限位开关配置为上拉输入，触发时接地
- OLED显示当前高度、目标高度、电机状态

#### 2.2.3 ROS接口

**订阅话题**：
- `/lift/cmd_position` (`std_msgs/msg/Float32`)
  - 目标高度（m）：0.0 ~ 3.0

**发布话题**：
- `/lift/position` (`std_msgs/msg/Float32`) @ 20 Hz
  - 当前高度（m）
- `/lift/diagnostics` (`diagnostic_msgs/msg/DiagnosticStatus`) @ 1 Hz
  - 伺服状态、限位状态

**服务**：
- `/lift/home` - 回零点
- `/lift/emergency_stop` - 紧急停止
- `/lift/set_speed` - 设置升降速度

#### 2.2.4 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| **定位精度** | ±5mm | 高度控制精度 |
| **升降速度** | 0.1-0.5 m/s | 可调节范围 |
| **响应时间** | <200ms | 指令到电机启动 |
| **安全停止时间** | <100ms | 限位触发到停止 |

---

### 2.3 环境监测节点（NODE-03）

#### 2.3.1 节点职责

**管理对象**：施工环境监测传感器
- 温湿度传感器（BME280或SHT3x）
- 气压传感器（可选，BME280集成）

**主要功能**：
1. 定期采集环境温湿度
2. 发布环境数据
3. 超限报警（温度过高/湿度过大不适宜施工）
4. 数据存储（用于施工记录）

#### 2.3.2 硬件接口

| 接口类型 | 引脚分配 | 连接设备 | 说明 |
|---------|---------|---------|------|
| I2C（主） | GPIO8 (SDA), GPIO9 (SCL) | BME280/SHT3x | 环境传感器 |
| UART | GPIO20 (RX), GPIO21 (TX) | 调试串口 | 日志输出 |
| 显示 | GPIO5 (SCL), GPIO6 (SDA) | 128x64 OLED | 状态显示（共用） |

**注意**：
- BME280集成温度、湿度、气压三合一传感器
- OLED显示当前温湿度、施工适宜性判断
- I2C总线可连接多个传感器（不同地址）

#### 2.3.3 ROS接口

**发布话题**：
- `/environment/temperature` (`sensor_msgs/msg/Temperature`) @ 0.5 Hz
  - 温度（°C）：-20 ~ 60
- `/environment/humidity` (`sensor_msgs/msg/RelativeHumidity`) @ 0.5 Hz
  - 相对湿度（%）：0 ~ 100
- `/environment/pressure` (`sensor_msgs/msg/FluidPressure`) @ 0.5 Hz
  - 气压（Pa）：80000 ~ 110000

**服务**：
- `/environment/set_alarm` - 设置报警阈值

#### 2.3.4 应用场景

| 参数 | 适宜范围 | 不适宜施工条件 |
|------|---------|--------------|
| **温度** | 5°C ~ 35°C | <0°C 或 >40°C |
| **湿度** | 40% ~ 85% | >90%（影响干燥） |
| **气压** | - | 仅记录，不作判断 |

---

### 2.4 喷涂监控节点（NODE-04）

#### 2.4.1 节点职责

**管理对象**：喷涂作业监控传感器
- 喷涂压力传感器（0-10 bar）
- 流量传感器（0-5 L/min）
- 料位传感器（料桶余量检测）

**主要功能**：
1. 实时监测喷涂压力
2. 计量涂料流量
3. 检测料桶余量
4. 异常报警（压力异常、流量异常、料位过低）
5. 施工数据记录

#### 2.4.2 硬件接口

| 接口类型 | 引脚分配 | 连接设备 | 说明 |
|---------|---------|---------|------|
| ADC | GPIO0 | 压力传感器 | 0-3.3V → 0-10 bar |
| ADC | GPIO1 | 流量传感器（模拟） | 0-3.3V → 0-5 L/min |
| ADC | GPIO2 | 料位传感器 | 超声波/电容式 |
| GPIO输入 | GPIO10 | 流量脉冲计数（可选） | 脉冲式流量计 |
| UART | GPIO20 (RX), GPIO21 (TX) | 调试串口 | 日志输出 |
| 显示 | GPIO5 (SCL), GPIO6 (SDA) | 128x64 OLED | 状态显示（共用） |

**注意**：
- ESP32-C3有6个ADC通道（GPIO0-5），GPIO5-6被OLED占用，实际可用GPIO0-4
- 优先使用模拟输出传感器（0-3.3V或0-5V经分压）
- OLED显示喷涂压力、流量、料位实时数据

#### 2.4.3 ROS接口

**发布话题**：
- `/spray/pressure` (`sensor_msgs/msg/FluidPressure`) @ 10 Hz
  - 喷涂压力（Pa）
- `/spray/flow_rate` (`std_msgs/msg/Float32`) @ 10 Hz
  - 流量（L/min）
- `/spray/material_level` (`std_msgs/msg/Float32`) @ 1 Hz
  - 料位百分比（%）：0-100

**服务**：
- `/spray/reset_counter` - 重置流量计数器
- `/spray/calibrate` - 传感器校准

#### 2.4.4 监控逻辑

| 监控项 | 正常范围 | 报警条件 | 处理动作 |
|--------|---------|---------|---------|
| **压力** | 3-8 bar | <2 bar 或 >9 bar | 暂停喷涂 |
| **流量** | 0.5-3 L/min | <0.2 L/min（堵塞） | 报警提示 |
| **料位** | >20% | <10% | 提示加料 |

---

### 2.5 距离测量节点（NODE-05）

#### 2.5.1 节点职责

**管理对象**：墙面距离传感器
- 前方距离传感器（VL53L0X或超声波）
- 左侧距离传感器
- 右侧距离传感器
- 后方距离传感器（可选）

**主要功能**：
1. 实时测量机器人与墙面距离
2. 发布多方向距离数据
3. 碰撞预警
4. 辅助定位和姿态校正

#### 2.5.2 硬件接口

| 接口类型 | 引脚分配 | 连接设备 | 说明 |
|---------|---------|---------|------|
| I2C | GPIO5 (SDA), GPIO6 (SCL) | VL53L0X×4（通过I2C多路复用器） | 激光测距 |
| GPIO触发 | GPIO2, GPIO3, GPIO4, GPIO7 | HC-SR04×4（超声波备选方案） | 备选方案 |

#### 2.5.3 ROS接口

**发布话题**：
- `/range/front` (`sensor_msgs/msg/Range`) @ 10 Hz
- `/range/left` (`sensor_msgs/msg/Range`) @ 10 Hz
- `/range/right` (`sensor_msgs/msg/Range`) @ 10 Hz
- `/range/rear` (`sensor_msgs/msg/Range`) @ 10 Hz
  - 测距范围：0.02-2.0 m

**服务**：
- `/range/calibrate_offset` - 校准偏移量

#### 2.5.4 应用场景

| 应用 | 使用传感器 | 测量精度 | 作用 |
|------|-----------|---------|------|
| **墙面跟踪** | 左/右侧 | ±1cm | 保持与墙面平行 |
| **碰撞避免** | 前方 | ±2cm | 防止撞墙 |
| **定位辅助** | 全部 | ±1cm | 配合里程计定位 |

---

### 2.6 IMU姿态节点（NODE-06）

#### 2.6.1 节点职责

**管理对象**：惯性测量单元
- IMU传感器（MPU6050或ICM20948）

**主要功能**：
1. 采集三轴加速度
2. 采集三轴角速度
3. 计算姿态角（Roll、Pitch、Yaw）
4. 发布姿态数据
5. 倾斜报警

#### 2.6.2 硬件接口

| 接口类型 | 引脚分配 | 连接设备 | 说明 |
|---------|---------|---------|------|
| I2C | GPIO5 (SDA), GPIO6 (SCL) | MPU6050/ICM20948 | IMU传感器 |

#### 2.6.3 ROS接口

**发布话题**：
- `/imu/data` (`sensor_msgs/msg/Imu`) @ 50 Hz
  - 加速度（m/s²）
  - 角速度（rad/s）
  - 姿态四元数（若融合）

**服务**：
- `/imu/calibrate` - 零点校准
- `/imu/reset_orientation` - 重置姿态

#### 2.6.4 应用场景

| 应用 | 监测参数 | 报警阈值 | 作用 |
|------|---------|---------|------|
| **平衡监测** | Roll/Pitch角 | >5° | 防止机器人倾倒 |
| **姿态校正** | Yaw角 | - | 辅助导航 |
| **振动监测** | 加速度 | >2g | 异常检测 |

---

### 2.7 电源管理节点（NODE-07)

#### 2.7.1 节点职责

**管理对象**：电源监控传感器
- 电池电压监测
- 电池电流监测
- 充电状态检测

**主要功能**：
1. 监测电池电压和电流
2. 计算剩余电量
3. 发布电池状态
4. 低电量报警
5. 充电管理

#### 2.7.2 硬件接口

| 接口类型 | 引脚分配 | 连接设备 | 说明 |
|---------|---------|---------|------|
| ADC | GPIO2 | 电压采集电路 | 分压后采样 |
| ADC | GPIO3 | 电流传感器 | 霍尔电流传感器 |
| GPIO输入 | GPIO4 | 充电状态检测 | 充电器输出 |

#### 2.7.3 ROS接口

**发布话题**：
- `/battery/state` (`sensor_msgs/msg/BatteryState`) @ 1 Hz
  - 电压（V）
  - 电流（A）
  - 电量百分比（%）
  - 充电状态

**服务**：
- `/battery/calibrate` - 电量校准

#### 2.7.4 电源管理策略

| 电量范围 | 系统状态 | 动作 |
|---------|---------|------|
| **>50%** | 正常工作 | 无限制 |
| **20-50%** | 低电量预警 | 提示充电 |
| **10-20%** | 低电量保护 | 降低功耗模式 |
| **<10%** | 极低电量 | 自动返回充电 |

---

## 3. 通用功能需求

### 3.1 ROS通信接口

#### 3.1.1 通信协议

**传输方式**：
- 主要协议：UDP over WiFi
- 备用协议：TCP over WiFi
- 调试协议：UART（本地调试）

**网络配置**：
- WiFi标准：IEEE 802.11 b/g/n
- 加密方式：WPA2-PSK（推荐）/ WPA3-PSK
- 频段：2.4 GHz

#### 3.1.2 命名规范

**话题命名**：`/<node_name>/<data_type>`
- 示例：`/chassis/odom`, `/lift/position`

**节点命名**：`<node_type>_<instance_id>`
- 示例：`chassis_node_01`, `environment_node_01`

**Domain ID**：
- 默认：0（单机器人）
- 多机器人：1, 2, 3...（不同机器人使用不同ID）

#### 3.1.3 QoS配置

| 话题类型 | Reliability | History | Durability | 应用 |
|---------|-------------|---------|------------|------|
| **控制指令** | RELIABLE | KEEP_LAST(1) | VOLATILE | cmd_vel |
| **状态反馈** | RELIABLE | KEEP_LAST(10) | VOLATILE | odom |
| **传感器数据** | BEST_EFFORT | KEEP_LAST(5) | VOLATILE | range |
| **诊断信息** | RELIABLE | KEEP_LAST(10) | VOLATILE | diagnostics |

---

### 3.2 配置管理

#### 3.2.1 Menuconfig配置项

**每个节点必须支持**：
1. WiFi配置（SSID、密码、加密方式）
2. ROS Agent配置（IP、端口、Domain ID）
3. 节点名称和命名空间
4. 传感器/执行器参数（采样频率、量程等）
5. 日志级别

**配置存储**：
- 编译时配置：`sdkconfig`
- 运行时配置：NVS（非易失性存储）
- 配置优先级：NVS > sdkconfig

#### 3.2.2 运行时配置

**所有节点提供标准服务**：
- `/node_name/get_config` - 获取当前配置（JSON格式）
- `/node_name/set_config` - 更新配置（立即生效）
- `/node_name/save_config` - 保存配置到NVS
- `/node_name/reset_config` - 恢复出厂设置

---

### 3.3 异常处理

#### 3.3.1 故障检测

**每个节点必须监控**：
1. WiFi连接状态
2. ROS Agent连接状态
3. 传感器/执行器通信状态
4. CPU和内存使用率
5. 任务看门狗

#### 3.3.2 故障恢复策略

| 故障类型 | 检测方式 | 恢复策略 | 超时 |
|---------|---------|---------|------|
| **WiFi断开** | 连接状态检测 | 自动重连（指数退避） | 无限 |
| **Agent断开** | 心跳超时 | 自动重连 | 3秒 |
| **传感器失效** | 读取超时/CRC错误 | 重试3次→标记离线 | 100ms |
| **任务死锁** | 看门狗未喂狗 | 自动重启 | 5秒 |

#### 3.3.3 诊断信息发布

**标准诊断话题**：`/<node_name>/diagnostics`

**诊断级别**：
- OK (0)：正常运行
- WARN (1)：警告但可继续
- ERROR (2)：错误需关注
- STALE (3)：数据过期

---

## 4. 非功能需求

### 4.1 性能需求

#### 4.1.1 实时性要求

| 性能指标 | 目标值 | 最大容忍值 | 适用节点 |
|---------|--------|-----------|---------|
| **控制指令响应** | <50ms | <100ms | 底盘、升降 |
| **传感器采样周期** | 20-100ms | 200ms | 所有传感器节点 |
| **ROS消息发布延迟** | <20ms | <50ms | 所有节点 |
| **WiFi重连时间** | <5秒 | <10秒 | 所有节点 |

#### 4.1.2 资源占用限制

| 资源类型 | 限制值 | 当前预估 | 备注 |
|---------|--------|---------|------|
| **RAM使用** | <150 KB | ~100 KB | ESP32-C3总RAM: 400KB |
| **Flash占用** | <1.2 MB | ~800 KB | 总Flash: 4MB |
| **CPU占用** | <60% | ~40% | 平均负载 |

### 4.2 可靠性需求

#### 4.2.1 连续运行要求

| 可靠性指标 | 目标值 | 验证方法 |
|-----------|--------|---------|
| **单节点连续运行** | ≥72小时 | 老化测试 |
| **系统连续作业** | ≥8小时/天 | 现场测试 |
| **WiFi重连成功率** | ≥98% | 100次测试 |
| **节点可用性** | ≥99% | 长期监控 |

#### 4.2.2 环境适应性

| 环境参数 | 工作范围 | 存储范围 | 说明 |
|---------|---------|---------|------|
| **温度** | 0°C ~ 50°C | -20°C ~ 70°C | 施工现场温度 |
| **湿度** | 10% ~ 90% RH | 5% ~ 95% RH | 非凝露 |
| **振动** | <0.5g | - | 移动过程振动 |
| **粉尘** | IP54 | - | 施工现场防护 |

### 4.3 兼容性需求

#### 4.3.1 ROS版本兼容

| ROS版本 | 支持状态 | 测试状态 | 备注 |
|---------|---------|---------|------|
| **ROS 2 Humble** | ✅ 完全支持 | ✅ 已测试 | LTS版本，推荐 |
| **ROS 2 Iron** | ✅ 支持 | ⚠️ 部分测试 | 需验证 |
| **ROS 2 Jazzy** | ⚠️ 实验性 | ❌ 未测试 | 最新版本 |

#### 4.3.2 上位机平台

| 平台 | 支持状态 | 推荐配置 |
|------|---------|---------|
| **Ubuntu 22.04** | ✅ 推荐 | x86_64, 4GB+ RAM |
| **Ubuntu 20.04** | ✅ 支持 | x86_64, 4GB+ RAM |
| **Windows 11 + WSL2** | ⚠️ 可用 | 仅开发测试 |

### 4.4 安全性需求

#### 4.4.1 网络安全

| 安全措施 | 实施方式 | 优先级 |
|---------|---------|--------|
| **WiFi加密** | WPA2-PSK/WPA3-PSK | P0 |
| **密码存储加密** | AES-128加密存储 | P0 |
| **Flash加密** | ESP-IDF Flash Encryption | P1 |
| **安全启动** | Secure Boot v2 | P2 |

#### 4.4.2 作业安全

| 安全功能 | 实现方式 | 触发条件 |
|---------|---------|---------|
| **紧急停止** | 订阅 `/emergency_stop` | 手动/自动触发 |
| **倾斜保护** | IMU监测 | Roll/Pitch >5° |
| **碰撞避免** | 距离传感器 | 距离<0.1m |
| **低电量保护** | 电池监测 | 电量<10% |

---

## 5. 开发与交付约束

### 5.1 开发环境要求

#### 5.1.1 必备工具

| 工具 | 最低版本 | 推荐版本 | 用途 |
|------|---------|---------|------|
| **VS Code** | 1.80.0 | 最新稳定版 | IDE |
| **PlatformIO** | 6.0.0 | 最新版 | 项目管理 |
| **Python** | 3.8 | 3.10+ | ESP-IDF工具链 |
| **Git** | 2.20 | 最新版 | 版本控制 |

#### 5.1.2 ESP-IDF版本

| ESP-IDF版本 | 支持状态 | Micro-ROS兼容性 | 备注 |
|------------|---------|----------------|------|
| **v5.1.x** | ✅ 推荐 | ✅ 完全兼容 | 稳定版本 |
| **v5.0.x** | ✅ 支持 | ✅ 兼容 | 旧稳定版 |
| **v5.2.x** | ⚠️ 测试中 | ⚠️ 需验证 | 最新版本 |

### 5.2 技术栈要求

#### 5.2.1 Micro-ROS依赖

**安装步骤**：
```bash
# 1. 安装ROS 2 Humble
sudo apt install ros-humble-desktop

# 2. 安装Micro-ROS构建工具
pip install colcon-common-extensions
git clone -b humble https://github.com/micro-ROS/micro_ros_setup.git
cd micro_ros_setup
colcon build
source install/local_setup.bash

# 3. 创建Micro-ROS Agent
ros2 run micro_ros_setup create_agent_ws.sh
ros2 run micro_ros_setup build_agent.sh

# 4. 启动Agent
ros2 run micro_ros_agent micro_ros_agent udp4 --port 8888 -v
```

### 5.3 交付物清单

#### 5.3.1 必须交付的文档

| 文档名称 | 文件名 | 格式 | 说明 |
|---------|--------|------|------|
| **项目需求规格说明书** | `项目需求规格说明书.md` | Markdown | 本文档 |
| **功能需求清单表** | `功能需求清单.md` | Markdown | 详见附录A |
| **ROS接口定义文档** | `ROS接口定义文档.md` | Markdown | 详见附录B |
| **Menuconfig配置项说明** | `Menuconfig配置项说明.md` | Markdown | 详见附录C |
| **节点部署指南** | `节点部署指南.md` | Markdown | 硬件连接和配置 |
| **系统集成测试报告** | `集成测试报告.md` | Markdown | 测试结果 |

#### 5.3.2 必须交付的代码

| 交付项 | 路径 | 说明 |
|--------|------|------|
| **节点源代码** | `src/nodes/<node_name>/` | 每个节点独立目录 |
| **通用库代码** | `src/common/` | 共享代码库 |
| **PlatformIO配置** | `platformio.ini` | 多环境配置 |
| **Kconfig配置** | `Kconfig.projbuild` | Menuconfig定义 |
| **自定义ROS消息** | `msg/*.msg` | 消息定义文件 |
| **自定义ROS服务** | `srv/*.srv` | 服务定义文件 |
| **启动脚本** | `launch/` | ROS 2 launch文件 |

#### 5.3.3 硬件交付物

| 交付项 | 说明 |
|--------|------|
| **节点硬件** | ESP32-C3开发板×7 + 传感器模块 |
| **电源模块** | 48V转5V DC-DC转换器 |
| **通信模块** | WiFi路由器（工业级） |
| **接线图** | 每个节点的详细接线图 |

---

## 附录

### 附录A：功能需求清单

详见单独文档：[`功能需求清单.md`](./功能需求清单.md)

### 附录B：ROS接口定义

详见单独文档：[`ROS接口定义文档.md`](./ROS接口定义文档.md)

### 附录C：Menuconfig配置项说明

详见单独文档：[`Menuconfig配置项说明.md`](./Menuconfig配置项说明.md)

---

## 文档审批

| 角色 | 姓名 | 签名 | 日期 |
|------|------|------|------|
| 需求提出人 | - | - | - |
| 需求分析师 | - | - | - |
| 技术负责人 | - | - | - |
| 项目经理 | - | - | - |

---

**文档结束**