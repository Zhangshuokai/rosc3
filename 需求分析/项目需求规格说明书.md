# 基于Micro-ROS的ESP32-C3嵌入式应用系统需求规格说明书

## 文档信息

| 项目 | 内容 |
|------|------|
| **项目名称** | 基于Micro-ROS的ESP32-C3嵌入式应用系统 |
| **文档版本** | v1.0.0 |
| **编制日期** | 2025-10-23 |
| **文档状态** | 初稿 |
| **硬件平台** | Adafruit QT Py ESP32-C3 |
| **开发环境** | VS Code + PlatformIO + ESP-IDF |

## 修订记录

| 版本 | 日期 | 修订人 | 修订内容 | 审核人 |
|------|------|--------|----------|--------|
| v1.0.0 | 2025-10-23 | - | 初始版本，完成需求文档编制 | - |

---

## 目录

- [1. 项目概述](#1-项目概述)
  - [1.1 项目背景](#11-项目背景)
  - [1.2 应用场景](#12-应用场景)
  - [1.3 核心价值](#13-核心价值)
  - [1.4 核心干系人](#14-核心干系人)
- [2. 功能需求](#2-功能需求)
  - [2.1 传感器数据采集](#21-传感器数据采集)
  - [2.2 ROS话题发布](#22-ros话题发布)
  - [2.3 指令接收与响应](#23-指令接收与响应)
  - [2.4 配置管理](#24-配置管理)
- [3. 非功能需求](#3-非功能需求)
  - [3.1 性能需求](#31-性能需求)
  - [3.2 可靠性需求](#32-可靠性需求)
  - [3.3 兼容性需求](#33-兼容性需求)
  - [3.4 安全性需求](#34-安全性需求)
- [4. 开发与交付约束](#4-开发与交付约束)
  - [4.1 开发环境要求](#41-开发环境要求)
  - [4.2 技术栈要求](#42-技术栈要求)
  - [4.3 交付物清单](#43-交付物清单)
- [5. 附录](#5-附录)

---

## 1. 项目概述

### 1.1 项目背景

随着物联网（IoT）和机器人操作系统（ROS）技术的快速发展，嵌入式设备与ROS生态系统的集成需求日益增长。传统的ROS节点运行在性能较强的计算平台上，而资源受限的微控制器难以直接运行完整的ROS系统。

**Micro-ROS**作为针对微控制器优化的ROS 2客户端库，为资源受限的嵌入式设备提供了与ROS 2生态系统无缝集成的能力。本项目旨在基于**Adafruit QT Py ESP32-C3**开发板，利用**ESP-IDF**和**Micro-ROS**框架，构建一套完整的嵌入式数据采集与通信系统。

### 1.2 应用场景

本系统适用于以下典型应用场景：

1. **分布式传感器网络**
   - 多节点环境监测（温度、湿度、气压、光照等）
   - 工业现场数据采集
   - 智能家居传感器集成

2. **机器人系统集成**
   - 移动机器人外围传感器节点
   - 多机器人协作系统的边缘计算节点
   - 机器人远程监控与控制

3. **边缘计算应用**
   - 轻量级数据预处理节点
   - 本地决策与云端协同
   - 实时数据流传输

4. **教育与研究**
   - ROS 2学习平台
   - 嵌入式系统开发实验
   - 物联网原型验证

### 1.3 核心价值

#### 技术价值
- ✅ **ROS生态集成**：利用Micro-ROS无缝接入ROS 2生态系统，享受丰富的工具链和算法库支持
- ✅ **低成本高性能**：基于ESP32-C3芯片（RISC-V架构），成本低廉且具备WiFi连接能力
- ✅ **模块化设计**：传感器、通信、配置管理模块化，易于扩展和维护
- ✅ **标准化开发**：采用PlatformIO + ESP-IDF标准工具链，开发流程规范

#### 应用价值
- 📊 **实时数据采集**：支持多传感器并发采集，满足实时性要求
- 🌐 **远程可控**：通过ROS话题和服务实现远程配置与控制
- 🔧 **灵活配置**：基于Menuconfig的配置管理，支持现场快速部署
- 📈 **可扩展性**：支持传感器类型扩展和自定义消息格式

### 1.4 核心干系人

| 角色 | 职责 | 权限 |
|------|------|------|
| **项目负责人** | 项目整体规划、进度管控、资源协调 | 项目最终决策权 |
| **嵌入式开发工程师** | ESP32-C3固件开发、Micro-ROS集成、传感器驱动实现 | 代码提交、技术方案决策 |
| **ROS系统工程师** | ROS 2环境搭建、话题/服务定义、上位机应用开发 | ROS接口定义、系统架构设计 |
| **测试工程师** | 功能测试、性能测试、集成测试 | 测试用例审核、缺陷提交 |
| **文档工程师** | 需求文档、设计文档、用户手册编写 | 文档发布权限 |
| **最终用户** | 系统部署、使用反馈 | 功能需求提出、验收评审 |

---

## 2. 功能需求

### 2.1 传感器数据采集

#### 2.1.1 需求概述
系统需支持多种传感器的数据采集功能，包括环境传感器、运动传感器、状态传感器等，并对采集数据进行处理和异常检测。

#### 2.1.2 支持的传感器类型

| 传感器类型 | 接口类型 | 典型型号 | 数据维度 | 优先级 |
|-----------|---------|---------|---------|--------|
| **温湿度传感器** | I2C/1-Wire | DHT22, SHT3x, BME280 | 温度+湿度 | P0（必须） |
| **惯性测量单元(IMU)** | I2C/SPI | MPU6050, ICM20948 | 3轴加速度+3轴陀螺仪 | P1（重要） |
| **环境光传感器** | I2C | BH1750, VEML7700 | 光照强度 | P2（可选） |
| **气压传感器** | I2C/SPI | BMP280, MS5611 | 大气压+温度 | P2（可选） |
| **距离传感器** | I2C/串口 | VL53L0X, HC-SR04 | 距离 | P2（可选） |
| **模拟传感器** | ADC | 电压、电流传感器 | 单通道模拟量 | P1（重要） |

**传感器扩展机制**：
- 支持通过配置文件动态添加传感器
- 提供传感器驱动接口规范（初始化、读取、错误处理）

#### 2.1.3 采样频率范围

| 传感器类型 | 最小采样频率 | 最大采样频率 | 默认采样频率 | 可配置性 |
|-----------|-------------|-------------|-------------|---------|
| 温湿度传感器 | 0.1 Hz (10秒) | 1 Hz (1秒) | 0.5 Hz (2秒) | ✅ Menuconfig |
| IMU | 1 Hz | 100 Hz | 50 Hz | ✅ Menuconfig |
| 环境光传感器 | 0.1 Hz | 10 Hz | 1 Hz | ✅ Menuconfig |
| 气压传感器 | 0.1 Hz | 10 Hz | 1 Hz | ✅ Menuconfig |
| 距离传感器 | 1 Hz | 50 Hz | 10 Hz | ✅ Menuconfig |
| ADC模拟传感器 | 1 Hz | 1000 Hz | 100 Hz | ✅ Menuconfig |

**采样策略**：
- 采用**FreeRTOS定时器**实现周期性采样
- 支持**事件触发**采样（如阈值触发）
- 支持**按需采样**（通过ROS服务请求）

#### 2.1.4 数据精度要求

| 数据类型 | 数据格式 | 精度要求 | 有效范围 | 单位 |
|---------|---------|---------|---------|------|
| 温度 | float32 | ±0.1°C | -40°C ~ 85°C | 摄氏度 |
| 湿度 | float32 | ±2% RH | 0% ~ 100% | 相对湿度 |
| 加速度 | float32[3] | ±0.01 m/s² | ±16 g | m/s² |
| 角速度 | float32[3] | ±0.1 °/s | ±2000 °/s | °/s |
| 光照强度 | float32 | ±5 lx | 0 ~ 65535 lx | 勒克斯 |
| 气压 | float32 | ±0.1 hPa | 300 ~ 1100 hPa | 百帕 |
| 距离 | float32 | ±1 mm | 0 ~ 2000 mm | 毫米 |
| 电压 | float32 | ±0.01 V | 0 ~ 3.3 V | 伏特 |

**校准机制**：
- 支持传感器出厂校准参数加载
- 提供现场校准接口（通过ROS服务）
- 存储校准数据至NVS（非易失性存储）

#### 2.1.5 异常数据处理逻辑

**异常类型定义**：

| 异常类型 | 触发条件 | 处理策略 | 日志级别 |
|---------|---------|---------|---------|
| **传感器通信失败** | I2C/SPI读取超时（>100ms） | 重试3次，失败后标记传感器离线 | ERROR |
| **数据超出范围** | 读数超出传感器有效范围 | 丢弃数据，发布错误状态消息 | WARNING |
| **数据突变** | 相邻两次采样差值>阈值 | 标记为可疑数据，连续3次突变则重新初始化传感器 | WARNING |
| **CRC校验失败** | 数据包校验和不匹配 | 重新读取，3次失败后标记数据无效 | ERROR |
| **传感器未初始化** | 采集前未完成初始化 | 跳过采集，记录错误 | ERROR |

**异常处理流程**：

```
1. 检测异常 → 2. 记录日志 → 3. 执行处理策略 → 4. 更新传感器状态
                                                        ↓
5. 发布诊断消息（diagnostic_msgs） ← ← ← ← ← ← ← ← ← ←
```

**数据有效性标记**：
- 每个传感器数据附带**状态标志**（status: OK/WARNING/ERROR/STALE）
- 在ROS消息中包含**时间戳**和**序列号**
- 提供**数据质量指示器**（quality: 0.0~1.0，1.0为最佳）

---

### 2.2 ROS话题发布

#### 2.2.1 需求概述
系统通过Micro-ROS客户端库，将传感器数据以标准ROS 2消息格式发布到指定话题，供上位机或其他ROS节点订阅使用。

#### 2.2.2 话题定义规范

**话题命名规则**：
- 遵循ROS命名约定：`/<namespace>/<sensor_type>/<data_type>`
- 示例：`/esp32c3_node/imu/data`、`/esp32c3_node/temperature/raw`

**标准话题清单**：

| 话题名称 | 消息类型 | 功能描述 | QoS配置 | 发布频率 |
|---------|---------|---------|---------|---------|
| `/esp32c3/imu/data` | `sensor_msgs/msg/Imu` | IMU原始数据（加速度+角速度） | RELIABLE | 50 Hz |
| `/esp32c3/temperature` | `sensor_msgs/msg/Temperature` | 温度数据 | RELIABLE | 1 Hz |
| `/esp32c3/humidity` | `sensor_msgs/msg/RelativeHumidity` | 湿度数据 | RELIABLE | 1 Hz |
| `/esp32c3/illuminance` | `sensor_msgs/msg/Illuminance` | 光照强度 | BEST_EFFORT | 1 Hz |
| `/esp32c3/pressure` | `sensor_msgs/msg/FluidPressure` | 气压数据 | RELIABLE | 1 Hz |
| `/esp32c3/range` | `sensor_msgs/msg/Range` | 距离测量 | BEST_EFFORT | 10 Hz |
| `/esp32c3/diagnostics` | `diagnostic_msgs/msg/DiagnosticStatus` | 系统诊断信息 | RELIABLE | 0.5 Hz |
| `/esp32c3/battery` | `sensor_msgs/msg/BatteryState` | 电池状态（可选） | RELIABLE | 0.1 Hz |

#### 2.2.3 消息数据结构

**示例：IMU数据消息**
```yaml
# sensor_msgs/msg/Imu
std_msgs/Header header
  uint32 seq                    # 序列号
  builtin_interfaces/Time stamp # 时间戳
  string frame_id               # 坐标系ID："imu_link"

geometry_msgs/Quaternion orientation  # 姿态（若有融合算法）
  float64 x, y, z, w

float64[9] orientation_covariance     # 姿态协方差矩阵

geometry_msgs/Vector3 angular_velocity  # 角速度（rad/s）
  float64 x, y, z

float64[9] angular_velocity_covariance

geometry_msgs/Vector3 linear_acceleration  # 线性加速度（m/s²）
  float64 x, y, z

float64[9] linear_acceleration_covariance
```

**自定义消息（可选）**：
- **路径**：`msg/SensorArray.msg`（用于批量发布多传感器数据）
- **内容**：
  ```
  std_msgs/Header header
  SensorData[] sensors
  ```

#### 2.2.4 发布频率配置

**频率分级策略**：

| 频率等级 | 频率范围 | 适用场景 | 功耗影响 |
|---------|---------|---------|---------|
| **超高频** | 100 Hz+ | 高速运动检测、控制回路 | 高 |
| **高频** | 10-100 Hz | IMU、距离传感器 | 中高 |
| **中频** | 1-10 Hz | 环境传感器、慢速变化量 | 中 |
| **低频** | 0.1-1 Hz | 温湿度、诊断信息 | 低 |

**动态频率调整**（可选功能）：
- 通过ROS参数服务器动态调整发布频率
- 根据网络带宽自适应降频
- 睡眠模式下自动降低采样频率

#### 2.2.5 QoS配置

**QoS策略详细配置**：

| QoS参数 | RELIABLE模式 | BEST_EFFORT模式 | 说明 |
|---------|-------------|----------------|------|
| **Reliability** | RELIABLE | BEST_EFFORT | 可靠性保证 |
| **History** | KEEP_LAST(10) | KEEP_LAST(1) | 历史消息保留数 |
| **Durability** | VOLATILE | VOLATILE | 不持久化 |
| **Deadline** | - | - | 无截止时间 |
| **Lifespan** | - | - | 无生命周期限制 |
| **Liveliness** | AUTOMATIC | AUTOMATIC | 自动心跳 |

**QoS选择原则**：
- 🔴 **关键安全数据**（如IMU）→ RELIABLE
- 🟡 **高频非关键数据**（如光照）→ BEST_EFFORT
- 🟢 **诊断信息** → RELIABLE

**网络异常处理**：
- WiFi断开时，数据缓存至内存队列（最大1000条）
- 重连后按时间顺序发送缓存数据
- 队列满时丢弃最旧数据

---

### 2.3 指令接收与响应

#### 2.3.1 需求概述
系统需支持通过ROS服务（Service）或订阅话题（Subscriber）接收来自上位机的控制指令，并在规定时间内完成响应。

#### 2.3.2 支持的指令类型

**服务（Service）类型指令**：

| 服务名称 | 服务类型 | 功能描述 | 超时时间 | 响应内容 |
|---------|---------|---------|---------|---------|
| `/esp32c3/set_sampling_rate` | `std_srvs/srv/SetFloat` | 设置传感器采样频率 | 2秒 | 成功/失败+错误码 |
| `/esp32c3/calibrate_sensor` | 自定义`CalibrateSensor.srv` | 传感器校准 | 10秒 | 校准参数+状态 |
| `/esp32c3/reset_node` | `std_srvs/srv/Trigger` | 软重启节点 | 5秒 | 确认消息 |
| `/esp32c3/get_config` | 自定义`GetConfig.srv` | 获取当前配置 | 1秒 | 配置JSON字符串 |
| `/esp32c3/set_wifi` | 自定义`SetWiFi.srv` | 更新WiFi配置 | 3秒 | 连接状态 |

**话题订阅类型指令**：

| 话题名称 | 消息类型 | 功能描述 | 响应方式 |
|---------|---------|---------|---------|
| `/esp32c3/cmd_led` | `std_msgs/msg/ColorRGBA` | 控制LED颜色 | 无需响应 |
| `/esp32c3/cmd_sleep` | `std_msgs/msg/Bool` | 进入/退出睡眠模式 | 发布状态话题 |
| `/esp32c3/cmd_emergency_stop` | `std_msgs/msg/Empty` | 紧急停止 | 立即停止所有操作 |

#### 2.3.3 指令格式规范

**示例：设置采样频率服务**
```yaml
# SetSamplingRate.srv（请求）
string sensor_name      # 传感器名称："imu", "temperature"等
float32 frequency_hz    # 目标频率（Hz）
---
# SetSamplingRate.srv（响应）
bool success           # 是否成功
string message         # 详细信息
float32 actual_frequency  # 实际设置的频率
```

**示例：校准传感器服务**
```yaml
# CalibrateSensor.srv（请求）
string sensor_name      # 传感器名称
string calibration_type # 校准类型："zero_offset", "scale_factor"
---
# CalibrateSensor.srv（响应）
bool success
string message
float64[] calibration_params  # 校准参数数组
```

#### 2.3.4 响应超时时间

**超时机制**：
- 服务调用设置**默认超时**为5秒
- 长时间操作（如校准）支持**延长超时**（最长30秒）
- 超时后返回**TIMEOUT错误码**，并记录日志

**超时处理策略**：

| 指令类型 | 超时时间 | 超时后处理 |
|---------|---------|-----------|
| 配置读取 | 1秒 | 返回缓存配置 |
| 参数设置 | 2秒 | 回滚到之前的值 |
| 传感器校准 | 10秒 | 终止校准，保持原参数 |
| 系统重启 | 5秒 | 强制重启 |

---

### 2.4 配置管理

#### 2.4.1 需求概述
系统提供基于**ESP-IDF Menuconfig**的灵活配置管理机制，支持WiFi连接、终端通信、ROS节点等参数的可视化配置，并确保配置的持久化存储和运行时加载。

#### 2.4.2 WiFi连接参数配置

**Menuconfig配置项**：

| 配置项名称 | 配置路径 | 类型 | 默认值 | 约束规则 |
|-----------|---------|------|--------|---------|
| `WIFI_SSID` | `Component config → WiFi Configuration → SSID` | String | "" | 长度1-32字符，不可为空 |
| `WIFI_PASSWORD` | `Component config → WiFi Configuration → Password` | String | "" | 长度8-64字符（WPA2）或为空（开放网络） |
| `WIFI_ENCRYPTION` | `Component config → WiFi Configuration → Encryption` | Choice | WPA2_PSK | WPA2_PSK/WPA3_PSK/OPEN |
| `WIFI_MAX_RETRY` | `Component config → WiFi Configuration → Max Retry` | Int | 5 | 范围：1-20 |
| `WIFI_CONNECT_TIMEOUT` | `Component config → WiFi Configuration → Timeout (s)` | Int | 30 | 范围：5-120秒 |

**配置约束规则**：
- ✅ **SSID不可为空**：编译时检查，否则报错
- ✅ **密码长度校验**：WPA2模式下强制8-64字符
- ✅ **加密方式匹配**：密码为空时仅允许OPEN模式
- ⚠️ **敏感信息警告**：密码明文存储时给出安全提示

**保存机制**：
- 配置保存至`sdkconfig`文件
- 编译时嵌入固件
- 支持运行时通过NVS更新WiFi配置（无需重新编译）

#### 2.4.3 终端通信指令配置

**支持的终端通信协议**：

| 协议类型 | 端口 | 波特率 | 应用场景 |
|---------|------|--------|---------|
| **UART** | UART0 | 115200 | 调试日志、本地配置 |
| **USB-CDC** | - | - | USB直连调试 |

**Menuconfig配置项**：

| 配置项 | 路径 | 默认值 | 约束 |
|--------|------|--------|------|
| `CONSOLE_UART_NUM` | `Component config → Console → UART Number` | UART0 | UART0/UART1 |
| `CONSOLE_BAUD_RATE` | `Component config → Console → Baud Rate` | 115200 | 9600/115200/921600 |
| `ENABLE_USB_CDC` | `Component config → Console → Enable USB-CDC` | true | - |

**终端指令集**（可选功能）：
```bash
# 查看配置
> config get wifi_ssid
SSID: MyNetwork

# 设置配置
> config set sampling_rate_imu 100
OK: IMU sampling rate set to 100 Hz

# 查看传感器状态
> sensor status
IMU: OK, Temperature: OK, Humidity: WARNING

# 重启系统
> system restart
```

#### 2.4.4 ROS节点连接地址配置

**Menuconfig配置项**：

| 配置项 | 路径 | 默认值 | 说明 |
|--------|------|--------|------|
| `MICRO_ROS_AGENT_IP` | `Component config → Micro-ROS → Agent IP` | "192.168.1.100" | ROS 2 Agent的IP地址 |
| `MICRO_ROS_AGENT_PORT` | `Component config → Micro-ROS → Agent Port` | 8888 | UDP端口号 |
| `MICRO_ROS_NODE_NAME` | `Component config → Micro-ROS → Node Name` | "esp32c3_node" | ROS节点名称 |
| `MICRO_ROS_NAMESPACE` | `Component config → Micro-ROS → Namespace` | "" | ROS命名空间 |
| `MICRO_ROS_DOMAIN_ID` | `Component config → Micro-ROS → Domain ID` | 0 | ROS 2 Domain ID（0-232） |

**配置约束规则**：
- IP地址格式校验（正则表达式）
- 端口范围：1024-65535
- 节点名称：仅允许字母、数字、下划线
- Domain ID：0-232

**错误提示逻辑**：
```c
// 编译时检查示例
#if !defined(CONFIG_MICRO_ROS_AGENT_IP) || strlen(CONFIG_MICRO_ROS_AGENT_IP) == 0
    #error "Micro-ROS Agent IP must be configured!"
#endif

// 运行时验证
if (!is_valid_ip(CONFIG_MICRO_ROS_AGENT_IP)) {
    ESP_LOGE(TAG, "Invalid Agent IP: %s", CONFIG_MICRO_ROS_AGENT_IP);
    // 使用默认值或进入安全模式
}
```

#### 2.4.5 配置持久化与加载

**配置存储机制**：

| 配置类型 | 存储位置 | 存储方式 | 更新时机 |
|---------|---------|---------|---------|
| **编译时配置** | sdkconfig | Kconfig | 编译前 |
| **运行时配置** | NVS分区 | Key-Value | 运行时通过服务 |
| **出厂配置** | Flash分区 | JSON文件 | 烧录时 |

**配置加载流程**：
```
1. 系统启动
   ↓
2. 加载sdkconfig编译时配置
   ↓
3. 检查NVS是否有运行时覆盖配置
   ↓
4. 合并配置（NVS优先级高于sdkconfig）
   ↓
5. 验证配置有效性
   ↓
6. 应用配置
```

**配置备份与恢复**：
- 配置更新前自动备份至`nvs_backup`分区
- 提供恢复出厂设置功能（通过长按按钮或ROS服务）
- 配置文件支持导出为JSON格式

---

## 3. 非功能需求

### 3.1 性能需求

#### 3.1.1 实时性要求

| 性能指标 | 目标值 | 最大容忍值 | 测试方法 |
|---------|--------|-----------|---------|
| **传感器采样延迟** | <5ms | <10ms | 示波器测量 |
| **ROS消息发布延迟** | <20ms | <50ms | 时间戳对比 |
| **服务调用响应时间** | <100ms | <500ms | ROS服务计时 |
| **WiFi重连时间** | <5秒 | <10秒 | 自动化测试 |
| **系统启动时间** | <3秒 | <5秒 | 串口日志统计 |

#### 3.1.2 吞吐量要求

| 数据类型 | 最小吞吐量 | 目标吞吐量 | 说明 |
|---------|-----------|-----------|------|
| **ROS消息发送** | 500 msg/s | 1000 msg/s | 所有话题总和 |
| **传感器数据采集** | 100 Hz | 200 Hz | 单传感器 |
| **WiFi数据传输** | 100 KB/s | 500 KB/s | 上行数据 |

#### 3.1.3 资源占用限制

| 资源类型 | 限制值 | 当前预估 | 备注 |
|---------|--------|---------|------|
| **RAM使用** | <200 KB | ~150 KB | ESP32-C3总RAM: 400KB |
| **Flash占用** | <1.5 MB | ~1.2 MB | 总Flash: 4MB |
| **CPU占用** | <70% | ~50% | 平均负载 |

### 3.2 可靠性需求

#### 3.2.1 连续运行要求

| 可靠性指标 | 目标值 | 验证方法 |
|-----------|--------|---------|
| **无故障连续运行时长** | ≥7天（168小时） | 老化测试 |
| **平均无故障时间（MTBF）** | ≥1000小时 | 统计分析 |
| **系统可用性** | ≥99.5% | 监控日志 |

**故障定义**：
- 🔴 **关键故障**：系统崩溃、数据丢失、无法恢复
- 🟡 **一般故障**：传感器读取失败、短暂连接中断
- 🟢 **轻微故障**：单次数据异常、偶发性延迟

#### 3.2.2 自动重连机制

**WiFi断开重连**：

| 场景 | 检测时间 | 重连策略 | 最大重试次数 |
|------|---------|---------|------------|
| **短暂断网** | 1秒内检测 | 立即重连 | 5次 |
| **长时间断网** | 持续>30秒 | 指数退避（1s, 2s, 4s, 8s...） | 无限次 |
| **路由器重启** | SSID扫描失败 | 每10秒扫描一次 | 无限次 |

**ROS Agent断开重连**：

| 场景 | 检测方式 | 重连策略 | 数据处理 |
|------|---------|---------|---------|
| **心跳超时** | 3秒无响应 | 立即重连 | 缓存数据（最多1000条） |
| **Agent重启** | 连接拒绝 | 每2秒尝试 | 等待重连成功后发送 |
| **网络切换** | IP变化 | 重新建立连接 | 清空缓存，重新同步时间 |

**看门狗机制**：
- 启用**任务看门狗**（TWDT），监控关键任务（采样、发布）
- 超时5秒未喂狗则自动重启系统
- 重启前保存错误日志至Flash

### 3.3 兼容性需求

#### 3.3.1 Micro-ROS版本

| 组件 | 最低版本 | 推荐版本 | 备注 |
|------|---------|---------|------|
| **Micro-ROS Client** | v2.0.0 | v2.4.0+ | 基于ROS 2 Humble |
| **Micro-ROS Agent** | v2.0.0 | v2.4.0+ | 运行在上位机 |
| **rmw实现** | rmw_microxrcedds | rmw_microxrcedds | DDS实现 |

#### 3.3.2 ROS环境

| ROS版本 | 支持状态 | 测试状态 | 备注 |
|---------|---------|---------|------|
| **ROS 2 Humble** | ✅ 完全支持 | ✅ 已测试 | LTS版本，推荐 |
| **ROS 2 Iron** | ✅ 支持 | ⚠️ 部分测试 | 需验证兼容性 |
| **ROS 2 Jazzy** | ⚠️ 实验性支持 | ❌ 未测试 | 最新版本 |
| **ROS 1** | ❌ 不支持 | - | 需通过ros1_bridge桥接 |

#### 3.3.3 通信协议

| 协议类型 | 传输层 | 应用场景 | 支持状态 |
|---------|--------|---------|---------|
| **UDP over WiFi** | UDP | 低延迟数据传输 | ✅ 主要方式 |
| **TCP over WiFi** | TCP | 可靠数据传输 | ⚠️ 可选支持 |
| **Serial** | UART | 本地调试 | ✅ 调试用 |

### 3.4 安全性需求

#### 3.4.1 WiFi加密方式

| 加密方式 | 支持状态 | 安全等级 | 应用场景 |
|---------|---------|---------|---------|
| **WPA2-PSK** | ✅ 推荐 | 高 | 企业/家庭网络 |
| **WPA3-PSK** | ✅ 支持 | 极高 | 高安全要求场景 |
| **WPA-PSK** | ⚠️ 不推荐 | 中 | 兼容旧设备 |
| **OPEN** | ⚠️ 仅测试用 | 无 | 开发环境 |

**安全配置强制规则**：
- 生产环境**禁止**使用OPEN模式
- 密码强度检查：至少8字符，包含字母+数字
- 支持**企业级WPA2-Enterprise**（可选，需配置证书）

#### 3.4.2 敏感配置存储加密

**加密存储机制**：

| 配置项 | 存储位置 | 加密方式 | 密钥管理 |
|--------|---------|---------|---------|
| **WiFi密码** | NVS加密分区 | AES-128 | Flash加密密钥 |
| **ROS认证令牌** | NVS加密分区 | AES-128 | Flash加密密钥 |
| **传感器校准数据** | NVS普通分区 | 无 | - |
| **设备序列号** | eFuse | 不可修改 | 硬件保护 |

**启用Flash加密**（推荐）：
- 使用ESP-IDF的**Flash Encryption**功能
- 生成唯一的加密密钥（烧录至eFuse）
- 所有敏感数据自动加密存储

**访问控制**：
- NVS命名空间隔离（`wifi_config`, `ros_config`）
- 运行时仅允许授权代码访问加密分区
- 禁止通过串口命令直接读取密码

---

## 4. 开发与交付约束

### 4.1 开发环境要求

#### 4.1.1 必备工具

| 工具 | 最低版本 | 推荐版本 | 用途 |
|------|---------|---------|------|
| **VS Code** | 1.80.0 | 最新稳定版 | IDE |
| **PlatformIO** | 6.0.0 | 最新版 | 项目管理和构建 |
| **Python** | 3.8 | 3.10+ | ESP-IDF工具链 |
| **Git** | 2.20 | 最新版 | 版本控制 |

#### 4.1.2 ESP-IDF版本

**指定方式**（在`platformio.ini`中）：
```ini
[env:esp32-c3]
platform = espressif32
board = adafruit_qtpy_esp32c3
framework = espidf

# 方式1：指定平台版本（推荐）
platform = espressif32@6.4.0  ; 对应ESP-IDF v5.1.x

# 方式2：在platform_packages中指定
platform_packages =
    framework-espidf @ ~3.50100.0  ; ESP-IDF 5.1.x
```

**版本要求**：

| ESP-IDF版本 | 支持状态 | Micro-ROS兼容性 | 备注 |
|------------|---------|----------------|------|
| **v5.1.x** | ✅ 推荐 | ✅ 完全兼容 | 稳定版本 |
| **v5.0.x** | ✅ 支持 | ✅ 兼容 | 旧稳定版 |
| **v5.2.x** | ⚠️ 测试中 | ⚠️ 需验证 | 最新版本 |
| **v4.4.x** | ❌ 不支持 | ❌ 不兼容 | 过时版本 |

### 4.2 技术栈要求

#### 4.2.1 Micro-ROS依赖安装

**安装步骤**：

1. **安装Micro-ROS构建工具**：
   ```bash
   # 安装colcon（ROS 2构建工具）
   pip install colcon-common-extensions
   
   # 克隆micro_ros_setup
   git clone -b humble https://github.com/micro-ROS/micro_ros_setup.git
   cd micro_ros_setup
   colcon build
   source install/local_setup.bash
   ```

2. **创建Micro-ROS Agent工作空间**：
   ```bash
   ros2 run micro_ros_setup create_agent_ws.sh
   ros2 run micro_ros_setup build_agent.sh
   ```

3. **在ESP32-C3项目中集成Micro-ROS**：
   - **方式1**：通过PlatformIO库管理
     ```ini
     [env:esp32-c3]
     lib_deps =
         https://github.com/micro-ROS/micro_ros_platformio.git
     ```
   
   - **方式2**：手动下载组件
     ```bash
     cd components
     git clone --recursive https://github.com/micro-ROS/micro_ros_espidf_component.git
     ```

**依赖包清单**（`idf_component.yml`）：
```yaml
dependencies:
  micro_ros_espidf_component:
    git: https://github.com/micro-ROS/micro_ros_espidf_component.git
    version: humble
  
  # 传感器驱动（示例）
  esp-idf-lib:
    git: https://github.com/UncleRus/esp-idf-lib.git
    version: master
```

#### 4.2.2 传感器驱动库

| 传感器 | 驱动库 | 安装方式 |
|--------|--------|---------|
| BME280 | esp-idf-lib/bme280 | IDF组件 |
| MPU6050 | esp-idf-lib/mpu6050 | IDF组件 |
| BH1750 | esp-idf-lib/bh1750 | IDF组件 |
| VL53L0X | pololu-vl53l0x | 手动集成 |

### 4.3 交付物清单

#### 4.3.1 必须交付的文档

| 文档名称 | 文件名 | 格式 | 说明 |
|---------|--------|------|------|
| **项目需求规格说明书** | `项目需求规格说明书.md` | Markdown | 本文档 |
| **功能需求清单表** | `功能需求清单.md` | Markdown | 详见附录A |
| **ROS接口定义文档** | `ROS接口定义文档.md` | Markdown | 详见附录B |
| **Menuconfig配置项说明** | `Menuconfig配置项说明.md` | Markdown | 详见附录C |
| **硬件连接指南** | `硬件连接指南.md` | Markdown | 包含接线图 |
| **用户使用手册** | `用户使用手册.md` | Markdown | 部署和使用说明 |

#### 4.3.2 必须交付的代码

| 交付项 | 路径 | 说明 |
|--------|------|------|
| **完整源代码** | `src/` | 所有.c/.h文件 |
| **PlatformIO配置** | `platformio.ini` | 项目配置文件 |
| **Kconfig配置** | `Kconfig.projbuild` | Menuconfig菜单定义 |
| **组件依赖** | `idf_component.yml` | ESP-IDF组件清单 |
| **CMake配置** | `CMakeLists.txt` | 构建脚本 |
| **自定义ROS消息** | `msg/*.msg` | 消息定义文件 |
| **自定义ROS服务** | `srv/*.srv` | 服务定义文件 |

#### 4.3.3 可选交付物

| 交付项 | 说明 |
|--------|------|
| **单元测试代码** | `test/`目录下 |
| **硬件设计文件** | 原理图、PCB设计 |
| **性能测试报告** | 压力测试、功耗测试 |
| **培训视频** | 使用和二次开发教程 |

---

## 5. 附录

### 附录A：功能需求清单

详见单独文档：[`功能需求清单.md`](./功能需求清单.md)

### 附录B：ROS接口定义

详见单独文档：[`ROS接口定义文档.md`](./ROS接口定义文档.md)

### 附录C：Menuconfig配置项说明

详见单独文档：[`Menuconfig配置项说明.md`](./Menuconfig配置项说明.md)

---

## 文档审批

| 角色 | 姓名 | 签名 | 日期 |
|------|------|------|------|
| 需求提出人 | - | - | - |
| 需求分析师 | - | - | - |
| 技术负责人 | - | - | - |
| 项目经理 | - | - | - |

---

**文档结束**