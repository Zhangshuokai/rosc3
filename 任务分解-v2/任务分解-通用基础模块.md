# 任务分解：通用基础模块

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档标题** | 通用基础模块任务分解文档 |
| **文档版本** | v1.0.0 |
| **编制日期** | 2025-10-23 |
| **适用范围** | 所有ESP32-C3节点通用模块 |
| **项目架构** | 7个ESP32-C3节点 + ROS 2 Humble + Micro-ROS |

---

## 目录

- [1. 模块概述](#1-模块概述)
- [2. WiFi管理模块](#2-wifi管理模块)
- [3. ROS通信模块](#3-ros通信模块)
- [4. 配置管理模块](#4-配置管理模块)
- [5. OLED显示模块](#5-oled显示模块)
- [6. 诊断服务模块](#6-诊断服务模块)
- [7. 依赖关系图](#7-依赖关系图)

---

## 1. 模块概述

### 1.1 通用基础模块定义

通用基础模块是所有ESP32-C3节点共享的核心功能模块，提供：
- 网络连接管理（WiFi）
- ROS 2通信能力（Micro-ROS）
- 配置存储和管理
- 本地状态显示（OLED）
- 系统诊断和监控

### 1.2 模块清单

| 模块名称 | 路径 | 优先级 | 依赖节点 |
|---------|------|--------|---------|
| WiFi管理模块 | [`src/common/wifi_manager/`](src/common/wifi_manager/) | P0 | 全部 |
| ROS通信模块 | [`src/common/ros_comm/`](src/common/ros_comm/) | P0 | 全部 |
| 配置管理模块 | [`src/common/config/`](src/common/config/) | P0 | 全部 |
| OLED显示模块 | [`src/common/oled/`](src/common/oled/) | P1 | 全部 |
| 诊断服务模块 | [`src/common/diagnostic/`](src/common/diagnostic/) | P1 | 全部 |

### 1.3 设计原则

- **单一职责**：每个模块只负责一项功能
- **接口最小化**：提供简洁清晰的API
- **错误处理完善**：统一使用`esp_err_t`返回值
- **线程安全**：使用互斥锁保护共享资源
- **配置灵活**：支持Menuconfig和NVS配置

---

## 2. WiFi管理模块

### 2.1 任务1：WiFi初始化和连接

**任务ID**: TASK-COMMON-001  
**优先级**: P0  
**估算时间**: 8小时  
**依赖任务**: 无

**功能描述**:
- 初始化WiFi驱动和事件处理
- 支持WPA2/WPA3加密方式
- 连接到指定WiFi网络
- 获取IP地址并建立网络连接

**技术实现细节**:

1. **文件结构**
   - [`src/common/wifi_manager/wifi_manager.h`](src/common/wifi_manager/wifi_manager.h) - WiFi管理接口定义
   - [`src/common/wifi_manager/wifi_manager.c`](src/common/wifi_manager/wifi_manager.c) - WiFi管理实现

2. **关键函数**
   ```c
   /**
    * @brief 初始化WiFi管理器
    * @param[in] config WiFi配置参数
    * @return 
    *   - ESP_OK: 成功
    *   - ESP_ERR_INVALID_ARG: 参数无效
    *   - ESP_ERR_NO_MEM: 内存不足
    */
   esp_err_t wifi_manager_init(const wifi_config_t *config);
   
   /**
    * @brief 连接WiFi网络
    * @return 
    *   - ESP_OK: 连接成功
    *   - ESP_ERR_WIFI_NOT_INIT: WiFi未初始化
    *   - ESP_ERR_WIFI_TIMEOUT: 连接超时
    */
   esp_err_t wifi_manager_connect(void);
   
   /**
    * @brief 断开WiFi连接
    * @return ESP_OK: 成功
    */
   esp_err_t wifi_manager_disconnect(void);
   
   /**
    * @brief 获取WiFi状态
    * @param[out] status 状态结构体
    * @return ESP_OK: 成功
    */
   esp_err_t wifi_manager_get_status(wifi_status_t *status);
   ```

3. **数据结构**
   ```c
   /**
    * @brief WiFi配置结构体
    */
   typedef struct {
       char ssid[32];              ///< WiFi SSID
       char password[64];          ///< WiFi密码
       wifi_auth_mode_t auth_mode; ///< 加密方式（WPA2/WPA3）
       uint8_t max_retry;          ///< 最大重试次数
       uint32_t timeout_ms;        ///< 连接超时（毫秒）
   } wifi_config_t;
   
   /**
    * @brief WiFi状态枚举
    */
   typedef enum {
       WIFI_STATE_DISCONNECTED,    ///< 未连接
       WIFI_STATE_CONNECTING,      ///< 连接中
       WIFI_STATE_CONNECTED,       ///< 已连接
       WIFI_STATE_ERROR            ///< 错误状态
   } wifi_state_t;
   
   /**
    * @brief WiFi状态信息
    */
   typedef struct {
       wifi_state_t state;         ///< 连接状态
       int8_t rssi;                ///< 信号强度（dBm）
       uint8_t channel;            ///< 信道
       esp_ip4_addr_t ip;          ///< IP地址
       esp_ip4_addr_t gateway;     ///< 网关
       esp_ip4_addr_t netmask;     ///< 子网掩码
       uint8_t mac[6];             ///< MAC地址
   } wifi_status_t;
   ```

4. **实现要点**
   - 使用ESP-IDF WiFi事件循环处理连接状态
   - 实现事件回调函数处理`WIFI_EVENT_STA_START`、`WIFI_EVENT_STA_CONNECTED`等事件
   - 使用事件组（EventGroup）同步WiFi连接状态
   - 所有函数使用`esp_err_t`统一错误处理
   - 日志输出使用`ESP_LOGI`/`ESP_LOGE`标签为"WIFI_MGR"

**验收标准**:
- [x] 成功连接到WPA2/WPA3加密WiFi
- [x] 正确获取IP地址
- [x] 编译无警告
- [x] 日志输出清晰可读
- [x] 符合代码规范（[`开发规范.md`](开发架构文档/开发规范.md)）

---

### 2.2 任务2：WiFi断线重连机制

**任务ID**: TASK-COMMON-002  
**优先级**: P0  
**估算时间**: 6小时  
**依赖任务**: [TASK-COMMON-001]

**功能描述**:
- 检测WiFi断线事件
- 实现指数退避重连机制
- 记录重连次数和状态
- 提供重连状态查询接口

**技术实现细节**:

1. **关键函数**
   ```c
   /**
    * @brief 启动自动重连
    * @param[in] enable true=启用, false=禁用
    * @return ESP_OK: 成功
    */
   esp_err_t wifi_manager_set_auto_reconnect(bool enable);
   
   /**
    * @brief 设置重连参数
    * @param[in] params 重连参数
    * @return ESP_OK: 成功
    */
   esp_err_t wifi_manager_set_reconnect_params(const wifi_reconnect_params_t *params);
   ```

2. **数据结构**
   ```c
   /**
    * @brief WiFi重连参数
    */
   typedef struct {
       uint32_t base_delay_ms;     ///< 基础延迟（毫秒）: 1000
       uint32_t max_delay_ms;      ///< 最大延迟（毫秒）: 60000
       uint8_t max_attempts;       ///< 最大尝试次数: 0=无限
       float backoff_factor;       ///< 退避因子: 2.0
   } wifi_reconnect_params_t;
   ```

3. **实现要点**
   - 监听`WIFI_EVENT_STA_DISCONNECTED`事件
   - 实现指数退避算法：`delay = min(base_delay * backoff_factor^attempt, max_delay)`
   - 使用FreeRTOS定时器实现延迟重连
   - 线程安全：使用互斥锁保护重连状态
   - 记录重连历史（最近10次）到内存

**验收标准**:
- [x] 断线后自动重连成功
- [x] 指数退避机制工作正常
- [x] 最大重连次数限制生效
- [x] 无内存泄漏
- [x] 功能测试通过

---

### 2.3 任务3：WiFi状态监控和诊断

**任务ID**: TASK-COMMON-003  
**优先级**: P1  
**估算时间**: 4小时  
**依赖任务**: [TASK-COMMON-001]

**功能描述**:
- 定期监测WiFi信号强度（RSSI）
- 记录连接质量统计
- 提供诊断信息查询接口
- 异常状态告警

**技术实现细节**:

1. **关键函数**
   ```c
   /**
    * @brief 获取WiFi统计信息
    * @param[out] stats 统计信息
    * @return ESP_OK: 成功
    */
   esp_err_t wifi_manager_get_stats(wifi_stats_t *stats);
   
   /**
    * @brief 启动WiFi监控任务
    * @param[in] interval_ms 监控间隔（毫秒）
    * @return ESP_OK: 成功
    */
   esp_err_t wifi_manager_start_monitor(uint32_t interval_ms);
   ```

2. **数据结构**
   ```c
   /**
    * @brief WiFi统计信息
    */
   typedef struct {
       uint32_t connect_count;     ///< 总连接次数
       uint32_t disconnect_count;  ///< 总断开次数
       uint32_t reconnect_count;   ///< 重连次数
       int8_t rssi_avg;            ///< 平均RSSI
       int8_t rssi_min;            ///< 最小RSSI
       int8_t rssi_max;            ///< 最大RSSI
       uint32_t uptime_sec;        ///< 累计在线时间（秒）
   } wifi_stats_t;
   ```

3. **实现要点**
   - 创建独立FreeRTOS任务定期采集RSSI
   - 使用滑动窗口计算平均RSSI（窗口大小10）
   - RSSI低于-75dBm时输出警告日志
   - 统计数据存储在静态全局变量

**验收标准**:
- [x] RSSI监控准确
- [x] 统计数据正确
- [x] 监控任务稳定运行
- [x] CPU占用<5%

---

## 3. ROS通信模块

### 3.1 任务4：Micro-ROS客户端初始化

**任务ID**: TASK-COMMON-004  
**优先级**: P0  
**估算时间**: 10小时  
**依赖任务**: [TASK-COMMON-001]

**功能描述**:
- 初始化Micro-ROS支持结构
- 创建ROS节点
- 配置自定义UDP传输层
- 建立与ROS Agent的连接

**技术实现细节**:

1. **文件结构**
   - [`src/common/ros_comm/ros_comm.h`](src/common/ros_comm/ros_comm.h) - ROS通信接口
   - [`src/common/ros_comm/ros_comm.c`](src/common/ros_comm/ros_comm.c) - ROS通信实现
   - [`src/common/ros_comm/micro_ros_transport.c`](src/common/ros_comm/micro_ros_transport.c) - UDP传输层

2. **关键函数**
   ```c
   /**
    * @brief 初始化ROS通信模块
    * @param[in] config ROS配置参数
    * @return 
    *   - ESP_OK: 成功
    *   - ESP_ERR_INVALID_STATE: WiFi未连接
    *   - ESP_FAIL: 初始化失败
    */
   esp_err_t ros_comm_init(const ros_config_t *config);
   
   /**
    * @brief 连接ROS Agent
    * @param[in] timeout_ms 超时时间（毫秒）
    * @return 
    *   - ESP_OK: 连接成功
    *   - ESP_ERR_TIMEOUT: 连接超时
    */
   esp_err_t ros_comm_connect(uint32_t timeout_ms);
   
   /**
    * @brief 断开ROS Agent连接
    * @return ESP_OK: 成功
    */
   esp_err_t ros_comm_disconnect(void);
   
   /**
    * @brief 获取ROS连接状态
    * @return true=已连接, false=未连接
    */
   bool ros_comm_is_connected(void);
   ```

3. **数据结构**
   ```c
   /**
    * @brief ROS配置结构体
    */
   typedef struct {
       char agent_ip[16];          ///< Agent IP地址
       uint16_t agent_port;        ///< Agent端口（默认8888）
       char node_name[32];         ///< 节点名称
       char node_namespace[32];    ///< 节点命名空间
       uint8_t domain_id;          ///< Domain ID（默认0）
       uint32_t ping_timeout_ms;   ///< Ping超时（毫秒）
   } ros_config_t;
   
   /**
    * @brief ROS通信上下文
    */
   typedef struct {
       rcl_node_t node;                ///< ROS节点
       rcl_executor_t executor;        ///< 执行器
       rclc_support_t support;         ///< 支持结构
       bool is_connected;              ///< 连接状态
       SemaphoreHandle_t mutex;        ///< 互斥锁
   } ros_comm_context_t;
   ```

4. **实现要点**
   - 调用`rmw_uros_set_custom_transport()`注册UDP传输层
   - 使用`rclc_support_init()`初始化支持结构
   - 使用`rclc_node_init_default()`创建节点
   - 实现Ping机制检测Agent连接状态（每秒一次）
   - 错误时释放所有资源（使用goto统一清理）

**验收标准**:
- [x] 成功连接到ROS Agent
- [x] 节点在`ros2 node list`中可见
- [x] Ping延迟<50ms
- [x] 无内存泄漏
- [x] 编译无警告

---

### 3.2 任务5：UDP传输层实现

**任务ID**: TASK-COMMON-005  
**优先级**: P0  
**估算时间**: 8小时  
**依赖任务**: [TASK-COMMON-004]

**功能描述**:
- 实现Micro-ROS自定义传输层接口
- UDP套接字创建和管理
- 数据发送和接收
- 超时和错误处理

**技术实现细节**:

1. **关键函数**
   ```c
   /**
    * @brief 打开传输层
    * @param[in] transport 传输层结构
    * @return true=成功, false=失败
    */
   bool custom_transport_open(struct uxrCustomTransport *transport);
   
   /**
    * @brief 关闭传输层
    * @param[in] transport 传输层结构
    * @return true=成功
    */
   bool custom_transport_close(struct uxrCustomTransport *transport);
   
   /**
    * @brief 发送数据
    * @param[in] transport 传输层结构
    * @param[in] buf 数据缓冲区
    * @param[in] len 数据长度
    * @param[out] err 错误码
    * @return 实际发送字节数
    */
   size_t custom_transport_write(
       struct uxrCustomTransport *transport,
       const uint8_t *buf,
       size_t len,
       uint8_t *err
   );
   
   /**
    * @brief 接收数据
    * @param[in] transport 传输层结构
    * @param[out] buf 数据缓冲区
    * @param[in] len 缓冲区大小
    * @param[in] timeout 超时时间（毫秒）
    * @param[out] err 错误码
    * @return 实际接收字节数
    */
   size_t custom_transport_read(
       struct uxrCustomTransport *transport,
       uint8_t *buf,
       size_t len,
       int timeout,
       uint8_t *err
   );
   ```

2. **实现要点**
   - 使用`socket()`创建UDP套接字
   - 使用`sendto()`发送数据到Agent
   - 使用`recvfrom()`接收数据
   - 使用`setsockopt()`设置接收超时（SO_RCVTIMEO）
   - 错误时返回0，不抛出异常
   - 记录发送/接收字节数统计

**验收标准**:
- [x] UDP数据收发正常
- [x] 超时机制工作正常
- [x] 无内存泄漏
- [x] 网络断开时正确返回错误

---

### 3.3 任务6：发布者和订阅者管理

**任务ID**: TASK-COMMON-006  
**优先级**: P0  
**估算时间**: 12小时  
**依赖任务**: [TASK-COMMON-004]

**功能描述**:
- 创建和管理ROS发布者
- 创建和管理ROS订阅者
- 消息发布接口
- 回调函数注册

**技术实现细节**:

1. **关键函数**
   ```c
   /**
    * @brief 创建发布者
    * @param[out] publisher 发布者句柄
    * @param[in] topic_name 话题名称
    * @param[in] type_support 消息类型
    * @param[in] qos QoS配置
    * @return ESP_OK: 成功
    */
   esp_err_t ros_comm_create_publisher(
       rcl_publisher_t *publisher,
       const char *topic_name,
       const rosidl_message_type_support_t *type_support,
       const rmw_qos_profile_t *qos
   );
   
   /**
    * @brief 发布消息
    * @param[in] publisher 发布者句柄
    * @param[in] msg 消息指针
    * @return ESP_OK: 成功
    */
   esp_err_t ros_comm_publish(
       rcl_publisher_t *publisher,
       const void *msg
   );
   
   /**
    * @brief 创建订阅者
    * @param[out] subscription 订阅者句柄
    * @param[in] topic_name 话题名称
    * @param[in] type_support 消息类型
    * @param[in] qos QoS配置
    * @param[in] callback 回调函数
    * @return ESP_OK: 成功
    */
   esp_err_t ros_comm_create_subscription(
       rcl_subscription_t *subscription,
       const char *topic_name,
       const rosidl_message_type_support_t *type_support,
       const rmw_qos_profile_t *qos,
       ros_callback_t callback
   );
   
   /**
    * @brief 自旋处理回调
    * @param[in] timeout_ms 超时时间（毫秒）
    * @return ESP_OK: 成功
    */
   esp_err_t ros_comm_spin_once(uint32_t timeout_ms);
   ```

2. **数据结构**
   ```c
   /**
    * @brief ROS回调函数类型
    */
   typedef void (*ros_callback_t)(const void *msg, void *user_data);
   
   /**
    * @brief 预定义QoS配置
    */
   extern const rmw_qos_profile_t QOS_CONTROL_CMD;      ///< 控制指令
   extern const rmw_qos_profile_t QOS_SENSOR_DATA;      ///< 传感器数据
   extern const rmw_qos_profile_t QOS_BEST_EFFORT;      ///< 尽力而为
   extern const rmw_qos_profile_t QOS_DIAGNOSTICS;      ///< 诊断信息
   ```

3. **实现要点**
   - 使用`rcl_publisher_init()`初始化发布者
   - 使用`rcl_publish()`发布消息
   - 使用`rclc_subscription_init_default()`初始化订阅者
   - 使用`rclc_executor_add_subscription()`添加到执行器
   - 使用`rclc_executor_spin_some()`处理回调
   - 线程安全：发布和订阅操作使用互斥锁保护

**验收标准**:
- [x] 发布者正常发布消息
- [x] 订阅者正常接收消息
- [x] 回调函数正确执行
- [x] QoS配置生效
- [x] 无数据竞争

---

### 3.4 任务7：服务调用封装

**任务ID**: TASK-COMMON-007  
**优先级**: P1  
**估算时间**: 8小时  
**依赖任务**: [TASK-COMMON-004]

**功能描述**:
- 创建和管理ROS服务
- 同步服务调用接口
- 服务请求处理
- 超时机制

**技术实现细节**:

1. **关键函数**
   ```c
   /**
    * @brief 创建服务
    * @param[out] service 服务句柄
    * @param[in] service_name 服务名称
    * @param[in] type_support 服务类型
    * @param[in] callback 服务回调
    * @return ESP_OK: 成功
    */
   esp_err_t ros_comm_create_service(
       rcl_service_t *service,
       const char *service_name,
       const rosidl_service_type_support_t *type_support,
       ros_service_callback_t callback
   );
   
   /**
    * @brief 调用服务（同步）
    * @param[in] service_name 服务名称
    * @param[in] request 请求消息
    * @param[out] response 响应消息
    * @param[in] timeout_ms 超时时间（毫秒）
    * @return ESP_OK: 成功
    */
   esp_err_t ros_comm_call_service(
       const char *service_name,
       const void *request,
       void *response,
       uint32_t timeout_ms
   );
   ```

2. **数据结构**
   ```c
   /**
    * @brief 服务回调函数类型
    */
   typedef void (*ros_service_callback_t)(
       const void *request,
       void *response,
       void *user_data
   );
   ```

3. **实现要点**
   - 使用`rclc_service_init_default()`初始化服务
   - 使用`rclc_executor_add_service()`添加到执行器
   - 同步调用使用事件组等待响应
   - 实现超时机制，超时返回`ESP_ERR_TIMEOUT`

**验收标准**:
- [x] 服务正常响应请求
- [x] 超时机制工作正常
- [x] 并发请求处理正确
- [x] 功能测试通过

---

## 4. 配置管理模块

### 4.1 任务8：NVS存储读写

**任务ID**: TASK-COMMON-008  
**优先级**: P0  
**估算时间**: 6小时  
**依赖任务**: 无

**功能描述**:
- 初始化NVS分区
- 读取和写入配置项
- 支持多种数据类型（字符串、整数、布尔值）
- 错误处理和恢复

**技术实现细节**:

1. **文件结构**
   - [`src/common/config/config_manager.h`](src/common/config/config_manager.h) - 配置管理接口
   - [`src/common/config/config_manager.c`](src/common/config/config_manager.c) - 配置管理实现

2. **关键函数**
   ```c
   /**
    * @brief 初始化配置管理器
    * @return ESP_OK: 成功
    */
   esp_err_t config_manager_init(void);
   
   /**
    * @brief 读取字符串配置
    * @param[in] key 配置键
    * @param[out] value 配置值缓冲区
    * @param[in] max_len 缓冲区大小
    * @return ESP_OK: 成功
    */
   esp_err_t config_get_str(const char *key, char *value, size_t max_len);
   
   /**
    * @brief 写入字符串配置
    * @param[in] key 配置键
    * @param[in] value 配置值
    * @return ESP_OK: 成功
    */
   esp_err_t config_set_str(const char *key, const char *value);
   
   /**
    * @brief 读取整数配置
    * @param[in] key 配置键
    * @param[out] value 配置值
    * @return ESP_OK: 成功
    */
   esp_err_t config_get_int(const char *key, int32_t *value);
   
   /**
    * @brief 写入整数配置
    * @param[in] key 配置键
    * @param[in] value 配置值
    * @return ESP_OK: 成功
    */
   esp_err_t config_set_int(const char *key, int32_t value);
   
   /**
    * @brief 保存配置（提交到Flash）
    * @return ESP_OK: 成功
    */
   esp_err_t config_save(void);
   
   /**
    * @brief 恢复出厂设置
    * @return ESP_OK: 成功
    */
   esp_err_t config_reset_to_defaults(void);
   ```

3. **数据结构**
   ```c
   /**
    * @brief 配置命名空间
    */
   #define CONFIG_NAMESPACE "rosc3_cfg"
   
   /**
    * @brief 标准配置键
    */
   #define CFG_KEY_WIFI_SSID        "wifi_ssid"
   #define CFG_KEY_WIFI_PASSWORD    "wifi_pass"
   #define CFG_KEY_WIFI_AUTH        "wifi_auth"
   #define CFG_KEY_ROS_AGENT_IP     "ros_ip"
   #define CFG_KEY_ROS_AGENT_PORT   "ros_port"
   #define CFG_KEY_ROS_NODE_NAME    "ros_node"
   #define CFG_KEY_LOG_LEVEL        "log_level"
   ```

4. **实现要点**
   - 使用`nvs_flash_init()`初始化NVS
   - 使用`nvs_open()`打开配置命名空间
   - 使用`nvs_get_str()`/`nvs_set_str()`读写字符串
   - 使用`nvs_get_i32()`/`nvs_set_i32()`读写整数
   - 使用`nvs_commit()`提交更改
   - 错误处理：NVS损坏时自动擦除并重建

**验收标准**:
- [x] 配置正确读写
- [x] 数据持久化存储
- [x] 断电重启后配置保留
- [x] 错误恢复机制正常
- [x] 编译无警告

---

### 4.2 任务9：Menuconfig集成

**任务ID**: TASK-COMMON-009  
**优先级**: P0  
**估算时间**: 4小时  
**依赖任务**: [TASK-COMMON-008]

**功能描述**:
- 定义Kconfig配置项
- 从sdkconfig读取默认配置
- 配置优先级处理（NVS > sdkconfig）
- 配置验证

**技术实现细节**:

1. **关键函数**
   ```c
   /**
    * @brief 加载配置（NVS优先，否则使用sdkconfig）
    * @param[out] config 配置结构体
    * @return ESP_OK: 成功
    */
   esp_err_t config_load(node_config_t *config);
   
   /**
    * @brief 验证配置有效性
    * @param[in] config 配置结构体
    * @return ESP_OK: 有效
    */
   esp_err_t config_validate(const node_config_t *config);
   ```

2. **Kconfig配置示例**
   ```kconfig
   menu "WiFi Configuration"
       config WIFI_SSID
           string "WiFi SSID"
           default "YourWiFi"
           help
               WiFi network SSID
       
       config WIFI_PASSWORD
           string "WiFi Password"
           default "YourPassword"
           help
               WiFi network password
       
       choice WIFI_AUTH_MODE
           prompt "WiFi Authentication"
           default WIFI_AUTH_WPA2_PSK
           config WIFI_AUTH_WPA2_PSK
               bool "WPA2-PSK"
           config WIFI_AUTH_WPA3_PSK
               bool "WPA3-PSK"
       endchoice
   endmenu
   
   menu "ROS Configuration"
       config MICRO_ROS_AGENT_IP
           string "Micro-ROS Agent IP"
           default "192.168.1.10"
       
       config MICRO_ROS_AGENT_PORT
           int "Micro-ROS Agent Port"
           range 1024 65535
           default 8888
   endmenu
   ```

3. **实现要点**
   - 优先从NVS读取，失败则使用CONFIG_XXX宏
   - 使用`CONFIG_WIFI_SSID`等宏作为默认值
   - 配置验证：SSID非空、端口范围1024-65535等
   - 首次运行时将sdkconfig默认值写入NVS

**验收标准**:
- [x] Menuconfig正常配置
- [x] 配置优先级正确（NVS > sdkconfig）
- [x] 配置验证生效
- [x] 默认值合理

---

### 4.3 任务10：运行时配置更新

**任务ID**: TASK-COMMON-010  
**优先级**: P1  
**估算时间**: 4小时  
**依赖任务**: [TASK-COMMON-008]

**功能描述**:
- 运行时修改配置
- 配置变更通知机制
- 热更新（部分配置无需重启）
- 配置备份和恢复

**技术实现细节**:

1. **关键函数**
   ```c
   /**
    * @brief 注册配置变更回调
    * @param[in] callback 回调函数
    * @param[in] user_data 用户数据
    * @return ESP_OK: 成功
    */
   esp_err_t config_register_callback(
       config_change_callback_t callback,
       void *user_data
   );
   
   /**
    * @brief 更新配置并通知
    * @param[in] key 配置键
    * @param[in] value 新值
    * @return ESP_OK: 成功
    */
   esp_err_t config_update_and_notify(const char *key, const char *value);
   ```

2. **数据结构**
   ```c
   /**
    * @brief 配置变更回调函数类型
    */
   typedef void (*config_change_callback_t)(
       const char *key,
       const char *old_value,
       const char *new_value,
       void *user_data
   );
   ```

3. **实现要点**
   - 使用回调链表管理多个监听者
   - 配置变更时遍历链表调用回调
   - 部分配置支持热更新（如日志级别）
   - 关键配置更新后提示重启（如WiFi SSID）

**验收标准**:
- [x] 配置更新正常
- [x] 回调函数正确执行
- [x] 热更新功能正常
- [x] 无内存泄漏

---

## 5. OLED显示模块

### 5.1 任务11：LVGL初始化和SSD1306驱动

**任务ID**: TASK-COMMON-011  
**优先级**: P1  
**估算时间**: 8小时  
**依赖任务**: 无

**功能描述**:
- 初始化LVGL图形库
- 配置SSD1306 OLED驱动
- 实现显示刷新机制
- 内存管理优化

**技术实现细节**:

1. **文件结构**
   - [`src/common/oled/oled_display.h`](src/common/oled/oled_display.h) - OLED显示接口
   - [`src/common/oled/oled_display.c`](src/common/oled/oled_display.c) - OLED显示实现
   - [`src/common/oled/lvgl_demo_ui.c`](src/common/oled/lvgl_demo_ui.c) - UI界面实现

2. **关键函数**
   ```c
   /**
    * @brief 初始化OLED显示
    * @return ESP_OK: 成功
    */
   esp_err_t oled_display_init(void);
   
   /**
    * @brief 清空显示
    * @return ESP_OK: 成功
    */
   esp_err_t oled_display_clear(void);
   
   /**
    * @brief 刷新显示
    * @return ESP_OK: 成功
    */
   esp_err_t oled_display_refresh(void);
   
   /**
    * @brief 设置背光（如果支持）
    * @param[in] on true=开, false=关
    * @return ESP_OK: 成功
    */
   esp_err_t oled_display_set_backlight(bool on);
   ```

3. **数据结构**
   ```c
   /**
    * @brief OLED配置
    */
   #define OLED_WIDTH      128
   #define OLED_HEIGHT     64
   #define OLED_I2C_ADDR   0x3C
   #define OLED_COLOR_DEPTH LV_COLOR_DEPTH_1  ///< 单色（1bpp）
   
   /**
    * @brief LVGL配置
    */
   #define LVGL_TICK_PERIOD_MS  10
   #define LVGL_BUFFER_SIZE     (OLED_WIDTH * OLED_HEIGHT / 8)
   ```

4. **实现要点**
   - 使用ESP-LVGL-Port组件管理LVGL
   - 配置SSD1306驱动（I2C地址0x3C，128x64分辨率）
   - 使用单缓冲模式节省内存
   - 创建LVGL定时器任务（10ms周期）
   - 正确设置Gap偏移（0,0）避免显示乱码
   - 使用`lv_disp_flush_ready()`标记刷新完成

**验收标准**:
- [x] OLED正常显示
- [x] 无显示乱码
- [x] 刷新流畅（>10fps）
- [x] 内存占用<30KB
- [x] 编译无警告

---

### 5.2 任务12：状态信息显示UI

**任务ID**: TASK-COMMON-012  
**优先级**: P1  
**估算时间**: 10小时  
**依赖任务**: [TASK-COMMON-011]

**功能描述**:
- 设计状态显示UI布局
- 显示WiFi连接状态
- 显示ROS连接状态
- 显示节点IP地址
- 显示系统运行时间

**技术实现细节**:

1. **关键函数**
   ```c
   /**
    * @brief 创建状态显示UI
    * @return ESP_OK: 成功
    */
   esp_err_t oled_ui_create_status_screen(void);
   
   /**
    * @brief 更新WiFi状态显示
    * @param[in] connected true=已连接
    * @param[in] rssi 信号强度（dBm）
    * @return ESP_OK: 成功
    */
   esp_err_t oled_ui_update_wifi_status(bool connected, int8_t rssi);
   
   /**
    * @brief 更新ROS状态显示
    * @param[in] connected true=已连接
    * @return ESP_OK: 成功
    */
   esp_err_t oled_ui_update_ros_status(bool connected);
   
   /**
    * @brief 更新IP地址显示
    * @param[in] ip_str IP地址字符串
    * @return ESP_OK: 成功
    */
   esp_err_t oled_ui_update_ip_address(const char *ip_str);
   
   /**
    * @brief 更新运行时间显示
    * @param[in] uptime_sec 运行时间（秒）
    * @return ESP_OK: 成功
    */
   esp_err_t oled_ui_update_uptime(uint32_t uptime_sec);
   ```

2. **UI布局设计**
   ```
   ┌────────────────────────┐
   │ NODE-01 Chassis        │  ← 节点标题
   ├────────────────────────┤
   │ WiFi: ✓ -65dBm         │  ← WiFi状态
   │ ROS:  ✓ Connected      │  ← ROS状态
   │ IP: 192.168.1.101      │  ← IP地址
   │ Up: 01:23:45           │  ← 运行时间
   └────────────────────────┘
   ```

3. **实现要点**
   - 使用`lv_label_create()`创建文本标签
   - 使用`lv_label_set_text()`更新文本内容
   - 使用单行显示节约空间
   - WiFi/ROS状态用"✓"和"✗"图标表示
   - 字体选择：6x8或8x12（内置单色字体）
   - 刷新频率：1Hz（降低CPU占用）

**验收标准**:
- [x] UI布局清晰美观
- [x] 状态信息准确显示
- [x] 更新流畅无闪烁
- [x] CPU占用<10%

---

### 5.3 任务13：自定义信息显示

**任务ID**: TASK-COMMON-013  
**优先级**: P2  
**估算时间**: 6小时  
**依赖任务**: [TASK-COMMON-012]

**功能描述**:
- 支持节点自定义显示内容
- 多屏切换功能
- 动态进度条显示
- 告警信息闪烁提示

**技术实现细节**:

1. **关键函数**
   ```c
   /**
    * @brief 显示自定义文本
    * @param[in] line 行号（0-3）
    * @param[in] text 文本内容
    * @return ESP_OK: 成功
    */
   esp_err_t oled_ui_show_custom_text(uint8_t line, const char *text);
   
   /**
    * @brief 显示进度条
    * @param[in] percentage 进度百分比（0-100）
    * @param[in] label 标签文本
    * @return ESP_OK: 成功
    */
   esp_err_t oled_ui_show_progress(uint8_t percentage, const char *label);
   
   /**
    * @brief 显示告警信息
    * @param[in] message 告警内容
    * @param[in] blink true=闪烁
    * @return ESP_OK: 成功
    */
   esp_err_t oled_ui_show_alert(const char *message, bool blink);
   
   /**
    * @brief 切换显示屏幕
    * @param[in] screen_id 屏幕ID
    * @return ESP_OK: 成功
    */
   esp_err_t oled_ui_switch_screen(uint8_t screen_id);
   ```

2. **实现要点**
   - 使用`lv_scr_load()`切换屏幕
   - 使用`lv_bar_create()`创建进度条
   - 使用`lv_anim_create()`实现闪烁动画
   - 预定义多个屏幕（状态、诊断、自定义）

**验收标准**:
- [x] 自定义显示正常
- [x] 多屏切换流畅
- [x] 进度条显示正确
- [x] 告警闪烁明显

---

## 6. 诊断服务模块

### 6.1 任务14：诊断消息发布

**任务ID**: TASK-COMMON-014  
**优先级**: P1  
**估算时间**: 6小时  
**依赖任务**: [TASK-COMMON-006]

**功能描述**:
- 创建诊断消息发布者
- 收集系统状态信息
- 定期发布诊断消息
- 支持自定义诊断项

**技术实现细节**:

1. **文件结构**
   - [`src/common/diagnostic/diagnostic.h`](src/common/diagnostic/diagnostic.h) - 诊断接口
   - [`src/common/diagnostic/diagnostic.c`](src/common/diagnostic/diagnostic.c) - 诊断实现

2. **关键函数**
   ```c
   /**
    * @brief 初始化诊断服务
    * @param[in] node_name 节点名称
    * @return ESP_OK: 成功
    */
   esp_err_t diagnostic_init(const char *node_name);
   
   /**
    * @brief 发布诊断消息
    * @param[in] level 诊断级别（OK/WARN/ERROR/STALE）
    * @param[in] message 状态描述
    * @return ESP_OK: 成功
    */
   esp_err_t diagnostic_publish(uint8_t level, const char *message);
   
   /**
    * @brief 添加诊断键值对
    * @param[in] key 键名
    * @param[in] value 值
    * @return ESP_OK: 成功
    */
   esp_err_t diagnostic_add_kv(const char *key, const char *value);
   
   /**
    * @brief 清空诊断键值对
    * @return ESP_OK: 成功
    */
   esp_err_t diagnostic_clear_kv(void);
   ```

3. **数据结构**
   ```c
   /**
    * @brief 诊断级别
    */
   #define DIAGNOSTIC_OK     0  ///< 正常
   #define DIAGNOSTIC_WARN   1  ///< 警告
   #define DIAGNOSTIC_ERROR  2  ///< 错误
   #define DIAGNOSTIC_STALE  3  ///< 数据过期
   
   /**
    * @brief 诊断数据
    */
   typedef struct {
       uint8_t level;
       char name[32];
       char message[128];
       char hardware_id[18];  ///< MAC地址
       struct {
           char key[32];
           char value[64];
       } kv[16];
       size_t kv_count;
   } diagnostic_data_t;
   ```

4. **实现要点**
   - 使用`diagnostic_msgs/msg/DiagnosticStatus`消息类型
   - 自动添加MAC地址作为`hardware_id`
   - 创建独立任务每秒发布一次诊断消息
   - 使用互斥锁保护键值对列表

**验收标准**:
- [x] 诊断消息正常发布
- [x] 键值对正确显示
- [x] MAC地址准确
- [x] 发布频率稳定（1Hz）

---

### 6.2 任务15：系统状态监控

**任务ID**: TASK-COMMON-015  
**优先级**: P1  
**估算时间**: 8小时  
**依赖任务**: [TASK-COMMON-014]

**功能描述**:
- 监控CPU使用率
- 监控内存使用情况
- 监控任务堆栈水位
- 监控WiFi信号强度
- 异常状态告警

**技术实现细节**:

1. **关键函数**
   ```c
   /**
    * @brief 获取CPU使用率
    * @return CPU使用率百分比（0-100）
    */
   uint8_t diagnostic_get_cpu_usage(void);
   
   /**
    * @brief 获取空闲堆内存
    * @return 空闲内存大小（字节）
    */
   uint32_t diagnostic_get_free_heap(void);
   
   /**
    * @brief 获取最小堆内存（历史最低）
    * @return 最小堆内存（字节）
    */
   uint32_t diagnostic_get_minimum_free_heap(void);
   
   /**
    * @brief 获取任务堆栈水位
    * @param[in] task_handle 任务句柄
    * @return 剩余堆栈大小（字节）
    */
   uint32_t diagnostic_get_task_high_water_mark(TaskHandle_t task_handle);
   
   /**
    * @brief 启动系统监控任务
    * @param[in] interval_ms 监控间隔（毫秒）
    * @return ESP_OK: 成功
    */
   esp_err_t diagnostic_start_monitor(uint32_t interval_ms);
   ```

2. **监控指标**
   ```c
   /**
    * @brief 系统监控阈值
    */
   #define CPU_USAGE_WARN_THRESHOLD       70  ///< CPU使用率警告阈值（%）
   #define FREE_HEAP_WARN_THRESHOLD       50  ///< 空闲堆内存警告阈值（KB）
   #define STACK_WARN_THRESHOLD           512 ///< 堆栈水位警告阈值（字节）
   #define WIFI_RSSI_WARN_THRESHOLD       -75 ///< WiFi信号警告阈值（dBm）
   ```

3. **实现要点**
   - 使用`esp_get_free_heap_size()`获取堆内存
   - 使用`uxTaskGetSystemState()`获取任务信息
   - 使用`vTaskGetRunTimeStats()`计算CPU使用率
   - 超过阈值时发布WARN级别诊断消息
   - 监控任务优先级设为最低（1）

**验收标准**:
- [x] 监控数据准确
- [x] 告警阈值生效
- [x] 监控任务稳定运行
- [x] CPU占用<5%

---

### 6.3 任务16：故障诊断和日志记录

**任务ID**: TASK-COMMON-016  
**优先级**: P2  
**估算时间**: 6小时  
**依赖任务**: [TASK-COMMON-014]

**功能描述**:
- 记录系统事件日志
- 捕获异常和错误
- 生成诊断报告
- 支持远程日志查看

**技术实现细节**:

1. **关键函数**
   ```c
   /**
    * @brief 记录事件日志
    * @param[in] level 日志级别
    * @param[in] tag 日志标签
    * @param[in] format 格式化字符串
    * @param[in] ... 可变参数
    */
   void diagnostic_log(esp_log_level_t level, const char *tag, 
                       const char *format, ...);
   
   /**
    * @brief 生成诊断报告
    * @param[out] report 报告缓冲区
    * @param[in] max_len 缓冲区大小
    * @return 实际写入字节数
    */
   size_t diagnostic_generate_report(char *report, size_t max_len);
   
   /**
    * @brief 注册异常处理器
    * @param[in] handler 异常处理函数
    * @return ESP_OK: 成功
    */
   esp_err_t diagnostic_register_exception_handler(
       diagnostic_exception_handler_t handler
   );
   ```

2. **实现要点**
   - 重定向ESP_LOGx宏到诊断日志
   - 使用环形缓冲区存储最近100条日志
   - 异常时自动生成报告
   - 报告包含：系统状态、日志历史、堆栈跟踪

**验收标准**:
- [x] 日志记录正常
- [x] 诊断报告完整
- [x] 异常捕获准确
- [x] 无内存泄漏

---

## 7. 依赖关系图

### 7.1 模块间依赖关系（DAG图）

```
初始化顺序（从上到下）：

1. NVS初始化 (config_manager_init)
   ↓
2. 配置加载 (config_load)
   ↓
3. WiFi初始化 (wifi_manager_init)
   ↓
4. WiFi连接 (wifi_manager_connect)
   ↓
   ├─→ 5a. OLED初始化 (oled_display_init) [可选]
   │   └─→ 5b. 状态UI创建 (oled_ui_create_status_screen)
   │
   └─→ 6a. ROS通信初始化 (ros_comm_init)
       ├─→ 6b. UDP传输层配置
       └─→ 6c. ROS节点创建
           └─→ 7. 诊断服务初始化 (diagnostic_init)
               └─→ 8. 系统监控启动 (diagnostic_start_monitor)
```

### 7.2 任务依赖关系矩阵

| 任务ID | 任务名称 | 依赖任务 | 可并行任务 |
|--------|---------|---------|-----------|
| TASK-COMMON-001 | WiFi初始化和连接 | 无 | TASK-COMMON-008 |
| TASK-COMMON-002 | WiFi断线重连 | 001 | 003, 008 |
| TASK-COMMON-003 | WiFi状态监控 | 001 | 002, 008 |
| TASK-COMMON-004 | Micro-ROS初始化 | 001 | 008, 011 |
| TASK-COMMON-005 | UDP传输层实现 | 004 | 006, 007 |
| TASK-COMMON-006 | 发布者订阅者管理 | 004 | 007, 014 |
| TASK-COMMON-007 | 服务调用封装 | 004 | 006 |
| TASK-COMMON-008 | NVS存储读写 | 无 | 001, 011 |
| TASK-COMMON-009 | Menuconfig集成 | 008 | 010 |
| TASK-COMMON-010 | 运行时配置更新 | 008 | 009 |
| TASK-COMMON-011 | LVGL和SSD1306驱动 | 无 | 001, 008 |
| TASK-COMMON-012 | 状态信息显示UI | 011 | 013 |
| TASK-COMMON-013 | 自定义信息显示 | 012 | - |
| TASK-COMMON-014 | 诊断消息发布 | 006 | 015, 016 |
| TASK-COMMON-015 | 系统状态监控 | 014 | 016 |
| TASK-COMMON-016 | 故障诊断日志 | 014 | 015 |

### 7.3 开发里程碑

**阶段1：基础通信（2周）**
- 完成WiFi管理模块（TASK-001~003）
- 完成配置管理模块（TASK-008~009）
- 目标：节点能够连接WiFi并持久化配置

**阶段2：ROS通信（2周）**
- 完成ROS通信模块（TASK-004~007）
- 目标：节点能够与ROS Agent通信

**阶段3：可视化和诊断（1.5周）**
- 完成OLED显示模块（TASK-011~012）
- 完成诊断服务模块（TASK-014~015）
- 目标：节点能够显示状态并发布诊断信息

**阶段4：增强功能（1周）**
- 完成运行时配置更新（TASK-010）
- 完成自定义显示（TASK-013）
- 完成故障诊断（TASK-016）
- 目标：系统功能完善，易于维护

**总计：6.5周（约1.5个月）**

---

## 附录A：代码规范参考

所有代码必须符合[`开发规范.md`](开发架构文档/开发规范.md)，关键要点：
- 函数命名：`module_action_object()`格式
- 错误处理：统一使用`esp_err_t`
- 日志输出：使用`ESP_LOGI`/`ESP_LOGE`，标签为模块名
- 线程安全：使用互斥锁保护共享资源
- 内存管理：优先静态分配，动态分配后必须释放
- 注释规范：使用Doxygen风格注释

---

## 附录B：测试要求

每个任务完成后必须通过以下测试：

1. **编译测试**
   - 无编译错误
   - 无编译警告
   - 代码大小<规定限制

2. **单元测试**
   - 函数功能正确
   - 边界条件处理
   - 错误处理验证

3. **集成测试**
   - 模块间接口正常
   - 数据流正确
   - 性能达标

4. **压力测试**
   - 长时间运行稳定（>72小时）
   - 内存无泄漏
   - CPU占用合理

---

## 附录C：参考资源

- ESP-IDF编程指南: https://docs.espressif.com/projects/esp-idf/zh_CN/latest/
- Micro-ROS文档: https://micro.ros.org/docs/
- LVGL文档: https://docs.lvgl.io/8.3/
- ROS 2 Humble文档: https://docs.ros.org/en/humble/

---

**文档结束**

**编写人**：架构设计组  
**审核人**：技术负责人  
**版本**：v1.0.0  
**日期**：2025-10-23