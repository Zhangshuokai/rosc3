# 建筑喷涂施工机器人代码结构规范

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档标题** | 代码结构规范文档 |
| **文档版本** | v1.0.0 |
| **编制日期** | 2025-10-23 |
| **开发工具** | VS Code + PlatformIO |
| **构建系统** | ESP-IDF + CMake |
| **适用范围** | 所有ESP32-C3节点代码 |

---

## 目录

- [1. 项目目录结构](#1-项目目录结构)
- [2. 多节点代码组织](#2-多节点代码组织)
- [3. 源文件组织规范](#3-源文件组织规范)
- [4. 文件命名规范](#4-文件命名规范)
- [5. 通用库设计](#5-通用库设计)
- [6. 配置文件管理](#6-配置文件管理)
- [7. 文档组织规范](#7-文档组织规范)

---

## 1. 项目目录结构

### 1.1 完整项目结构

```
rosc3/                                  # 项目根目录
├── .vscode/                            # VS Code配置
│   ├── settings.json                   # 编辑器设置
│   ├── c_cpp_properties.json           # C/C++配置
│   └── launch.json                     # 调试配置
│
├── platformio.ini                      # PlatformIO主配置
├── CMakeLists.txt                      # 根CMake配置
├── sdkconfig.defaults                  # ESP-IDF默认配置
├── .gitignore                          # Git忽略文件
├── README.md                           # 项目说明
│
├── include/                            # 全局头文件
│   ├── lv_conf.h                       # LVGL配置
│   └── common/                         # 通用头文件
│       ├── common_types.h              # 通用类型定义
│       ├── common_config.h             # 通用配置
│       └── common_macros.h             # 通用宏定义
│
├── src/                                # 源代码目录
│   ├── main.c                          # 主程序（节点选择入口）
│   ├── CMakeLists.txt                  # 源代码CMake配置
│   ├── idf_component.yml               # ESP-IDF组件依赖
│   │
│   ├── common/                         # 通用模块（所有节点共享）
│   │   ├── wifi_manager/               # WiFi管理模块
│   │   │   ├── wifi_manager.h
│   │   │   └── wifi_manager.c
│   │   ├── ros_comm/                   # ROS通信模块
│   │   │   ├── ros_comm.h
│   │   │   ├── ros_comm.c
│   │   │   └── micro_ros_transport.c  # UDP传输层
│   │   ├── config/                     # 配置管理模块
│   │   │   ├── config_manager.h
│   │   │   └── config_manager.c
│   │   ├── oled/                       # OLED显示模块
│   │   │   ├── oled_display.h
│   │   │   ├── oled_display.c
│   │   │   └── lvgl_demo_ui.c
│   │   ├── diagnostic/                 # 诊断模块
│   │   │   ├── diagnostic.h
│   │   │   └── diagnostic.c
│   │   └── logger/                     # 日志模块
│   │       ├── logger.h
│   │       └── logger.c
│   │
│   ├── nodes/                          # 节点专用代码
│   │   ├── chassis/                    # NODE-01: 底盘控制节点
│   │   │   ├── chassis_node.h
│   │   │   ├── chassis_node.c          # 节点主逻辑
│   │   │   ├── chassis_control.h       # 控制算法
│   │   │   ├── chassis_control.c
│   │   │   ├── motor_driver.h          # 电机驱动
│   │   │   ├── motor_driver.c
│   │   │   └── odometry.c              # 里程计计算
│   │   │
│   │   ├── lift/                       # NODE-02: 升降机构节点
│   │   │   ├── lift_node.h
│   │   │   ├── lift_node.c
│   │   │   ├── lift_control.h
│   │   │   ├── lift_control.c
│   │   │   └── servo_driver.c
│   │   │
│   │   ├── environment/                # NODE-03: 环境监测节点
│   │   │   ├── environment_node.h
│   │   │   ├── environment_node.c
│   │   │   └── bme280_driver.c
│   │   │
│   │   ├── spray/                      # NODE-04: 喷涂监控节点
│   │   │   ├── spray_node.h
│   │   │   ├── spray_node.c
│   │   │   └── adc_sensors.c
│   │   │
│   │   ├── range/                      # NODE-05: 距离测量节点
│   │   │   ├── range_node.h
│   │   │   ├── range_node.c
│   │   │   └── vl53l0x_driver.c
│   │   │
│   │   ├── imu/                        # NODE-06: IMU姿态节点
│   │   │   ├── imu_node.h
│   │   │   ├── imu_node.c
│   │   │   └── mpu6050_driver.c
│   │   │
│   │   └── power/                      # NODE-07: 电源管理节点
│   │       ├── power_node.h
│   │       ├── power_node.c
│   │       └── battery_monitor.c
│   │
│   └── drivers/                        # 硬件驱动层
│       ├── i2c_bus/                    # I2C总线管理
│       │   ├── i2c_bus.h
│       │   └── i2c_bus.c
│       ├── sensors/                    # 传感器驱动
│       │   ├── bme280/
│       │   ├── mpu6050/
│       │   ├── as5600/
│       │   └── vl53l0x/
│       └── actuators/                  # 执行器驱动
│           ├── pwm_motor/
│           └── servo/
│
├── lib/                                # 外部库（PlatformIO管理）
│
├── test/                               # 测试代码
│   ├── unit/                           # 单元测试
│   │   ├── test_wifi_manager.c
│   │   ├── test_chassis_control.c
│   │   └── ...
│   └── integration/                    # 集成测试
│       └── test_ros_comm.c
│
├── docs/                               # 项目文档
│   ├── HARDWARE_CONNECTION.md
│   ├── PLATFORMIO_ARCHITECTURE_DESIGN.md
│   └── PROJECT_STATUS.md
│
├── 需求分析/                           # 需求文档
│   ├── README.md
│   ├── 项目需求规格说明书.md
│   ├── ROS接口定义文档.md
│   ├── 功能需求清单.md
│   └── Menuconfig配置项说明.md
│
├── 开发架构文档/                       # 架构文档
│   ├── README.md
│   ├── 系统架构设计.md
│   ├── 软件架构设计.md
│   ├── 代码结构规范.md                 # 本文档
│   ├── 开发规范.md
│   ├── 测试规范.md
│   └── 版本管理规范.md
│
├── scripts/                            # 构建脚本
│   ├── build_all_nodes.sh              # 构建所有节点
│   ├── flash_node.sh                   # 烧录指定节点
│   └── generate_config.py              # 配置生成脚本
│
└── managed_components/                 # ESP-IDF管理的组件（自动生成）
    ├── espressif__esp_lcd_sh1107/
    ├── espressif__esp_lvgl_port/
    └── lvgl__lvgl/
```

### 1.2 目录职责说明

| 目录 | 职责 | 修改频率 | 版本控制 |
|------|------|---------|---------|
| `src/common/` | 所有节点共享的通用模块 | 中 | ✅ |
| `src/nodes/` | 各节点专用代码 | 高 | ✅ |
| `src/drivers/` | 硬件驱动层 | 低 | ✅ |
| `include/` | 全局头文件 | 低 | ✅ |
| `test/` | 测试代码 | 中 | ✅ |
| `docs/` | 技术文档 | 中 | ✅ |
| `需求分析/` | 需求文档 | 低 | ✅ |
| `开发架构文档/` | 架构文档 | 低 | ✅ |
| `scripts/` | 构建脚本 | 低 | ✅ |
| `managed_components/` | 自动管理组件 | - | ❌ (忽略) |
| `.pio/` | PlatformIO缓存 | - | ❌ (忽略) |

---

## 2. 多节点代码组织

### 2.1 节点代码隔离

每个节点的代码完全独立，放在 `src/nodes/<node_name>/` 目录下：

```
src/nodes/
├── chassis/          # 底盘节点独立代码
├── lift/             # 升降节点独立代码
├── environment/      # 环境节点独立代码
├── spray/            # 喷涂节点独立代码
├── range/            # 距离节点独立代码
├── imu/              # IMU节点独立代码
└── power/            # 电源节点独立代码
```

**设计原则**：
- ✅ 节点间零耦合，互不依赖
- ✅ 仅依赖 `src/common/` 通用模块
- ✅ 便于并行开发和测试
- ✅ 单个节点代码可独立编译

### 2.2 节点编译配置

#### PlatformIO多环境配置

```ini
; platformio.ini

[env:chassis_node]
platform = espressif32
board = adafruit_qtpy_esp32c3
framework = espidf
build_flags = 
    -D NODE_TYPE=NODE_CHASSIS
    -D NODE_ID=1
build_src_filter = 
    +<common/>
    +<nodes/chassis/>
    +<drivers/>
    -<nodes/lift/>
    -<nodes/environment/>
    ; ... 排除其他节点

[env:lift_node]
platform = espressif32
board = adafruit_qtpy_esp32c3
framework = espidf
build_flags = 
    -D NODE_TYPE=NODE_LIFT
    -D NODE_ID=2
build_src_filter = 
    +<common/>
    +<nodes/lift/>
    +<drivers/>
    -<nodes/chassis/>
    ; ... 排除其他节点

; ... 其他节点类似配置
```

### 2.3 节点主程序入口

#### 方案A：编译时选择（推荐）

```c
// src/main.c
#include "common/wifi_manager/wifi_manager.h"
#include "common/ros_comm/ros_comm.h"

#if defined(NODE_TYPE) && NODE_TYPE == NODE_CHASSIS
    #include "nodes/chassis/chassis_node.h"
    #define node_main chassis_node_main
#elif defined(NODE_TYPE) && NODE_TYPE == NODE_LIFT
    #include "nodes/lift/lift_node.h"
    #define node_main lift_node_main
#elif defined(NODE_TYPE) && NODE_TYPE == NODE_ENVIRONMENT
    #include "nodes/environment/environment_node.h"
    #define node_main environment_node_main
// ... 其他节点
#else
    #error "NODE_TYPE not defined or invalid"
#endif

void app_main(void) {
    // 通用初始化
    wifi_manager_init();
    ros_comm_init();
    
    // 调用节点专用主函数
    node_main();
}
```

#### 方案B：运行时选择（灵活但增加体积）

```c
// src/main.c
void app_main(void) {
    uint8_t node_type = config_get_node_type(); // 从NVS读取
    
    switch (node_type) {
        case NODE_CHASSIS:
            chassis_node_main();
            break;
        case NODE_LIFT:
            lift_node_main();
            break;
        // ...
        default:
            ESP_LOGE(TAG, "Unknown node type");
    }
}
```

**推荐使用方案A**：
- ✅ 编译时确定，代码体积小
- ✅ 编译错误早发现
- ✅ 便于优化

---

## 3. 源文件组织规范

### 3.1 典型节点文件组织

以底盘控制节点为例：

```
src/nodes/chassis/
├── chassis_node.h          # 节点主头文件（对外接口）
├── chassis_node.c          # 节点主逻辑
├── chassis_control.h       # 控制算法接口
├── chassis_control.c       # 控制算法实现
├── motor_driver.h          # 电机驱动接口
├── motor_driver.c          # 电机驱动实现
├── odometry.h              # 里程计接口
├── odometry.c              # 里程计实现
└── README.md               # 节点说明文档
```

### 3.2 文件内容组织模板

#### 头文件模板（.h）

```c
/**
 * @file chassis_node.h
 * @brief 底盘控制节点主接口
 * @version 1.0
 * @date 2025-10-23
 * @author 嵌入式开发组
 * 
 * 本文件定义底盘控制节点的对外接口
 */

#ifndef CHASSIS_NODE_H
#define CHASSIS_NODE_H

#ifdef __cplusplus
extern "C" {
#endif

/*******************************************************************************
 * 头文件包含
 ******************************************************************************/
#include <stdint.h>
#include <stdbool.h>
#include "esp_err.h"

/*******************************************************************************
 * 宏定义
 ******************************************************************************/
#define CHASSIS_MAX_SPEED_MPS   1.0f    ///< 最大线速度(m/s)
#define CHASSIS_MAX_OMEGA_RPS   2.0f    ///< 最大角速度(rad/s)

/*******************************************************************************
 * 类型定义
 ******************************************************************************/

/**
 * @brief 底盘速度指令
 */
typedef struct {
    float linear_velocity;  ///< 线速度(m/s)
    float angular_velocity; ///< 角速度(rad/s)
} chassis_cmd_vel_t;

/**
 * @brief 底盘状态
 */
typedef struct {
    float x;                ///< X坐标(m)
    float y;                ///< Y坐标(m)
    float theta;            ///< 姿态角(rad)
    float v_linear;         ///< 当前线速度(m/s)
    float v_angular;        ///< 当前角速度(rad/s)
} chassis_state_t;

/*******************************************************************************
 * 全局函数声明
 ******************************************************************************/

/**
 * @brief 初始化底盘节点
 * @return 
 *   - ESP_OK: 成功
 *   - ESP_FAIL: 失败
 */
esp_err_t chassis_node_init(void);

/**
 * @brief 底盘节点主函数（不返回）
 */
void chassis_node_main(void);

/**
 * @brief 设置速度指令
 * @param cmd 速度指令
 * @return 
 *   - ESP_OK: 成功
 *   - ESP_ERR_INVALID_ARG: 参数无效
 */
esp_err_t chassis_set_velocity(const chassis_cmd_vel_t *cmd);

/**
 * @brief 获取底盘状态
 * @param state 状态输出
 * @return 
 *   - ESP_OK: 成功
 */
esp_err_t chassis_get_state(chassis_state_t *state);

#ifdef __cplusplus
}
#endif

#endif /* CHASSIS_NODE_H */
```

#### 源文件模板（.c）

```c
/**
 * @file chassis_node.c
 * @brief 底盘控制节点实现
 */

/*******************************************************************************
 * 头文件包含
 ******************************************************************************/
#include "chassis_node.h"
#include "chassis_control.h"
#include "motor_driver.h"
#include "odometry.h"

#include "common/wifi_manager/wifi_manager.h"
#include "common/ros_comm/ros_comm.h"
#include "common/logger/logger.h"

#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "esp_log.h"

/*******************************************************************************
 * 本地宏定义
 ******************************************************************************/
#define TAG "CHASSIS_NODE"
#define CONTROL_TASK_PRIORITY   10
#define CONTROL_TASK_STACK_SIZE 4096

/*******************************************************************************
 * 本地类型定义
 ******************************************************************************/
// （如有需要）

/*******************************************************************************
 * 本地函数声明
 ******************************************************************************/
static void control_task(void *pvParameters);
static void ros_cmd_vel_callback(const void *msg);

/*******************************************************************************
 * 本地变量
 ******************************************************************************/
static chassis_state_t g_chassis_state = {0};
static chassis_cmd_vel_t g_cmd_vel = {0};

/*******************************************************************************
 * 全局函数实现
 ******************************************************************************/

esp_err_t chassis_node_init(void) {
    ESP_LOGI(TAG, "Initializing chassis node...");
    
    // 初始化电机驱动
    ESP_ERROR_CHECK(motor_driver_init());
    
    // 初始化里程计
    ESP_ERROR_CHECK(odometry_init());
    
    ESP_LOGI(TAG, "Chassis node initialized successfully");
    return ESP_OK;
}

void chassis_node_main(void) {
    // 初始化节点
    chassis_node_init();
    
    // 创建控制任务
    xTaskCreate(control_task, "chassis_ctrl", 
                CONTROL_TASK_STACK_SIZE, NULL, 
                CONTROL_TASK_PRIORITY, NULL);
    
    // 主循环（或删除此函数，仅由任务运行）
    while (1) {
        vTaskDelay(pdMS_TO_TICKS(1000));
    }
}

/*******************************************************************************
 * 本地函数实现
 ******************************************************************************/

static void control_task(void *pvParameters) {
    TickType_t last_wake_time = xTaskGetTickCount();
    const TickType_t frequency = pdMS_TO_TICKS(20); // 50Hz
    
    while (1) {
        // 1. 更新里程计
        odometry_update(&g_chassis_state);
        
        // 2. 执行PID控制
        chassis_pid_control(&g_cmd_vel);
        
        // 3. 发布ROS消息
        chassis_publish_odom(&g_chassis_state);
        
        // 4. 等待下一个周期
        vTaskDelayUntil(&last_wake_time, frequency);
    }
}

static void ros_cmd_vel_callback(const void *msg) {
    // 解析ROS消息
    // 更新g_cmd_vel
}
```

### 3.3 CMakeLists.txt组织

```cmake
# src/CMakeLists.txt

# 定义组件源文件
idf_component_register(
    SRCS 
        # 主程序
        "main.c"
        
        # 通用模块（所有节点都包含）
        "common/wifi_manager/wifi_manager.c"
        "common/ros_comm/ros_comm.c"
        "common/ros_comm/micro_ros_transport.c"
        "common/config/config_manager.c"
        "common/oled/oled_display.c"
        "common/oled/lvgl_demo_ui.c"
        "common/diagnostic/diagnostic.c"
        "common/logger/logger.c"
        
        # 驱动层
        "drivers/i2c_bus/i2c_bus.c"
        
        # 节点专用代码（根据NODE_TYPE条件编译）
        $<$<STREQUAL:${NODE_TYPE},chassis>:
            nodes/chassis/chassis_node.c
            nodes/chassis/chassis_control.c
            nodes/chassis/motor_driver.c
            nodes/chassis/odometry.c
            drivers/actuators/pwm_motor/pwm_motor.c
        >
        
        $<$<STREQUAL:${NODE_TYPE},lift>:
            nodes/lift/lift_node.c
            nodes/lift/lift_control.c
            nodes/lift/servo_driver.c
            drivers/sensors/as5600/as5600.c
        >
        
        # ... 其他节点
        
    INCLUDE_DIRS 
        "."
        "../include"
        "common"
        "nodes"
        "drivers"
)
```

---

## 4. 文件命名规范

### 4.1 源文件命名

| 文件类型 | 命名规则 | 示例 | 说明 |
|---------|---------|------|------|
| C源文件 | `<module>_<功能>.c` | `wifi_manager.c` | 全小写，下划线分隔 |
| C头文件 | `<module>_<功能>.h` | `wifi_manager.h` | 与源文件同名 |
| 节点主文件 | `<node>_node.c/h` | `chassis_node.c` | 明确标识为节点 |
| 驱动文件 | `<设备>_driver.c/h` | `bme280_driver.c` | 明确标识为驱动 |
| 测试文件 | `test_<module>.c` | `test_wifi_manager.c` | test_前缀 |

### 4.2 目录命名

| 目录类型 | 命名规则 | 示例 |
|---------|---------|------|
| 模块目录 | 小写，下划线 | `wifi_manager/` |
| 节点目录 | 小写，无下划线（简短） | `chassis/`, `lift/` |
| 驱动目录 | 设备型号小写 | `bme280/`, `mpu6050/` |

### 4.3 不推荐的命名

| ❌ 不推荐 | ✅ 推荐 | 原因 |
|---------|--------|------|
| `WiFiManager.c` | `wifi_manager.c` | C语言惯例用小写 |
| `chassis.c` | `chassis_node.c` | 不清晰 |
| `driver.c` | `bme280_driver.c` | 太泛化 |
| `test1.c` | `test_chassis_control.c` | 无意义命名 |

---

## 5. 通用库设计

### 5.1 通用模块清单

| 模块 | 路径 | 功能 | 依赖节点 |
|------|------|------|---------|
| WiFi管理 | `src/common/wifi_manager/` | WiFi连接、重连、状态监控 | 全部 |
| ROS通信 | `src/common/ros_comm/` | Micro-ROS封装、UDP传输 | 全部 |
| 配置管理 | `src/common/config/` | NVS读写、配置加载 | 全部 |
| OLED显示 | `src/common/oled/` | LVGL显示、UI更新 | 全部 |
| 诊断服务 | `src/common/diagnostic/` | 诊断数据发布 | 全部 |
| 日志模块 | `src/common/logger/` | 统一日志接口 | 全部 |

### 5.2 通用模块接口设计原则

#### 原则1：接口最小化

```c
// ✅ 好的设计：接口简洁明了
esp_err_t wifi_manager_init(const wifi_config_t *config);
esp_err_t wifi_manager_connect(void);
esp_err_t wifi_manager_disconnect(void);
wifi_state_t wifi_manager_get_state(void);

// ❌ 不好的设计：接口过于复杂
esp_err_t wifi_manager_init_and_connect_with_retry_and_callback(...);
```

#### 原则2：无状态或明确状态

```c
// ✅ 明确的状态管理
typedef struct {
    wifi_state_t state;
    int8_t rssi;
    ip4_addr_t ip;
} wifi_status_t;

wifi_status_t wifi_manager_get_status(void);

// ❌ 隐式状态，难以调试
int wifi_get_rssi(void); // 何时有效？
```

#### 原则3：错误处理一致性

```c
// ✅ 统一使用esp_err_t
esp_err_t module_init(void);
esp_err_t module_operation(void);

// 检查
ESP_ERROR_CHECK(module_init());

// 或
esp_err_t ret = module_init();
if (ret != ESP_OK) {
    ESP_LOGE(TAG, "Init failed: %s", esp_err_to_name(ret));
}
```

### 5.3 通用数据结构

#### 通用配置结构（common_config.h）

```c
/**
 * @file common_config.h
 * @brief 通用配置数据结构
 */

#ifndef COMMON_CONFIG_H
#define COMMON_CONFIG_H

#include <stdint.h>
#include "esp_wifi_types.h"

/**
 * @brief 通用节点配置
 */
typedef struct {
    // WiFi配置
    char wifi_ssid[32];
    char wifi_password[64];
    wifi_auth_mode_t wifi_auth_mode;
    uint8_t wifi_max_retry;
    
    // ROS配置
    char ros_agent_ip[16];
    uint16_t ros_agent_port;
    char ros_node_name[32];
    char ros_namespace[32];
    uint8_t ros_domain_id;
    
    // 系统配置
    uint8_t log_level;
    bool oled_enable;
} common_config_t;

#endif /* COMMON_CONFIG_H */
```

#### 通用类型定义（common_types.h）

```c
/**
 * @file common_types.h
 * @brief 通用类型定义
 */

#ifndef COMMON_TYPES_H
#define COMMON_TYPES_H

#include <stdint.h>
#include <stdbool.h>

/**
 * @brief 节点类型枚举
 */
typedef enum {
    NODE_TYPE_CHASSIS = 1,
    NODE_TYPE_LIFT = 2,
    NODE_TYPE_ENVIRONMENT = 3,
    NODE_TYPE_SPRAY = 4,
    NODE_TYPE_RANGE = 5,
    NODE_TYPE_IMU = 6,
    NODE_TYPE_POWER = 7
} node_type_t;

/**
 * @brief 节点状态枚举
 */
typedef enum {
    NODE_STATE_INIT,
    NODE_STATE_WIFI_CONNECTING,
    NODE_STATE_WIFI_CONNECTED,
    NODE_STATE_ROS_CONNECTING,
    NODE_STATE_RUNNING,
    NODE_STATE_ERROR,
    NODE_STATE_RECOVERY
} node_state_t;

#endif /* COMMON_TYPES_H */
```

---

## 6. 配置文件管理

### 6.1 配置文件层次

```
配置优先级（高→低）：
1. NVS存储（运行时修改）
2. sdkconfig.defaults（项目默认）
3. Kconfig.projbuild（用户可配置）
4. 代码硬编码（最后手段）
```

### 6.2 Kconfig配置

```kconfig
# src/main/Kconfig.projbuild

menu "Node Configuration"
    
    choice NODE_TYPE
        prompt "Node Type"
        default NODE_TYPE_CHASSIS
        help
            Select the type of this node
        
        config NODE_TYPE_CHASSIS
            bool "Chassis Control Node"
        config NODE_TYPE_LIFT
            bool "Lift Control Node"
        # ... 其他节点
    endchoice
    
    config NODE_ID
        int "Node ID"
        range 1 10
        default 1
        help
            Unique identifier for this node (1-10)

endmenu

menu "WiFi Configuration"
    
    config WIFI_SSID
        string "WiFi SSID"
        default ""
        help
            SSID of WiFi network
    
    config WIFI_PASSWORD
        string "WiFi Password"
        default ""
        help
            Password of WiFi network
    
    choice WIFI_ENCRYPTION
        prompt "WiFi Encryption"
        default WIFI_ENCRYPTION_WPA2_PSK
        
        config WIFI_ENCRYPTION_WPA2_PSK
            bool "WPA2-PSK"
        config WIFI_ENCRYPTION_WPA3_PSK
            bool "WPA3-PSK"
        config WIFI_ENCRYPTION_OPEN
            bool "OPEN"
    endchoice

endmenu

menu "ROS Configuration"
    
    config MICRO_ROS_AGENT_IP
        string "Micro-ROS Agent IP"
        default "192.168.1.10"
        help
            IP address of Micro-ROS Agent
    
    config MICRO_ROS_AGENT_PORT
        int "Micro-ROS Agent Port"
        range 1024 65535
        default 8888
        help
            UDP port of Micro-ROS Agent

endmenu
```

### 6.3 sdkconfig.defaults

```ini
# sdkconfig.defaults

# 节点类型（编译时确定）
CONFIG_NODE_TYPE_CHASSIS=y
CONFIG_NODE_ID=1

# WiFi配置（可被NVS覆盖）
CONFIG_WIFI_SSID="MyNetwork"
CONFIG_WIFI_PASSWORD="MyPassword"
CONFIG_WIFI_ENCRYPTION_WPA2_PSK=y

# ROS配置
CONFIG_MICRO_ROS_AGENT_IP="192.168.1.10"
CONFIG_MICRO_ROS_AGENT_PORT=8888

# 系统配置
CONFIG_LOG_DEFAULT_LEVEL_INFO=y
CONFIG_FREERTOS_HZ=1000

# LVGL配置
CONFIG_LV_COLOR_DEPTH_1=y
CONFIG_LV_USE_USER_DATA=y
```

---

## 7. 文档组织规范

### 7.1 README文件

每个模块/节点应包含README.md：

```markdown
# 底盘控制节点 (Chassis Node)

## 功能概述

管理差速移动底盘，包括：
- 电机PWM控制
- 编码器读取
- 里程计计算
- PID速度闭环

## 硬件接口

| GPIO | 功能 | 连接设备 |
|------|------|---------|
| GPIO0 | PWM | 左电机 |
| GPIO1 | PWM | 右电机 |
| GPIO8-9 | I2C | 编码器 |

## ROS接口

**订阅**：
- `/chassis/cmd_vel` (geometry_msgs/Twist)

**发布**：
- `/chassis/odom` (nav_msgs/Odometry) @ 50Hz

## 配置参数

- `CHASSIS_WHEEL_BASE`: 轮距(m)
- `CHASSIS_WHEEL_DIAMETER`: 轮径(m)
- `CHASSIS_PID_KP/KI/KD`: PID参数

## 编译与烧录

```bash
# 选择环境
pio run -e chassis_node

# 烧录
pio run -e chassis_node -t upload
```

## 依赖

- `src/common/wifi_manager`
- `src/common/ros_comm`
- `src/drivers/actuators/pwm_motor`
```

### 7.2 代码内文档

使用Doxygen风格注释：

```c
/**
 * @brief 计算里程计
 * 
 * 根据左右轮编码器增量计算机器人位姿变化
 * 
 * @param[in]  encoder_left  左轮编码器值
 * @param[in]  encoder_right 右轮编码器值
 * @param[out] pose          输出位姿
 * 
 * @return 
 *   - ESP_OK: 成功
 *   - ESP_ERR_INVALID_ARG: 参数无效
 * 
 * @note 此函数应以50Hz频率调用
 * @warning 编码器值不能超过UINT32_MAX
 */
esp_err_t odometry_calculate(uint32_t encoder_left, 
                              uint32_t encoder_right,
                              pose_2d_t *pose);
```

---

## 附录

### A. .gitignore推荐配置

```gitignore
# PlatformIO
.pio/
.vscode/.browse.c_cpp.db*
.vscode/c_cpp_properties.json
.vscode/launch.json
.vscode/ipch

# ESP-IDF
build/
sdkconfig
sdkconfig.old
managed_components/

# 编译输出
*.o
*.a
*.bin
*.elf
*.map

# 日志
*.log

# OS
.DS_Store
Thumbs.db

# IDE
*.swp
*.swo
*~
.idea/
```

### B. 模块依赖关系图

```
应用层(nodes/)
    ↓ 依赖
服务层(common/)
    ↓ 依赖
驱动层(drivers/)
    ↓ 依赖
HAL层(ESP-IDF)
```

**规则**：
- ✅ 上层可依赖下层
- ❌ 下层不得依赖上层
- ❌ 同层模块互不依赖（除非明确设计）

---

**文档结束**

**编写人**：架构师  
**审核人**：技术负责人  
**版本**：v1.0.0  
**日期**：2025-10-23