# 建筑喷涂施工机器人系统架构设计

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档标题** | 系统架构设计文档 |
| **文档版本** | v1.0.0 |
| **编制日期** | 2025-10-23 |
| **硬件平台** | Adafruit QT Py ESP32-C3 × 7 |
| **系统架构** | 分布式单一职责节点架构 |
| **通信协议** | ROS 2 Humble + Micro-ROS |

---

## 目录

- [1. 系统架构概述](#1-系统架构概述)
- [2. 分布式节点架构](#2-分布式节点架构)
- [3. 硬件接口资源分配](#3-硬件接口资源分配)
- [4. 通信架构设计](#4-通信架构设计)
- [5. 系统性能设计](#5-系统性能设计)
- [6. 安全与可靠性设计](#6-安全与可靠性设计)
- [7. 扩展性设计](#7-扩展性设计)

---

## 1. 系统架构概述

### 1.1 设计理念

本系统采用**分布式单一职责**架构，核心设计理念：

- **单一职责原则（SRP）**：每个ESP32-C3节点只管理一类传感器或执行器
- **故障隔离**：单节点故障不影响整个系统运行
- **负载均衡**：多节点分担计算和通信压力
- **易于维护**：模块化设计便于替换和升级
- **并行开发**：不同节点可由不同工程师同时开发

### 1.2 系统拓扑

```
┌─────────────────────────────────────────────────────────────┐
│                    上位机工控机                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  ROS 2 Humble + Micro-ROS Agent (UDP:8888)          │   │
│  │  - 任务规划  - 路径导航  - 数据记录  - 人机界面    │   │
│  └──────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────┘
                         │ WiFi (2.4GHz)
                         │ 192.168.1.x
         ┌───────────────┼───────────────┐
         │               │               │
    ┌────▼────┐    ┌────▼────┐    ┌────▼────┐
    │ NODE-01 │    │ NODE-02 │    │ NODE-03 │
    │底盘控制│    │升降机构│    │环境监测│
    └─────────┘    └─────────┘    └─────────┘
         │               │               │
    ┌────▼────┐    ┌────▼────┐    ┌────▼────┐
    │ NODE-04 │    │ NODE-05 │    │ NODE-06 │
    │喷涂监控│    │距离测量│    │IMU姿态 │
    └─────────┘    └─────────┘    └─────────┘
         │
    ┌────▼────┐
    │ NODE-07 │
    │电源管理│
    └─────────┘

机器人物理系统：
├─ 移动底盘（差速轮）
├─ 升降机构（伺服电机）
├─ 六轴机械臂（法奥意威）
└─ 喷涂系统（喷枪+供料）
```

### 1.3 架构优势

| 优势 | 说明 | 效益 |
|------|------|------|
| **高可靠性** | 单点故障隔离，系统降级运行 | 提升系统可用性≥99% |
| **易维护性** | 节点独立，故障定位快速 | 减少维护时间50% |
| **可扩展性** | 即插即用的节点设计 | 支持功能快速迭代 |
| **开发效率** | 并行开发，降低耦合 | 缩短开发周期30% |
| **资源优化** | 分布式计算，负载均衡 | CPU占用<60% |

---

## 2. 分布式节点架构

### 2.1 节点分类和职责

#### 2.1.1 核心控制节点（P0优先级）

| 节点ID | 节点名称 | ROS节点名 | 单一职责 | 关键性 |
|--------|---------|-----------|---------|--------|
| NODE-01 | 底盘控制节点 | `chassis_node_01` | 差速轮电机控制+里程计 | ⭐⭐⭐⭐⭐ |
| NODE-02 | 升降机构节点 | `lift_node_01` | 伺服电机位置控制 | ⭐⭐⭐⭐⭐ |
| NODE-04 | 喷涂监控节点 | `spray_node_01` | 压力/流量/料位监测 | ⭐⭐⭐⭐⭐ |
| NODE-05 | 距离测量节点 | `range_node_01` | 四向墙面距离测量 | ⭐⭐⭐⭐ |
| NODE-07 | 电源管理节点 | `power_node_01` | 电池状态监测 | ⭐⭐⭐⭐⭐ |

#### 2.1.2 辅助监测节点（P1优先级）

| 节点ID | 节点名称 | ROS节点名 | 单一职责 | 关键性 |
|--------|---------|-----------|---------|--------|
| NODE-03 | 环境监测节点 | `environment_node_01` | 温湿度气压监测 | ⭐⭐⭐ |
| NODE-06 | IMU姿态节点 | `imu_node_01` | 姿态和加速度测量 | ⭐⭐⭐ |

#### 2.1.3 扩展节点（未来）

| 节点ID | 节点名称 | 单一职责 | 优先级 |
|--------|---------|---------|--------|
| NODE-08 | 激光雷达节点 | SLAM导航 | P2 |
| NODE-09 | 视觉识别节点 | 墙面缺陷检测 | P2 |
| NODE-10 | 安全防护节点 | 急停+围栏检测 | P1 |

### 2.2 节点间依赖关系

```
依赖层级（从下到上）：

Layer 4: 上位机决策层
         ┌─────────────────┐
         │   任务规划      │
         │   路径规划      │
         └────────┬────────┘
                  │
Layer 3: 核心控制层
         ┌────────┴────────┐
         │  NODE-01 底盘   │
         │  NODE-02 升降   │
         └────────┬────────┘
                  │
Layer 2: 执行监控层
         ┌────────┴────────┐
         │  NODE-04 喷涂   │
         │  NODE-05 距离   │
         └────────┬────────┘
                  │
Layer 1: 基础支撑层
         ┌────────┴────────┐
         │  NODE-03 环境   │
         │  NODE-06 IMU    │
         │  NODE-07 电源   │
         └─────────────────┘

特点：
- 上层依赖下层，但下层不依赖上层
- 同层节点相互独立，无依赖
- 故障影响范围：仅向上传播，不向下传播
```

### 2.3 节点生命周期管理

#### 启动顺序

```
1. NODE-07 (电源管理) → 检查电池状态
   ↓ (若电量>20%)
2. NODE-03, NODE-06 (环境/IMU) → 基础传感器初始化
   ↓
3. NODE-01, NODE-02 (底盘/升降) → 执行器初始化
   ↓
4. NODE-04, NODE-05 (喷涂/距离) → 作业传感器初始化
   ↓
5. 上位机连接 → 开始作业
```

#### 关闭顺序（反向）

```
1. 停止喷涂作业
2. NODE-04, NODE-05 → 保存数据
3. NODE-01, NODE-02 → 归零位
4. NODE-03, NODE-06 → 数据记录
5. NODE-07 → 电源管理（进入低功耗）
```

---

## 3. 硬件接口资源分配

### 3.1 Adafruit QT Py ESP32-C3接口概览

**可用GPIO资源**：
- **ADC通道**：GPIO0-4（5个，12位）
- **I2C主总线**：GPIO8(SDA), GPIO9(SCL)
- **通用GPIO**：GPIO7, GPIO10（2个）
- **OLED显示**：GPIO5(SCL), GPIO6(SDA)（板载，共享）
- **调试串口**：GPIO20(RX), GPIO21(TX)

**关键约束**：
1. ⚠️ GPIO5-6已被板载OLED占用
2. ⚠️ 仅5个ADC通道可用
3. ⚠️ 仅2个通用数字GPIO
4. ✅ I2C总线可连接多个设备（地址隔离或多路复用）

### 3.2 节点硬件接口分配

#### NODE-01: 底盘控制节点

```
┌─────────────────────────────────────────────┐
│ Adafruit QT Py ESP32-C3                     │
├─────────────────────────────────────────────┤
│ GPIO0  → PWM → 左电机驱动器                │
│ GPIO1  → PWM → 右电机驱动器                │
│ GPIO8-9 → I2C → DRV8833(读取编码器)        │
│ GPIO10 → GPIO → 紧急停止按钮               │
│ GPIO5-6 → OLED → 显示速度/里程             │
└─────────────────────────────────────────────┘

硬件清单：
- DRV8833双路电机驱动器 × 1
- 减速电机(带编码器) × 2
- 紧急停止按钮 × 1
```

#### NODE-02: 升降机构节点

```
┌─────────────────────────────────────────────┐
│ Adafruit QT Py ESP32-C3                     │
├─────────────────────────────────────────────┤
│ GPIO0  → PWM → 伺服电机                    │
│ GPIO8-9 → I2C → AS5600磁编码器             │
│ GPIO7  → GPIO → 上限位开关(上拉)           │
│ GPIO10 → GPIO → 下限位开关(上拉)           │
│ GPIO5-6 → OLED → 显示高度/状态             │
└─────────────────────────────────────────────┘

硬件清单：
- 伺服电机 × 1
- AS5600磁编码器 × 1
- 限位开关 × 2
```

#### NODE-03: 环境监测节点

```
┌─────────────────────────────────────────────┐
│ Adafruit QT Py ESP32-C3                     │
├─────────────────────────────────────────────┤
│ GPIO8-9 → I2C → BME280(温湿度气压)         │
│ GPIO5-6 → OLED → 显示温湿度                │
└─────────────────────────────────────────────┘

硬件清单：
- BME280传感器 × 1
```

#### NODE-04: 喷涂监控节点

```
┌─────────────────────────────────────────────┐
│ Adafruit QT Py ESP32-C3                     │
├─────────────────────────────────────────────┤
│ GPIO0  → ADC → 压力传感器(0-10bar)          │
│ GPIO1  → ADC → 流量传感器(0-5L/min)         │
│ GPIO2  → ADC → 料位传感器                   │
│ GPIO10 → GPIO → 流量脉冲计数(可选)          │
│ GPIO5-6 → OLED → 显示压力/流量/料位         │
└─────────────────────────────────────────────┘

硬件清单：
- 压力传感器(模拟输出) × 1
- 流量传感器(模拟输出) × 1
- 料位传感器(超声波/电容) × 1
```

#### NODE-05: 距离测量节点

```
┌─────────────────────────────────────────────┐
│ Adafruit QT Py ESP32-C3                     │
├─────────────────────────────────────────────┤
│ GPIO8-9 → I2C → TCA9548A多路复用器          │
│              ├─ VL53L0X (前)               │
│              ├─ VL53L0X (左)               │
│              ├─ VL53L0X (右)               │
│              └─ VL53L0X (后)               │
│ GPIO5-6 → OLED → 显示四向距离               │
└─────────────────────────────────────────────┘

硬件清单：
- TCA9548A I2C多路复用器 × 1
- VL53L0X激光测距传感器 × 4
```

#### NODE-06: IMU姿态节点

```
┌─────────────────────────────────────────────┐
│ Adafruit QT Py ESP32-C3                     │
├─────────────────────────────────────────────┤
│ GPIO8-9 → I2C → MPU6050/ICM20948           │
│ GPIO5-6 → OLED → 显示姿态角/倾斜警告        │
└─────────────────────────────────────────────┘

硬件清单：
- MPU6050 或 ICM20948 × 1
```

#### NODE-07: 电源管理节点

```
┌─────────────────────────────────────────────┐
│ Adafruit QT Py ESP32-C3                     │
├─────────────────────────────────────────────┤
│ GPIO0  → ADC → 电压分压采样                 │
│ GPIO1  → ADC → 霍尔电流传感器               │
│ GPIO4  → GPIO → 充电状态检测                │
│ GPIO8-9 → I2C → INA219(精确电压电流)        │
│ GPIO5-6 → OLED → 显示电量/续航时间          │
└─────────────────────────────────────────────┘

硬件清单：
- 电压分压电路 × 1
- 霍尔电流传感器 × 1
- INA219(可选，精确测量) × 1
```

### 3.3 接口资源优化策略

#### 策略1: I2C总线复用

```
优先使用I2C设备，节省GPIO资源：

单个I2C总线(GPIO8-9)可连接：
├─ BME280(0x76/0x77) - 环境传感器
├─ AS5600(0x36) - 磁编码器
├─ MPU6050(0x68/0x69) - IMU
├─ INA219(0x40-0x4F) - 电源监测
├─ VL53L0X(通过TCA9548A) - 多个测距传感器
└─ DRV8833(I2C版本) - 电机驱动配置

优势：
✅ 同一总线连接多设备
✅ 节省宝贵的GPIO
✅ 简化硬件布线
```

#### 策略2: ADC通道分时复用

```
NODE-04喷涂监控节点需要3个ADC：
- GPIO0: 压力传感器(高优先级，10Hz)
- GPIO1: 流量传感器(高优先级，10Hz)
- GPIO2: 料位传感器(低优先级，1Hz)

分时采样策略：
Time 0ms:  读取压力 + 流量
Time 50ms: 读取压力 + 流量
Time 100ms: 读取压力 + 流量 + 料位
...
```

#### 策略3: PWM复用ADC引脚

```
ADC引脚可输出PWM：
- GPIO0-4支持LEDC PWM输出
- 电机控制使用GPIO0-1
- PWM频率：1-20kHz可调
```

---

## 4. 通信架构设计

### 4.1 网络拓扑

```
                ┌──────────────────┐
                │  上位机工控机    │
                │  Ubuntu 22.04    │
                │  ROS 2 Humble    │
                └────────┬─────────┘
                         │
                         │ Ethernet
                         │
                ┌────────▼─────────┐
                │  WiFi路由器      │
                │  192.168.1.1     │
                │  2.4GHz/5GHz     │
                └────────┬─────────┘
                         │ WiFi (2.4GHz)
         ┌───────────────┼───────────────┐
         │               │               │
    ┌────▼────┐    ┌────▼────┐    ┌────▼────┐
    │ .101    │    │ .102    │    │ .103    │
    │ NODE-01 │    │ NODE-02 │    │ NODE-03 │
    └─────────┘    └─────────┘    └─────────┘
         │               │               │
    ┌────▼────┐    ┌────▼────┐    ┌────▼────┐
    │ .104    │    │ .105    │    │ .106    │
    │ NODE-04 │    │ NODE-05 │    │ NODE-06 │
    └─────────┘    └─────────┘    └─────────┘
         │
    ┌────▼────┐
    │ .107    │
    │ NODE-07 │
    └─────────┘

IP地址分配：
- 路由器: 192.168.1.1
- 上位机: 192.168.1.10
- 节点: 192.168.1.101-107 (静态IP)
```

### 4.2 ROS 2通信模型

#### 4.2.1 话题通信（Topic）

```
发布-订阅模式，用于高频数据流：

传感器数据流向：
NODE-xx → /xxx/data → 上位机

控制指令流向：
上位机 → /xxx/cmd_xxx → NODE-xx

特点：
✅ 异步通信
✅ 一对多/多对一
✅ 适合高频数据
❌ 不保证送达（BEST_EFFORT）
```

#### 4.2.2 服务通信（Service）

```
请求-响应模式，用于配置和控制：

客户端 → 请求 → 服务端
        ← 响应 ←

典型服务：
- /chassis/set_pid
- /lift/home
- /imu/calibrate

特点：
✅ 同步通信
✅ 一对一
✅ 保证响应
✅ 适合低频控制
```

#### 4.2.3 QoS策略

| 数据类型 | Reliability | History | Durability | 说明 |
|---------|-------------|---------|------------|------|
| 控制指令 | RELIABLE | KEEP_LAST(1) | VOLATILE | 必达但只需最新值 |
| 传感器数据 | RELIABLE | KEEP_LAST(10) | VOLATILE | 重要数据需可靠传输 |
| 高频非关键数据 | BEST_EFFORT | KEEP_LAST(5) | VOLATILE | 允许丢失，降低延迟 |
| 诊断信息 | RELIABLE | KEEP_LAST(10) | VOLATILE | 故障诊断需可靠 |

### 4.3 数据流设计

#### 4.3.1 传感器数据上行流

```
传感器采样 → 数据处理 → ROS消息封装 → 发布

NODE-01 (50Hz):
  编码器 → 里程计计算 → Odometry消息 → /chassis/odom

NODE-04 (10Hz):
  ADC采样 → 压力转换 → FluidPressure消息 → /spray/pressure

特点：
- 定时器触发采样
- 本地预处理（滤波、校准）
- 固定频率发布
- 时间戳同步
```

#### 4.3.2 控制指令下行流

```
上位机 → ROS话题 → 节点订阅 → 执行器控制

/chassis/cmd_vel → NODE-01 → 电机PWM输出

特点：
- 回调函数处理
- 参数合法性检查
- 闭环控制（PID）
- 响应时间<100ms
```

### 4.4 网络性能设计

#### 4.4.1 带宽需求估算

```
单节点数据量：
- 传感器数据: ~100 bytes @ 10-50Hz = 1-5 KB/s
- 诊断数据: ~500 bytes @ 1Hz = 0.5 KB/s
- 控制指令: ~50 bytes @ 10Hz = 0.5 KB/s

7节点总带宽：
- 上行: 7 × 5KB/s = 35 KB/s ≈ 280 kbps
- 下行: 7 × 0.5KB/s = 3.5 KB/s ≈ 28 kbps
- 总计: 308 kbps

WiFi 802.11n理论带宽：
- 2.4GHz: 150 Mbps (实际~50 Mbps)
- 带宽利用率: 308kbps / 50Mbps ≈ 0.6%

结论：✅ 带宽充足，余量充足
```

#### 4.4.2 延迟要求

| 通信类型 | 目标延迟 | 最大容忍 | 实现方法 |
|---------|---------|---------|---------|
| 控制指令 | <50ms | <100ms | RELIABLE QoS |
| 传感器数据 | <20ms | <50ms | BEST_EFFORT或RELIABLE |
| 服务调用 | <200ms | <500ms | 同步等待 |
| 诊断信息 | <1s | <2s | 低优先级 |

---

## 5. 系统性能设计

### 5.1 实时性设计

#### 5.1.1 FreeRTOS任务优先级

```
优先级层次（数字越大优先级越高）：

Priority 20: WiFi任务（ESP-IDF系统任务）
Priority 15: ROS通信任务
Priority 10: 控制闭环任务（PID）
Priority 5:  传感器采样任务
Priority 3:  诊断任务
Priority 1:  LVGL GUI任务

设计原则：
✅ 关键控制任务高优先级
✅ 避免优先级反转
✅ 合理分配时间片
```

#### 5.1.2 定时器设计

```c
// 高精度定时器用于采样和控制
esp_timer_handle_t sensor_timer;
esp_timer_create_args_t timer_args = {
    .callback = sensor_sampling_callback,
    .name = "sensor_timer"
};
esp_timer_create(&timer_args, &sensor_timer);

// 50Hz = 20ms周期
esp_timer_start_periodic(sensor_timer, 20000); // 微秒
```

### 5.2 资源占用设计

#### 5.2.1 内存预算

| 模块 | RAM预算 | Flash预算 | 说明 |
|------|--------|----------|------|
| ESP-IDF核心 | 50 KB | 400 KB | 系统内核 |
| WiFi协议栈 | 30 KB | 200 KB | 网络通信 |
| Micro-ROS | 40 KB | 300 KB | ROS客户端 |
| LVGL GUI | 20 KB | 100 KB | 图形界面 |
| 应用代码 | 30 KB | 200 KB | 业务逻辑 |
| **总计** | **170 KB** | **1.2 MB** | - |
| **硬件资源** | **400 KB** | **4 MB** | ESP32-C3 |
| **利用率** | **42%** | **30%** | 充足余量 |

#### 5.2.2 CPU占用设计

```
目标CPU占用分配：

空闲: 40%       (系统余量)
WiFi: 15%       (网络通信)
ROS:  15%       (消息处理)
控制: 10%       (PID闭环)
采样: 10%       (传感器读取)
GUI:  5%        (OLED刷新)
其他: 5%        (诊断、日志)

峰值负载场景：
- 正常运行: 50-60%
- 数据突发: 70-80%
- 异常处理: 80-90%
```

### 5.3 电源管理设计

#### 5.3.1 功耗模式

| 模式 | CPU频率 | WiFi状态 | 功耗 | 应用场景 |
|------|---------|---------|------|---------|
| 高性能 | 160 MHz | 活跃 | ~200mA | 正常作业 |
| 平衡 | 160 MHz | 省电 | ~150mA | 待机监控 |
| 低功耗 | 80 MHz | 省电 | ~100mA | 电量<20% |
| 休眠 | - | 断开 | <10mA | 充电中 |

#### 5.3.2 电源策略

```c
// 根据电池电量动态调整
if (battery_percentage > 50%) {
    // 高性能模式
    esp_pm_configure(&pm_config_high_perf);
    wifi_ps_type = WIFI_PS_NONE;
} else if (battery_percentage > 20%) {
    // 平衡模式
    esp_pm_configure(&pm_config_balanced);
    wifi_ps_type = WIFI_PS_MIN_MODEM;
} else {
    // 低功耗模式
    esp_pm_configure(&pm_config_low_power);
    wifi_ps_type = WIFI_PS_MAX_MODEM;
    // 降低采样频率
    reduce_sampling_rate();
}
```

---

## 6. 安全与可靠性设计

### 6.1 故障检测机制

#### 6.1.1 看门狗（Watchdog）

```c
// 任务看门狗
esp_task_wdt_init(5, true); // 5秒超时，自动重启
esp_task_wdt_add(main_task_handle);

// 定期喂狗
void main_loop() {
    while(1) {
        do_work();
        esp_task_wdt_reset(); // 喂狗
    }
}
```

#### 6.1.2 通信心跳

```c
// WiFi连接监控
if (wifi_disconnected_time > 10s) {
    wifi_reconnect();
}

// ROS Agent心跳
if (agent_heartbeat_timeout > 3s) {
    reconnect_to_agent();
}

// 节点间心跳（可选）
publish_heartbeat_every_1s();
```

### 6.2 故障恢复策略

| 故障类型 | 检测方式 | 恢复策略 | 超时 |
|---------|---------|---------|------|
| WiFi断开 | 连接状态 | 指数退避重连 | 无限重试 |
| Agent断开 | 心跳超时 | 立即重连 | 3秒 |
| 传感器失效 | 读取超时 | 重试3次→标记离线 | 100ms |
| 任务死锁 | 看门狗 | 自动重启 | 5秒 |
| 内存泄漏 | 堆监控 | 记录日志+重启 | 检测到时 |
| 低电量 | 电压监测 | 降级运行→返航 | 即时 |

### 6.3 安全保护机制

#### 6.3.1 机械安全

```c
// 限位保护
if (upper_limit_triggered || lower_limit_triggered) {
    stop_lift_motor();
    publish_alarm("Limit switch triggered");
}

// 倾斜保护
if (roll_angle > 5° || pitch_angle > 5°) {
    publish_warning("Tilt detected");
    if (angle > 10°) {
        emergency_stop_all();
    }
}

// 碰撞避免
if (front_distance < 0.1m) {
    stop_chassis();
    publish_alarm("Obstacle detected");
}
```

#### 6.3.2 网络安全

```c
// WiFi加密
wifi_config.sta.threshold.authmode = WIFI_AUTH_WPA2_PSK;

// 密码加密存储（NVS）
nvs_set_str_encrypted(nvs_handle, "wifi_pwd", password);

// 可选：Flash加密
CONFIG_SECURE_FLASH_ENCRYPTION_MODE_DEVELOPMENT=y
```

### 6.4 数据完整性

```c
// CRC校验
uint32_t crc = esp_crc32_le(0, data, len);

// 时间戳验证
if (msg.timestamp - now > 1000ms) {
    discard_outdated_message();
}

// 范围检查
if (pressure < 0 || pressure > MAX_PRESSURE) {
    flag_invalid_data();
}
```

---

## 7. 扩展性设计

### 7.1 节点扩展

#### 7.1.1 即插即用设计

```
新增节点步骤：

1. 硬件准备
   ├─ Adafruit QT Py ESP32-C3 × 1
   ├─ 传感器/执行器
   └─ 电源（5V或电池）

2. 软件配置
   ├─ 复制节点模板代码
   ├─ 修改节点名称和IP
   ├─ 实现传感器驱动
   └─ 定义ROS话题/服务

3. 网络配置
   ├─ 分配静态IP (192.168.1.xxx)
   ├─ 配置Domain ID (默认0)
   └─ 连接到WiFi网络

4. 集成测试
   ├─ 独立测试节点功能
   ├─ ROS话题/服务测试
   └─ 多节点联调

无需修改其他节点代码！
```

#### 7.1.2 扩展节点示例

**NODE-08: 激光雷达节点**

```
┌─────────────────────────────────────────────┐
│ Adafruit QT Py ESP32-C3                     │
├─────────────────────────────────────────────┤
│ GPIO20-21 → UART → RPLIDAR A1/A2           │
│ GPIO8-9 → I2C → (预留其他传感器)            │
│ GPIO5-6 → OLED → 显示雷达状态               │
└─────────────────────────────────────────────┘

ROS接口：
- 发布: /scan (sensor_msgs/LaserScan) @ 10Hz
- 服务: /lidar/start_scan, /lidar/stop_scan

应用：SLAM建图、导航、避障
```

### 7.2 功能扩展

#### 7.2.1 OTA升级

```c
// 通过WiFi进行固件升级
esp_https_ota_config_t ota_config = {
    .url = "https://server.com/firmware.bin",
    .cert_pem = server_cert,
};
esp_https_ota(&ota_config);

// 支持：
✅ 无线升级（无需USB）
✅ 回滚到旧版本
✅ 分区验证
```

#### 7.2.2 数据记录

```c
// SD卡数据记录（通过SPI）
mount_sdcard();
log_sensor_data_to_csv("/sdcard/log_2025_10_23.csv");

// Flash数据记录
nvs_set_blob(nvs_handle, "spray_log", data, sizeof(data));
```

### 7.3 多机器人系统

```
Domain ID隔离：

Robot-1: Domain ID = 0
├─ NODE-01 ~ NODE-07
└─ IP: 192.168.1.101-107

Robot-2: Domain ID = 1
├─ NODE-01 ~ NODE-07
└─ IP: 192.168.1.111-117

Robot-3: Domain ID = 2
├─ NODE-01 ~ NODE-07
└─ IP: 192.168.1.121-127

优势：
✅ 同一WiFi网络，互不干扰
✅ 上位机可监控多机器人
✅ 可扩展到100+机器人
```

---

## 附录

### A. 系统参数汇总

| 参数类别 | 参数 | 值 |
|---------|------|---|
| **硬件** | 节点数量 | 7个（可扩展） |
| | 单节点芯片 | ESP32-C3 RISC-V 160MHz |
| | 单节点RAM | 400 KB |
| | 单节点Flash | 4 MB |
| **网络** | WiFi标准 | 802.11 b/g/n (2.4GHz) |
| | Agent端口 | UDP 8888 |
| | IP范围 | 192.168.1.101-107 |
| **性能** | 控制延迟 | <100ms |
| | 传感器频率 | 10-50 Hz |
| | CPU占用 | <60% |
| | 带宽占用 | <1% (WiFi) |
| **可靠性** | 连续运行 | ≥72小时 |
| | 重连成功率 | ≥98% |
| | 节点可用性 | ≥99% |

### B. 关键决策记录

| 决策 | 原因 | 影响 |
|------|------|------|
| 采用分布式架构 | 故障隔离、易维护、并行开发 | 增加硬件成本，提升可靠性 |
| 选择ESP32-C3 | 低成本、WiFi集成、社区支持好 | 性能受限，适合中小型节点 |
| 使用Micro-ROS | ROS生态丰富、标准化接口 | 需要额外的Agent |
| I2C优先策略 | GPIO资源有限 | 限制设备响应速度 |
| 双缓冲LVGL | 减少OLED闪烁 | 增加内存占用 |

### C. 参考架构

- [ROS 2设计原则](https://design.ros2.org/)
- [ESP32-C3技术参考手册](https://www.espressif.com/sites/default/files/documentation/esp32-c3_technical_reference_manual_en.pdf)
- [Micro-ROS架构](https://micro.ros.org/docs/overview/features/)

---

**文档结束**

**审核人**：系统架构师  
**批准人**：技术负责人  
**版本**：v1.0.0  
**日期**：2025-10-23