# 建筑喷涂施工机器人版本管理规范

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档标题** | 版本管理规范文档 |
| **文档版本** | v1.0.0 |
| **编制日期** | 2025-10-23 |
| **版本控制系统** | Git |
| **代码托管平台** | GitHub/GitLab |
| **强制执行** | 是 |

---

## 目录

- [1. Git工作流](#1-git工作流)
- [2. 分支管理策略](#2-分支管理策略)
- [3. 提交消息规范](#3-提交消息规范)
- [4. 版本号管理](#4-版本号管理)
- [5. 发布流程](#5-发布流程)
- [6. 代码审查流程](#6-代码审查流程)
- [7. 标签管理](#7-标签管理)
- [8. 最佳实践](#8-最佳实践)

---

## 1. Git工作流

### 1.1 采用Git Flow工作流

```
主分支（长期）：
├── main          - 生产环境代码（仅发布版本）
├── develop       - 开发主线（集成分支）

辅助分支（临时）：
├── feature/*     - 功能开发分支
├── bugfix/*      - Bug修复分支
├── hotfix/*      - 紧急修复分支
└── release/*     - 发布准备分支
```

### 1.2 分支生命周期

```
开发新功能：
develop → feature/xxx → develop → release/vX.Y.Z → main

修复Bug：
develop → bugfix/xxx → develop

紧急修复：
main → hotfix/vX.Y.Z → main + develop
```

---

## 2. 分支管理策略

### 2.1 主分支（main）

**用途**：生产环境代码，仅包含稳定的发布版本

**保护规则**：
- ✅ 禁止直接推送（Protected Branch）
- ✅ 必须通过Pull Request合并
- ✅ 至少1人审查批准
- ✅ 必须通过CI测试
- ✅ 必须更新CHANGELOG

**合并来源**：
- `release/*` 分支（正常发布）
- `hotfix/*` 分支（紧急修复）

**标签规则**：
- 每次合并必须打标签：`v1.0.0`

### 2.2 开发分支（develop）

**用途**：开发主线，集成所有功能开发

**保护规则**：
- ✅ 禁止直接推送
- ✅ 必须通过Pull Request合并
- ✅ 至少1人审查批准
- ✅ 必须通过CI测试

**合并来源**：
- `feature/*` 分支（功能开发）
- `bugfix/*` 分支（Bug修复）
- `hotfix/*` 分支（同步紧急修复）

### 2.3 功能分支（feature/*）

**命名规范**：`feature/<功能描述>`

```bash
# 示例
feature/chassis-pid-control
feature/wifi-auto-reconnect
feature/oled-status-display
```

**创建和合并**：

```bash
# 从develop创建功能分支
git checkout develop
git pull origin develop
git checkout -b feature/chassis-pid-control

# 开发完成后合并回develop
git checkout develop
git pull origin develop
git merge --no-ff feature/chassis-pid-control
git push origin develop

# 删除功能分支
git branch -d feature/chassis-pid-control
git push origin --delete feature/chassis-pid-control
```

**约定**：
- 从`develop`分支创建
- 合并回`develop`分支
- 使用`--no-ff`（保留分支历史）
- 合并后删除

### 2.4 修复分支（bugfix/*）

**命名规范**：`bugfix/<问题描述>`

```bash
# 示例
bugfix/encoder-overflow
bugfix/wifi-reconnect-timeout
bugfix/memory-leak-in-ros-comm
```

**流程**：与`feature/*`相同

### 2.5 发布分支（release/*）

**命名规范**：`release/v<版本号>`

```bash
# 示例
release/v1.0.0
release/v1.1.0
```

**用途**：
- 准备发布版本
- 最后的Bug修复
- 更新版本号
- 更新CHANGELOG

**流程**：

```bash
# 1. 从develop创建发布分支
git checkout develop
git checkout -b release/v1.0.0

# 2. 更新版本号
# 修改 version.h: #define VERSION "1.0.0"

# 3. 更新CHANGELOG
# 添加新版本的变更记录

# 4. 提交版本更新
git commit -am "Bump version to 1.0.0"

# 5. 合并到main并打标签
git checkout main
git merge --no-ff release/v1.0.0
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin main --tags

# 6. 合并回develop
git checkout develop
git merge --no-ff release/v1.0.0
git push origin develop

# 7. 删除发布分支
git branch -d release/v1.0.0
```

### 2.6 热修复分支（hotfix/*）

**命名规范**：`hotfix/v<版本号>`

```bash
# 示例
hotfix/v1.0.1
hotfix/v1.1.1
```

**用途**：紧急修复生产环境Bug

**流程**：

```bash
# 1. 从main创建热修复分支
git checkout main
git checkout -b hotfix/v1.0.1

# 2. 修复Bug并测试

# 3. 更新版本号（patch版本+1）

# 4. 合并到main
git checkout main
git merge --no-ff hotfix/v1.0.1
git tag -a v1.0.1 -m "Hotfix 1.0.1: Fix critical bug"
git push origin main --tags

# 5. 合并到develop
git checkout develop
git merge --no-ff hotfix/v1.0.1
git push origin develop

# 6. 删除热修复分支
git branch -d hotfix/v1.0.1
```

---

## 3. 提交消息规范

### 3.1 提交消息格式（Conventional Commits）

```
<type>(<scope>): <subject>

<body>

<footer>
```

### 3.2 Type类型

| Type | 说明 | 示例 |
|------|------|------|
| **feat** | 新功能 | `feat(chassis): add PID speed control` |
| **fix** | Bug修复 | `fix(wifi): resolve reconnection timeout` |
| **docs** | 文档更新 | `docs(readme): update installation guide` |
| **style** | 代码格式 | `style(chassis): format code with clang-format` |
| **refactor** | 重构 | `refactor(ros): simplify publisher creation` |
| **perf** | 性能优化 | `perf(odom): optimize calculation algorithm` |
| **test** | 测试 | `test(chassis): add unit tests for PID` |
| **build** | 构建系统 | `build(pio): update platformio.ini` |
| **ci** | CI配置 | `ci(github): add automated testing` |
| **chore** | 其他 | `chore(deps): update esp-idf to v5.1.2` |

### 3.3 Scope范围

**节点级别**：
- `chassis` - 底盘控制节点
- `lift` - 升降机构节点
- `environment` - 环境监测节点
- `spray` - 喷涂监控节点
- `range` - 距离测量节点
- `imu` - IMU姿态节点
- `power` - 电源管理节点

**模块级别**：
- `wifi` - WiFi管理
- `ros` - ROS通信
- `config` - 配置管理
- `oled` - OLED显示

### 3.4 Subject主题

**规则**：
- 使用祈使句（"add" not "added"）
- 首字母小写
- 不超过50个字符
- 不以句号结尾

**示例**：
```
✅ feat(chassis): add PID speed control
❌ feat(chassis): Added PID speed control.
❌ feat(chassis): This commit adds PID speed control to chassis
```

### 3.5 Body正文（可选）

**用途**：详细说明修改内容和原因

```
fix(wifi): resolve connection timeout issue

The WiFi manager was not properly handling connection timeouts
when the network is temporarily unavailable. This commit adds
exponential backoff retry logic with a maximum of 5 attempts.

- Add retry counter
- Implement exponential backoff (1s, 2s, 4s, 8s, 16s)
- Emit event on max retries reached
```

### 3.6 Footer脚注（可选）

**Breaking Changes**：

```
feat(ros): change QoS default to RELIABLE

BREAKING CHANGE: Default QoS reliability changed from BEST_EFFORT
to RELIABLE. Update all publishers and subscribers accordingly.
```

**Issue引用**：

```
fix(chassis): resolve encoder overflow

Fixes #123
Closes #456
```

### 3.7 完整示例

```
feat(chassis): implement odometry calculation

Add odometry calculation based on differential wheel encoders.
The algorithm computes robot pose (x, y, theta) from encoder
increments using the kinematic model of differential drive.

Implementation details:
- Read encoder values at 50Hz
- Calculate wheel distances
- Update pose using forward kinematics
- Publish to /chassis/odom topic

Closes #42
```

---

## 4. 版本号管理

### 4.1 语义化版本（SemVer）

**格式**：`MAJOR.MINOR.PATCH`

```
v1.2.3
 │ │ │
 │ │ └─ PATCH: Bug修复（向后兼容）
 │ └─── MINOR: 新功能（向后兼容）
 └───── MAJOR: 重大变更（不向后兼容）
```

### 4.2 版本递增规则

| 变更类型 | 版本变化 | 示例 |
|---------|---------|------|
| 重大变更（不兼容） | MAJOR + 1 | 1.2.3 → 2.0.0 |
| 新功能（兼容） | MINOR + 1 | 1.2.3 → 1.3.0 |
| Bug修复 | PATCH + 1 | 1.2.3 → 1.2.4 |

### 4.3 预发布版本

```
v1.0.0-alpha.1    # Alpha测试版
v1.0.0-beta.1     # Beta测试版
v1.0.0-rc.1       # Release Candidate
v1.0.0            # 正式版
```

### 4.4 版本号在代码中

```c
// include/version.h
#ifndef VERSION_H
#define VERSION_H

#define VERSION_MAJOR 1
#define VERSION_MINOR 0
#define VERSION_PATCH 0
#define VERSION_STRING "1.0.0"

#define VERSION_BUILD_DATE __DATE__
#define VERSION_BUILD_TIME __TIME__

#endif /* VERSION_H */
```

---

## 5. 发布流程

### 5.1 发布检查清单

**发布前检查**：

- [ ] 所有功能已完成并合并到develop
- [ ] 所有测试通过（单元测试、集成测试）
- [ ] 代码覆盖率达标（≥80%）
- [ ] 静态分析无严重问题
- [ ] 文档已更新
- [ ] CHANGELOG已更新
- [ ] 版本号已更新
- [ ] 发布说明已准备

### 5.2 发布步骤

```bash
# 1. 创建发布分支
git checkout develop
git checkout -b release/v1.0.0

# 2. 更新版本号
# 修改 include/version.h
# 修改 platformio.ini (version字段)

# 3. 更新CHANGELOG
cat >> CHANGELOG.md << EOF
## [1.0.0] - 2025-10-23

### Added
- 底盘PID速度控制
- WiFi自动重连
- OLED状态显示

### Changed
- 优化里程计计算精度

### Fixed
- 修复编码器溢出问题
EOF

# 4. 提交版本更新
git add .
git commit -m "chore(release): bump version to 1.0.0"

# 5. 合并到main
git checkout main
git merge --no-ff release/v1.0.0
git tag -a v1.0.0 -m "Release 1.0.0"

# 6. 推送到远程
git push origin main
git push origin v1.0.0

# 7. 合并回develop
git checkout develop
git merge --no-ff release/v1.0.0
git push origin develop

# 8. 创建GitHub Release
# 在GitHub上基于v1.0.0标签创建Release
# 附加编译好的固件文件
```

### 5.3 发布说明模板

```markdown
# Release v1.0.0

## 🎉 新功能

- **底盘控制**: 实现PID速度闭环控制
- **WiFi管理**: 支持自动重连和指数退避
- **OLED显示**: 实时显示节点状态和IP地址

## 🔧 改进

- 优化里程计计算精度，误差从5%降至2%
- 减少内存占用，从150KB降至120KB

## 🐛 Bug修复

- 修复编码器计数溢出导致的里程计错误
- 修复WiFi长时间断开后无法重连的问题

## 📊 性能数据

- 控制循环延迟: 平均15ms（目标<20ms）✅
- ROS消息频率: 52Hz（目标≥50Hz）✅
- CPU占用率: 45%（目标<60%）✅
- 内存使用: 120KB（目标<150KB）✅

## 📦 下载

- [chassis_node_v1.0.0.bin](链接)
- [lift_node_v1.0.0.bin](链接)
- [完整固件包.zip](链接)

## 🔄 升级说明

从v0.9.x升级：
```bash
pio run -e chassis_node -t upload
```

## ⚠️ 重大变更

无

## 📝 完整变更日志

详见 [CHANGELOG.md](链接)
```

---

## 6. 代码审查流程

### 6.1 Pull Request流程

```
1. 开发人员创建PR
   ↓
2. CI自动检查（编译、测试、覆盖率）
   ↓
3. 指派审查人员（至少1人）
   ↓
4. 审查人员审查代码
   ↓
5. 讨论和修改
   ↓
6. 审查人员批准
   ↓
7. 合并到目标分支
   ↓
8. 删除源分支
```

### 6.2 PR标题规范

使用与commit message相同的格式：

```
feat(chassis): add PID speed control
fix(wifi): resolve connection timeout
docs(readme): update hardware connection guide
```

### 6.3 PR描述模板

```markdown
## 变更类型
- [ ] 新功能
- [ ] Bug修复
- [ ] 文档更新
- [ ] 代码重构
- [ ] 性能优化
- [ ] 测试
- [ ] 其他

## 变更说明
简要描述此PR的目的和实现方式

## 相关Issue
Closes #42

## 测试
描述如何测试此变更

- [ ] 单元测试已通过
- [ ] 集成测试已通过
- [ ] 硬件测试已通过

## 截图/日志
（如果适用）

## 检查清单
- [ ] 代码遵循编码规范
- [ ] 已添加/更新测试
- [ ] 已更新文档
- [ ] CI检查通过
- [ ] 代码已自我审查
```

### 6.4 审查意见

**使用GitHub Review功能**：

- ✅ **Approve**: 批准合并
- 💬 **Comment**: 仅评论，不阻止合并
- ❌ **Request changes**: 需要修改

**意见类型标记**：

```
🔴 必须修改 (blocking): 必须解决才能合并
🟡 建议 (non-blocking): 建议改进，不阻止合并
🔵 问题 (question): 需要澄清
💡 提示 (nit): 小问题（格式、拼写等）
```

---

## 7. 标签管理

### 7.1 标签命名

**版本标签**：`v<版本号>`

```bash
v1.0.0
v1.1.0
v2.0.0-beta.1
```

**里程碑标签**：`milestone/<名称>`

```bash
milestone/mvp
milestone/production-ready
```

### 7.2 创建标签

```bash
# 轻量标签（不推荐）
git tag v1.0.0

# 附注标签（推荐）
git tag -a v1.0.0 -m "Release version 1.0.0"

# 为历史提交打标签
git tag -a v1.0.0 9fceb02 -m "Release 1.0.0"

# 推送标签
git push origin v1.0.0

# 推送所有标签
git push origin --tags
```

### 7.3 删除标签

```bash
# 删除本地标签
git tag -d v1.0.0

# 删除远程标签
git push origin --delete v1.0.0
```

---

## 8. 最佳实践

### 8.1 提交频率

**原则**：小步快跑，频繁提交

```
✅ 每完成一个小功能就提交
✅ 修复一个Bug后立即提交
✅ 重构一个函数后提交

❌ 一天只提交一次
❌ 包含多个不相关的修改
```

### 8.2 提交粒度

**一个提交应该**：
- 只做一件事
- 能独立编译
- 能通过测试

```
✅ 好的提交：
   - feat(chassis): add PID controller
   - feat(chassis): add odometry calculation
   - test(chassis): add PID tests

❌ 不好的提交：
   - feat(chassis): implement everything
     (包含PID、里程计、测试、文档)
```

### 8.3 分支生命周期

```
feature分支：1-7天
  - 超过7天应考虑拆分

bugfix分支：几小时到1天
  - 尽快修复并合并

release分支：1-3天
  - 仅Bug修复和文档更新

hotfix分支：几小时
  - 紧急修复，越快越好
```

### 8.4 冲突解决

```bash
# 1. 保持分支更新
git checkout feature/my-feature
git fetch origin
git rebase origin/develop

# 2. 解决冲突
# 编辑冲突文件
git add .
git rebase --continue

# 3. 强制推送（仅自己的分支）
git push origin feature/my-feature --force-with-lease
```

### 8.5 历史清理

```bash
# 交互式rebase清理提交历史
git rebase -i HEAD~5

# 选项：
# pick   - 保留提交
# reword - 修改提交消息
# squash - 合并到上一个提交
# fixup  - 合并到上一个提交，丢弃消息
# drop   - 删除提交

# 示例：将多个WIP提交合并
pick abc123 feat(chassis): add PID
squash def456 WIP: fix bug
squash ghi789 WIP: another fix
```

### 8.6 .gitignore配置

```gitignore
# PlatformIO
.pio/
.vscode/.browse.c_cpp.db*
.vscode/c_cpp_properties.json
.vscode/launch.json

# ESP-IDF
build/
sdkconfig
sdkconfig.old
managed_components/

# 编译输出
*.o
*.a
*.elf
*.bin
*.map

# 测试和覆盖率
test_report/
coverage/
*.gcov
*.gcda
*.gcno

# IDE
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db

# 日志
*.log

# 临时文件
*.tmp
*.bak
```

---

## 附录

### A. Git配置

```bash
# 用户信息
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# 默认编辑器
git config --global core.editor "code --wait"

# 差异工具
git config --global diff.tool vscode
git config --global difftool.vscode.cmd "code --wait --diff $LOCAL $REMOTE"

# 合并工具
git config --global merge.tool vscode
git config --global mergetool.vscode.cmd "code --wait $MERGED"

# 别名
git config --global alias.co checkout
git config --global alias.br branch
git config --global alias.ci commit
git config --global alias.st status
git config --global alias.lg "log --graph --oneline --all --decorate"

# 自动换行
git config --global core.autocrlf input  # Linux/Mac
git config --global core.autocrlf true   # Windows
```

### B. 常用Git命令

```bash
# 查看状态
git status

# 查看差异
git diff
git diff --staged

# 查看日志
git log --oneline --graph --all
git log --author="John"
git log --since="2 weeks ago"

# 撤销修改
git checkout -- file.c      # 撤销工作区修改
git reset HEAD file.c       # 撤销暂存
git commit --amend          # 修改最后一次提交

# 分支操作
git branch                  # 列出分支
git branch -d feature/xxx   # 删除分支
git branch -D feature/xxx   # 强制删除

# 远程操作
git fetch origin            # 拉取远程更新
git pull origin develop     # 拉取并合并
git push origin feature/xxx # 推送分支

# Stash（临时保存）
git stash                   # 保存当前修改
git stash list              # 列出stash
git stash apply             # 应用stash
git stash drop              # 删除stash
```

### C. 紧急情况处理

**误删文件**：
```bash
git checkout HEAD -- deleted_file.c
```

**提交到错误分支**：
```bash
# 在正确分支
git cherry-pick <commit-hash>

# 在错误分支
git reset --hard HEAD~1
```

**推送了敏感信息**：
```bash
# 1. 从历史中删除
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch path/to/file" \
  --prune-empty --tag-name-filter cat -- --all

# 2. 强制推送
git push origin --force --all

# 3. 通知所有开发者重新克隆仓库
```

---

**文档结束**

**编写人**：版本管理专家  
**审核人**：技术负责人  
**版本**：v1.0.0  
**日期**：2025-10-23  
**强制执行日期**：2025-11-01